
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Rust Bug Minimization Patterns - The {pnk}f(eli)x Blog</title>
  <meta name="author" content="Felix S. Klock II">

  
  <meta name="description" content="&#8853;
Update 19 November 2019: fixed miscellaneous typos and a bug in the
invariance example pointed out by
readers both privately and on reddit &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="The {pnk}f(eli)x Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The {pnk}f(eli)x Blog</a></h1>
  
    <h2>The informal ramblings of an ex-pat PL enthusiast</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.pnkfx.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Rust Bug Minimization Patterns</h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-11-18T11:19:46+01:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
<em>Update 19 November 2019</em>: fixed miscellaneous typos and a <a href="https://www.reddit.com/r/rust/comments/dy6nk7/rust_bug_minimization_patterns/f804qsj/">bug</a> in the
<a href="#L..ADT-reduction.....in.general">invariance example</a> pointed out by
readers both privately and on <a href="https://www.reddit.com/r/rust/comments/dy6nk7/rust_bug_minimization_patterns/">reddit thread</a>.
I also added a <a href="#The.Rust.specifics">section</a> near the beginning
to draw attention to techniques
that are somewhat Rust-specific and may not be broadly known.
</span></p>

<p>Hey there again!</p>

<p>I have been pretty busy with Rust compiler tasks, so no there has not
been a blog post for a few months. But now, here we are!</p>

<p>While I was working some particularly nasty bugs recently, I put a
lot of effort into <em>bug minimization</em>: the process of taking a large
test case and finding ways to remove code from the test while
preserving the test&rsquo;s ability to expose the same bug.</p>

<p>As I worked, I realized that I was following a somewhat mechanical
process. I was using regular patterns for code transformation. At some
point, I said &ldquo;you know, I&rsquo;m not sure if everyone is aware of these
patterns. I only remember some of them while I am in the middle
of a bug minimization session.&rdquo;</p>

<p>Since the Rust compiler team always wants to help newcomers learn ways
they can contribute to the project, I realized this could be the ideal
subject for a blog post.</p>

<p>And, to try to keep things concrete, I&rsquo;m going to try to drive the
presentation by showing an actual bug being minimized. (Or rather, I&rsquo;m
going to recreate the minimization that I already did. So if it seems
like I am rather conveniently picking transformations that always seem
to work: You&rsquo;re right! I&rsquo;m cheating and not telling you about all the
false paths I went down during my first minimization odyssey on this bug.</p>

<a name="The.Rust.specifics"></a>
<h3>The Rust specifics</h3>

<p>Oh, and one other thing: A lot of the ideas here are applicable to
   many languages, and so its possible readers have already heard about them
   or discovered them independently.</p>

<p>However, a few of the techniques
leverage features that are not universal to languages outside of Rust.</p>

<p>Specifically:</p>

<ul>
<li><p><a href="#Technique:..Cfgments.">&ldquo;cfgmenting&rdquo;</a> makes use of Rust&rsquo;s attribute system to
remove items in a lightway fashion.</p></li>
<li><p><a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a> makes use of the fact that the Rust allows
the divergent expression <code>loop { }</code> to be assigned any type.</p></li>
<li><p><a href="#L..loopification.....via.pretty-printer">&ldquo;loopification&rdquo; via pretty-printer</a> leverages the compiler&rsquo;s
(unstable) ability to inject <code>loop { }</code> for all function bodies.</p></li>
<li><p><a href="#Bisecting.the.module.tree">Bisecting the module tree</a> makes use of Rust&rsquo;s support for
a mix of inline and out-of-line modules to allow one to quickly
swap code in and out.</p></li>
</ul>


<p>So, without further ado: here is the odyssey of my minimization of
<a href="https://github.com/rust-lang/rust/issues/65774">rust-lang/rust#65774</a></p>

<!-- rust-lang/rust#64872 -->


<p></p>

<a name="Philosophical.meandering"></a>
<h2>Philosophical meandering</h2>

<a name="What.does..minimal..mean.anyway."></a>
<h3>What does &ldquo;minimal&rdquo; mean anyway?</h3>

<p>The objective of a &ldquo;minimal&rdquo; test case could mean minimize lines of code; or the number of characters. It
is also good to minimize the number of source files: one file,
cut-and-pastable into <a href="https://play.rust-lang.org/">play.rust-lang.org</a>, is especially desirable.
<label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
One could even argue that the number of nodes in the abstract syntax tree
is a better metric to use than text-oriented metrics when minimizing.
</span></p>

<p>Minimizing the source test in this way can yield a good candidate
for a regression test to add to the compiler test suite when
the bug is (hopefully) eventually fixed.</p>

<p>But those syntactic metrics of minimality overlook something:
My own end goal when minimizing the code for a bug is a better
<em>understanding</em> of the bug: a better understanding for myself, and for other developers who are
reading the test case.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
I am writing this post from the viewpoint of a <code>rustc</code> developer. So I may have a slightly skewed view on what is useful or minimal.
</span>
And for such understanding, there are other metrics to keep in mind:</p>

<ul>
<li><p>Minimize the amount of time the compiler runs before it hits the bug.</p>

<p>Minimizing the compiler&rsquo;s execution time before failure
serves two purposes:</p>

<ol>
<li><p>It makes every future run of this test faster,
which can accelerate your pace of minimization.</p></li>
<li><p>When the <code>rustc</code> developers themselves examine the behavior
of the compiler on the test, they will be grateful to have
a shorter execution trace of the compiler to analyze.</p></li>
</ol>


<p>(Such time reduction often occurs anyway when you remove lines of code and/or dependencies;
 I just want to point out that it has value in its own right.)</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
As a concrete example of how reducing imports may help expose a bug&rsquo;s root cause:
some people will have a bug that occurs with
some combination of <code>#[derive(Debug)]</code> and a call to <code>format!</code> or
<code>write</code>, and the test showing the problem may be only a few lines
long. But it hides a lot of complexity behind those uses of
<code>derive</code>, macros, and <code>std::io</code> trait machinery; a longer test that
defines its <em>own</em> trait, a local <code>impl</code> of that trait, and a small
function illustrating the same bug, may make the bug more
immediately apparent to a <code>rustc</code> developer.
</span></p></li>
<li><p>Minimize dependencies: reduce the number of language features in
use and the number of imports your test uses from other crates
(<em>including</em> the <code>std</code> library!).</p>

<p>This can help expose the essential cause of the bug, potentially
making it immediately apparent what is occurring.</p></li>
<li><p>Minimize your jumping around in the source code.</p>

<p>If you can fit all the code needed to recreate the bug
onto your monitor screen at once,
by any means necessary,
that is a serious accomplishment. Less time spent scrolling through
a file or switching editor windows is more time you can spend thinking about
the bug itself.</p></li>
</ul>


<p>To be clear: Often a minimum amount of code needed for
understanding does correlate with a minimum amount of code needed
for <em>reproduction</em>. (This explains why using lines-of-code or the size of the syntax tree as a
metric can be useful when reporting a bug.)</p>

<p>The over-arching goal in minification is to remove all distractions:
to reduce the problematic input (in this case, Rust source code) to
its essence: a minimal amount necessary to <em>understand</em> the problem.</p>

<a name="Why.not.build.it.up.from.scratch."></a>
<h3>Why not build it up from scratch?</h3>

<p>Its worth pointing out that at some point, maybe even at the outset,
you may have a sufficiently rich understanding of the bug that you can
go straight to building up a minimal example from scratch. And that&rsquo;s
<em>great</em> , go for it!</p>

<p>However, this post is dedicated to the problem of what you can do when
you <em>haven&rsquo;t</em> hit that level of understanding. When you&rsquo;re looking at
a set of files that make up over 90,000 lines of code, you want a set
of semi-mechanical techniques to take that test input and strips it
down to its essence.</p>

<p>To be honest, the most effective methodology is going to use a blend
of build-up and tear-down. As you are tearing down the 90,000 lines of
code, there should be a voice in the back of your head asking &ldquo;can we
<em>now</em> try what we&rsquo;ve learned to try to build up a minimal example?&rdquo;</p>

<a name="Assumptions.and.Conventions"></a>
<h2>Assumptions and Conventions</h2>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
Some of the techniques may also be applicable to cases where the compiler is
<em>accepting</em> code that it should be rejecting; but I am little wary of advertising these tools
for use in that context, which is why you&rsquo;re reading this in the margin and not the main text.
</span>
The tests I am talking about minimizing in this post are cases where
the compiler itself fails in some way: an ICE, a link failure, or
rejecting code that it should be accepting. Bugs that are witnessed by actually running the
generated code are, for the most part, <em>not</em> covered by the patterns
here. In particular: many of the patterns presented here rely on
making semantic changes to the input: changing values, or replacing
complex expressions with something trivial like <code>loop { }</code>.</p>

<p>I named each transformation, usually
with absurd made-up words like <a href="#Tactic:..Unusedification.">&ldquo;unusedification&rdquo;</a>.
They are all in explicit quotation marks to try to
make it clear that I am speaking nonsense, deliberately.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
I had originally planned to structure this post so that
all transformations for a given theme would be present together, so that you&rsquo;d see
all the transformations for that theme at once. But as I wrote, it
became clear over the course of actually <em>doing</em>
a reduction, then we often bounce around between transformations, and
it usually does not end up being nicely grouped with all transformations for one theme colocated
in time.
So rather than using that hierarchical presentation, I am instead just
going to try to <em>mention</em> the grouping by marking each as
transformation being part of a &ldquo;theme&rdquo;.
</span>
Several of the transformations serve similar goals, like &ldquo;delete the
unnecessary&rdquo;. I have attempted to categorize the different tranformations
according
to what purpose they serve in the minimization process. Over the course
of documenting these transformations, I identified the following
<em>themes</em>:</p>

<ul>
<li>Simplify Workflow: Make your own life easier.

<ul>
<li>Enable Incremental Steps</li>
</ul>
</li>
<li>Delete the Unnecessary: Remove items not related to bug!</li>
<li>Identify the Unnecessary: Eliminate accidental necessity.</li>
<li>Trivialize Content: Turn complex expressions to trival ones.</li>
<li>Eliminate Coupling: Break links between items.</li>
</ul>


<a name="Notes.on.Notation"></a>
<h3>Notes on Notation</h3>

<p>In this post, I follow typical notation by using <code>...</code> as a placeholder for
(possibly relevant) code that will be kept approximately the same (modulo
mechanical updates like alpha-renaming) by a transformation.
However, I also use the non-standard notation of <code>----</code> for irrelevant code
that <em>removed</em> via a transformation. This is meant to draw attention to the
distinct kinds of code, so that you can more easily tell which code is being removed
by a particular transformation.</p>

<p>Sometimes I will show an explicit regexp that I am feeding to a tool
to do the transformation, but usually I will stick to informal patterns
with the aforementioned <code>...</code> and <code>----</code> placeholders.</p>

<p>When a given item or expression can appear within the context of a middle of a sequence
(e.g. consider <code>{ ... THING ... }</code>),
I often use the standard shorthand of just writing <code>{ THING ... }</code> or <code>{ ... THING }</code>,
to simplify the textual presentation and focus attention on the transformation itself.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Simplify Workflow
</span></p>

<a name="Record.your.steps"></a>
<h3>Record your steps</h3>

<p>Before you do any reduction, move the test case into its own local <code>git</code> repository
(or whatever versioning tool you prefer: SVN, RCS, etc).
Being back to backtrack through previous reduction steps
is an incredibly important option when doing this kind of
of work.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Simplify Workflow
</span></p>

<a name="Continuously.test.the.test."></a>
<h3>Continuously test the test.</h3>

<p>Finally: A crucial part of reduction is to <em>continuously</em> double-check
that the bug still reproduces after every reduction step. I&rsquo;ll show
the command line invocation on occasion, but not every command line
build invocation (the output is usually the same on every run, so it
would just clog up the flow of the presentation here). But even though
I don&rsquo;t show every invocation, you can believe that I was doing the
runs. (And in the cases where I tried to skip doing a run, I usually
regretted it and had to backtrace my steps to the state before an
attempted reduction.)</p>

<p>Make it easy to do your runs. Use your IDE. I use emacs, so I make a
<code>M-x compile</code> invocation that runs the compiler with the right
arguments, and hten you can hit <code>g</code> in the <code>*compilation*</code> buffer to
re-run the compile.</p>

<a name="The.test.case"></a>
<h2>The test case</h2>

<p>As I mentioned at the start: The presentation here will be
driven by referencing a <a href="https://github.com/pnkfelix/demo-minimization/tree/f979a3718a9c4350530b9e8c5beb09937799f67a">concrete test case</a>
that I reduced recently:
we have been given a crate graph, and we can observe a bug when we
build as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% <span class="o">(</span> <span class="nb">cd </span>tock/boards/arty-e21/ <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    <span class="nv">RUSTFLAGS</span><span class="o">=</span><span class="s2">&quot;-C link-arg=-Tlayout.ld&quot;</span> <span class="se">\</span>
</span><span class='line'>    cargo build --target riscv32imac-unknown-none-elf <span class="o">)</span>
</span><span class='line'>   Compiling tock-registers v0.4.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/libraries/tock-register-interface<span class="o">)</span>
</span><span class='line'>   Compiling tock-cells v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/libraries/tock-cells<span class="o">)</span>
</span><span class='line'>   Compiling tock_rt0 v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/libraries/tock-rt0<span class="o">)</span>
</span><span class='line'>   Compiling enum_primitive v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/libraries/enum_primitive<span class="o">)</span>
</span><span class='line'>   Compiling kernel v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/kernel<span class="o">)</span>
</span><span class='line'>   Compiling riscv-csr v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/libraries/riscv-csr<span class="o">)</span>
</span><span class='line'>   Compiling rv32i v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/arch/rv32i<span class="o">)</span>
</span><span class='line'>   Compiling capsules v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/capsules<span class="o">)</span>
</span><span class='line'>   Compiling sifive v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/chips/sifive<span class="o">)</span>
</span><span class='line'>   Compiling arty_e21 v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/chips/arty_e21<span class="o">)</span>
</span><span class='line'>   Compiling components v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/boards/components<span class="o">)</span>
</span><span class='line'>   Compiling arty-e21 v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/boards/arty-e21<span class="o">)</span>
</span><span class='line'>error: internal compiler error: src/librustc/traits/codegen/mod.rs:127: Encountered errors <span class="sb">`</span><span class="o">[</span>FulfillmentError<span class="o">(</span>Obligation<span class="o">(</span><span class="nv">predicate</span><span class="o">=</span>Binder<span class="o">(</span>TraitPredicate<span class="o">(</span>&lt;<span class="o">()</span> as core::fmt::Display&gt;<span class="o">))</span>, <span class="nv">depth</span><span class="o">=</span>1<span class="o">)</span>,Unimplemented<span class="o">)]</span><span class="sb">`</span> resolving bounds after <span class="nb">type</span>-checking
</span></code></pre></td></tr></table></div></figure>


<p>In reality the command line was a little more complicated:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% <span class="o">(</span> <span class="nb">cd </span>tock/boards/arty-e21/ <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    <span class="nv">RUSTFLAGS</span><span class="o">=</span><span class="s2">&quot;-C link-arg=-Tlayout.ld -C linker=rust-lld -C linker-flavor=ld.lld -C relocation-model=dynamic-no-pic -C link-arg=-zmax-page-size=512&quot;</span> <span class="se">\</span>
</span><span class='line'>    cargo build --target riscv32imac-unknown-none-elf   <span class="o">)</span>
</span><span class='line'>...
</span><span class='line'>error: internal compiler error: src/librustc/traits/codegen/mod.rs:127: Encountered errors <span class="sb">`</span><span class="o">[</span>FulfillmentError<span class="o">(</span>Obligation<span class="o">(</span><span class="nv">predicate</span><span class="o">=</span>Binder<span class="o">(</span>TraitPredicate<span class="o">(</span>&lt;<span class="o">()</span> as core::fmt::Display&gt;<span class="o">))</span>, <span class="nv">depth</span><span class="o">=</span>1<span class="o">)</span>,Unimplemented<span class="o">)]</span><span class="sb">`</span> resolving bounds after <span class="nb">type</span>-checking
</span></code></pre></td></tr></table></div></figure>


<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
An eagle-eyed reader might look at that ICE
message and immediately consider grepping the source
code, such as uses of the trait bound <code>core::fmt::Display</code>. A
fine idea, but intuitive jumping to an
answer is <em>not</em> what I&rsquo;m focusing on here.
</span></p>

<p>but for the purposes of the experiments presented in this blog post I
will use the simplified invocation. (The difference only matters once
we hit cases where the bug goes away.)</p>

<p>Remember that 90,000 lines of code number that I mentioned a
few paragraphs ago? It didn&rsquo;t come out of nowhere:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% find tock/ -name *.rs <span class="p">|</span> xargs wc
</span><span class='line'>...
</span><span class='line'>   <span class="m">91958</span>  <span class="m">317229</span> <span class="m">3150451</span> total
</span></code></pre></td></tr></table></div></figure>


<p>So this is an excellent example of an input that we really want to
reduce down to something smaller.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Simplify Workflow
</span></p>

<a name="Tactic:.Reduce.the.driving.code.first"></a>
<h2>Tactic: Reduce the driving code first</h2>

<p>We have many input files, and they make up a crate graph with at least
13 crates in it.</p>

<script src="/javascripts/viz.js" charset="utf-8"></script>




<!--
<div id="target_anchor1"></div>
<script>
    var dot_source = 'digraph {\
        rankdir="TB";\
        bgcolor="transparent"; \
        "boards/arty-e21" -> kernel;\
        "boards/arty-e21" -> "chips/arty_e21";\
        "chips/arty_e21" -> "chips/sifive";\
        "chips/arty_e21" -> kernel;\
        "chips/sifive" -> "arch/rv32i";\
        "arch/rv32i" -> kernel;\
        "arch/rv32i" -> "libraries/tock-r0";\
        "arch/rv32i" -> "libraries/tock-register-interface";\
        "arch/rv32i" -> "libraries/riscv-csr";\
        "libraries/riscv-csr" -> "libraries/tock-register-interface";\
        kernel -> "libraries/tock-register-interface";\
        kernel -> "libraries/tock-cells";\
    }';
    var elem = document.getElementById("target_anchor1");
    elem.innerHTML = Viz(dot_source, "svg");
</script>
-->


<p>We know from our command line invocation that it is the build of
<code>boards/arty-e21</code> that is exposing the ICE.
It would be good to remove unnecessary crates from the crate graph
for <code>boards/arty-e21</code>. But to do that most effectively, we need to
first discard as many imports as possible from  <code>boards/arty-e21</code>, and then
work our way backwards through the dependency chain.</p>

<p>So, will start by reducing the <code>boards/arty-e21</code> crate to the minimum
necessary to reproduce the bug.</p>

<p>This single crate is a much easier thing to work with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% find tock/boards/arty-e21/ -name <span class="s1">&#39;*.rs&#39;</span> <span class="p">|</span> xargs wc
</span><span class='line'>       <span class="m">4</span>       <span class="m">6</span>     <span class="m">124</span> tock/boards/arty-e21//build.rs
</span><span class='line'>      <span class="m">27</span>      <span class="m">68</span>     <span class="m">565</span> tock/boards/arty-e21//src/timer_test.rs
</span><span class='line'>      <span class="m">40</span>     <span class="m">101</span>     <span class="m">959</span> tock/boards/arty-e21//src/io.rs
</span><span class='line'>     <span class="m">279</span>     <span class="m">667</span>    <span class="m">9135</span> tock/boards/arty-e21//src/main.rs
</span><span class='line'>     <span class="m">350</span>     <span class="m">842</span>   <span class="m">10783</span> total
</span></code></pre></td></tr></table></div></figure>


<p>However, we <em>still</em> want to reduce it as much as we can: Every import
we can remove from <code>arty-e21</code> represents swaths of code that we
might be able to remove in the rest of the crate graph.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Simplify Workflow
</span></p>

<a name="Technique:..mod-inlining."></a>
<h2>Technique: &ldquo;mod-inlining&rdquo;</h2>

<p>This technique may surprise some: I like to reduce the number of files
involved early in the game, if I can. An easy way to do this is to
replace the out-of-line <code>mod foo;</code> item with its inline counterpart:
<code>mod foo { ... }</code>. Here the out-of-line module file content has been
cut-and-pasted into an inline <code>mod</code> item.</p>

<p>Strictly speaking, moving from <code>mod foo;</code> to <code>mod foo { ... }</code>does not
reduce the input: You still have all the same content that you started
with, the compiler has to do the same amount of work, et cetera.</p>

<p>Howver, I still prefer to do it, because I find that it helps with
later reduction steps if I can do my transformations on a single file.</p>

<p>There two techniques I use for <a href="#Technique:..mod-inlining.">&ldquo;mod-inlining&rdquo;</a>:</p>

<ol>
<li><p>Manually cut-and-paste:
take each instance of <code>mod foo;</code> in the root file, and find that
module&rsquo;s
contents. Then replace the <code>;</code> with <code>{</code> and <code>}</code>, and finally paste
the contents in between the curly brackets you just added. You
don&rsquo;t even have to re-indent<label for='not-python' class='margin-toggle'> &#8853;</label><input type='checkbox' id='not-python' class='margin-toggle'/><span class='marginnote'>Its not like this is Python! </span>
it if you don&rsquo;t want to.</p>

<p>For a small module tree, such as we find in <code>boards/arty-e21</code>,
manually cut-and-pasting is entirely reasonable. But if you have a
large module tree, with many directories and files, it can become
tedious and error-prone.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
Warning: this will not only expand the module tree: it will also
expand all the macro invocations, including <code>#[derive]</code> attributes.
This can be a bit overwhelming. (I am continually tempted to add a
new unstable <code>--pretty</code> variant that <em>just</em> expands the module tree
but does <em>not</em> expand the macros otherwise.)
</span></p></li>
<li><p>Alternative: use <code>rustc</code> to expand the module-tree.
You can add <code>--verbose</code> to the <code>cargo build</code> invocation to see the actual <code>rustc</code> command line invocation <code>cargo</code> is using, and then
you can add <code>-Z unstable-options --pretty=expanded</code> to that <code>rustc</code> invocation, piping the output
to a new rust source</p></li>
</ol>


<p>I will show a concrete example of using <code>rustc</code> in this way later in
the blog post. But for now I will just <a href="https://github.com/pnkfelix/demo-minimization/commit/600c31d2643ac0c44e03f345b390eed2a0210e2d">manually cut-and-paste</a> the
contents of <code>boards/arty-e21/src/timer_test.rs</code> and
<code>boards/arty-e21/src/io.rs</code> into <code>main.rs</code></p>

<p>After doing the inline, make sure the bug reproduces.</p>

<p>It is up to you whether you want to delete the out-of-line module files.
Today, Rust does not treat their presence as some sort of conflict with the
inline definition<label for='modfilelint' class='margin-toggle'> &#8853;</label><input type='checkbox' id='modfilelint' class='margin-toggle'/><span class='marginnote'>Checking for unused out-of-line module files might be a nice lint for someone to add to <code>rustc</code> </span>. You will see later in the post cases where keeping them around
on the file-system can be useful. But for the case of
<code>boards/arty-e21</code>, I will go ahead and delete them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% find tock/boards/arty-e21/ -name *.rs <span class="p">|</span> xargs wc
</span><span class='line'>       <span class="m">4</span>       <span class="m">6</span>     <span class="m">124</span> tock/boards/arty-e21//build.rs
</span><span class='line'>     <span class="m">348</span>     <span class="m">840</span>   <span class="m">10665</span> tock/boards/arty-e21//src/main.rs
</span><span class='line'>     <span class="m">352</span>     <span class="m">846</span>   <span class="m">10789</span> total
</span></code></pre></td></tr></table></div></figure>


<p>As expected, this didn&rsquo;t reduce the line count. But it <em>did</em> make it so
we can work with a single file at the leaf. That simplifies my own
workflow.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Delete the Unnecessary
</span></p>

<a name="Tactic:..Decommentification."></a>
<h2>Tactic: &ldquo;Decommentification&rdquo;</h2>

<p>This may be obvious, but it is a step that I often forget to do at the
outset of test reduction, even though it is easy and pays off
handsomely.</p>

<p>Comments in code are typically there to explain or justify some detail
of the implementation. When diagnosing compiler bugs, the purpose of
the original code is usually not relevant. You are better off
increasing the number of lines of actual code that you can
fit on your screen at once.</p>

<p>In short, the transformation looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="o">^</span>        <span class="c1">//...$</span>
</span></code></pre></td></tr></table></div></figure>


<p>to <code>&lt;empty-string&gt;</code></p>

<p>In this case, I have used <code>^</code> and <code>$</code> as markers for the beginning and end
of lines (just like in regexps).</p>

<p>Or, as an Emacs <code>M-x query-replace-regexp</code>
input: <code>^ *//.*^J*</code><label for='ctrl-j' class='margin-toggle'> &#8853;</label><input type='checkbox' id='ctrl-j' class='margin-toggle'/><span class='marginnote'>The <code>^J</code> there is a carriage-return inserted via <code>M-x quoted-insert</code> (aka <code>C-q</code>) in Emacs. </span>
(and empty string as replacement text).</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
Why I use <code>M-x query-replace-regexp</code>: it previews the matches, I verify a few by eye, and then hit <code>!</code> to do all the remaining replacements.
</span></p>

<p>Another related transformation: get rid of the other blank lines that
are not preceded by comments. I leave that regexp as an exercise for
the reader.</p>

<p>In the case of <code>boards/arty-e21</code>, this <a href="https://github.com/pnkfelix/demo-minimization/commit/fb6daad45a09e3cd44376e232698af4c76a01df7">got rid of 53 lines</a> of
comments (and blank lines succeeding them):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% wc tock/boards/arty-e21/src/main.rs
</span><span class='line'>     <span class="m">295</span>     <span class="m">575</span>    <span class="m">8551</span> tock/boards/arty-e21/src/main.rs
</span></code></pre></td></tr></table></div></figure>


<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Trivialize Content
</span></p>

<a name="Tactic:..Body.Loopification."></a>
<h2>Tactic: &ldquo;Body Loopification&rdquo;</h2>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
see also: <a href="#Technique:..None-defaulting.">&ldquo;none-defaulting&rdquo;</a>
</span>
<a href="#Tactic:..Body.Loopification.">&ldquo;Loopification&rdquo;</a> removes the body of a given function or method item,
replacing it with <code>loop { }</code>.</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
You might choose to use alternatives like <code>unimplemented!()</code>. I personally
like <code>loop { }</code> because its something you almost never see in other people&rsquo;s
code, so its easy to search for and be pretty certain that it was introduced as part
of reduction. Also <code>loop { }</code> relies on less machinery from the <code>core</code> library than
<code>unimplemented!</code> does.
</span>
The use of <code>loop { }</code> is deliberate: since <code>loop { }</code> is known by the
compiler to diverge, it can be assigned any type at all. So this
transformation can be performed blindly.</p>

<ul>
<li><p>Note that this does not work for <code>const fn</code>; the compiler currently
rejects <code>const fn foo() { loop { } }</code>  as invaild syntax.</p></li>
<li><p>Also, it generally will not work for <code>impl Trait</code> in return position: the compiler needs a
concrete type to assign to the <code>impl Trait</code>, and <code>loop { }</code> will not suffice for that
unless you ascribed it a non-<code>!</code> type in some manner.</p></li>
</ul>


<p>When it comes to replacing a function body with <code>loop { }</code>, you may be able to get help
from your IDE.
<label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
 More specifically, I have used Emacs to define a keyboard macro (via <code>C-x (</code>) that:
   1. searches for the next occurrence of <code>fn</code>,
   2. searches forward from there for the first <code>{</code>, which often (but <em>not always</em>) corresponds to the start of the function&rsquo;s body,
   3. runs <code>M-x kill-sexp</code> to delete the <code>{ ---- }</code> and
   4. types in <code>{ loop { } }</code>, replacing the method body.
This is incredibly satisfying to watch in action.
</span>
In my own case, I have often used Emacs <code>M-x kill-sexp</code> to delete the
<code>{ ---- }</code> block in <code>fn foo { ---- }</code></p>

<p>If you want to take a risk, you can ask <code>rustc</code> to do the replacement
of <code>fn</code> bodies with <code>loop { }</code> for you as part of pretty-printing via
the <code>-Z unpretty=everybody_loops</code> flag.
I&rsquo;ll <a href="#L..loopification.....via.pretty-printer">speak more on that later</a>.</p>

<p>Once the body has been removed, you can optionally replace all of the
formal parameters with <code>_</code>:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">a</span><span class="o">:</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="o">:</span> <span class="n">B</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">_</span><span class="o">:</span> <span class="n">A</span><span class="p">,</span> <span class="n">_</span><span class="o">:</span> <span class="n">B</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
These explicit marks can be useful as hints for future reduction steps; see <a href="#Technique:..Genertrification.">&ldquo;genertrification&rdquo;</a>)
</span>
This is essentially a special case of <a href="#Tactic:..Unusedification.">&ldquo;unusedification&rdquo;</a>; we do not
delete the parameters outright yet (see <a href="#Technique:..Param-elimination.">&ldquo;param-elimination&rdquo;</a> for that), but we
mark them as completely useless by writing them as <code>_: ParamType</code>.</p>

<p>In the case of <code>board/argy-e21/main.rs</code>, there was one <code>const fn</code>, and you cannot <a href="#Tactic:..Body.Loopification.">&ldquo;loopify&rdquo;</a> that.
For the other <code>fn</code>&rsquo;s, I <a href="https://github.com/pnkfelix/demo-minimization/commit/58118ddd3d806d0d2a8f66f5633a49eeb3615fc4">was able to</a> replace all but
the last <code>fn</code> body with <code>loop { }</code>. (Replacing the last one made the
bug go away.)</p>

<ul>
<li><p>In practice, the ICE diangostic often gives me some hint
about <em>which</em> <code>fn</code> is the problem, and therefore I can blindly
replace the other <code>fn</code> bodies with <code>loop { }</code>.</p></li>
<li><p>But even without such a hint, once can often <em>bisect</em> over the
set of <code>fn</code>&rsquo;s to try to identify a maximal subset that can
have their bodies replaced with <code>loop { }</code>. We will talk
more about <a href="#Reduction.via.Bisection">how to do such bisection later</a>.</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% wc tock/boards/arty-e21/src/main.rs
</span><span class='line'>     <span class="m">262</span>     <span class="m">523</span>    <span class="m">7584</span> tock/boards/arty-e21/src/main.rs
</span></code></pre></td></tr></table></div></figure>


<p>(Okay, only removing 33 lines of code might not be very impressive. The technique
will pay off more as we move further along.)</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Trivialize Content
</span></p>

<a name="Tactic:..Expr-elimination."></a>
<h2>Tactic: &ldquo;Expr-elimination&rdquo;</h2>

<p>Even if you were not able to replace a whole <code>fn</code> body with <code>loop { }</code>,
you can usually simplify the <code>fn</code> bodies that remain now.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
themes: Trivialize Content, Identify the Unnecessary
</span></p>

<a name="Technique:.Suffix-bisection"></a>
<h3>Technique: Suffix-bisection</h3>

<p>In this case, I recommend a form of bisection where you first
comment out
the bottom half of the original <code>fn</code>-body, and see if the problem reproduces.</p>

<ul>
<li><p>Why comment out the latter half? Well, if you comment out the top
half, you&rsquo;re almost certainly going to comment out <code>let</code>-bindings
that the bottom half relies on. The top half very rarely relies
on items in the bottom half.</p></li>
<li><p>If the <code>fn</code> in question has a return type, then you can usually use
a <code>loop { }</code> as a tail-expression at the end of the <code>fn</code>-body to
satisfy the return-type; a natural variant of <a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a>.</p></li>
</ul>


<p>If it does reproduce without the bottom half,
then you can delete that half, and recursively process
the top half.</p>

<p>If it <em>doesn&rsquo;t</em> reproduce,
then the bug relies on something in the bottom half. If you&rsquo;re
lucky, it <em>only</em> relies on stuff in the latter half, and you can try deleting the top half now.
But even if
you&rsquo;re <em>&ldquo;unlucky&rdquo;</em> and the bottom half relies on stuff in the top half,
you leave the top half in place (at least for now)
and recursively process the bottom half, narrowing the code until you can identify
a single statement whose presence or absence is the line between triggering the ICE or not.</p>

<p>If the <code>fn</code> is too large for fit on one screen, then I
use <code>M-x forward-sexp</code> to identify the start and end of the <code>fn</code>-body.
Then I jump to a line in the middle, and search around for the start
of a statment in the body, and then comment out everything
from that statement forward in <code>/* ... */</code></p>

<p>In the case of <code>boards/arty-e21/src/main.rs</code>, this meant
commenting out from line 191 through 263.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">    let gpio_pins = static_init!(</span>
</span><span class='line'><span class="cm">    ...</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    board_kernel.kernel_loop(&amp;artye21, chip, None, &amp;main_loop_cap);</span>
</span><span class='line'><span class="cm">*/</span>
</span></code></pre></td></tr></table></div></figure>


<p>And, &ldquo;darn&rdquo;: It didn&rsquo;t work. The bug disappeared.
But: This is okay! We still have learned something: Something in the
latter half is causing the bug. So bisect that latter half (again, favoring
commenting out second halves).</p>

<p>Eventually, by recursively processing the suffix statements,
we <a href="https://github.com/pnkfelix/demo-minimization/commit/cd73c2659e59ac8fa4a1b1ff01fdc3634972f271">identify</a> that the bug does not reproduce with this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">    kernel::procs::load_processes(</span>
</span><span class='line'><span class="cm">        board_kernel,</span>
</span><span class='line'><span class="cm">        chip,</span>
</span><span class='line'><span class="cm">        &amp;_sapps as *const u8,</span>
</span><span class='line'><span class="cm">        &amp;mut APP_MEMORY,</span>
</span><span class='line'><span class="cm">        &amp;mut PROCESSES,</span>
</span><span class='line'><span class="cm">        FAULT_RESPONSE,</span>
</span><span class='line'><span class="cm">        &amp;process_mgmt_cap,</span>
</span><span class='line'><span class="cm">    );</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    board_kernel.kernel_loop(&amp;artye21, chip, None, &amp;main_loop_cap);</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>but <em>does</em> reproduce with this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">kernel</span><span class="o">::</span><span class="n">procs</span><span class="o">::</span><span class="n">load_processes</span><span class="p">(</span>
</span><span class='line'>        <span class="n">board_kernel</span><span class="p">,</span>
</span><span class='line'>        <span class="n">chip</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="n">_sapps</span> <span class="k">as</span> <span class="o">*</span><span class="kr">const</span> <span class="kt">u8</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="k">mut</span> <span class="n">APP_MEMORY</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="k">mut</span> <span class="n">PROCESSES</span><span class="p">,</span>
</span><span class='line'>        <span class="n">FAULT_RESPONSE</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="n">process_mgmt_cap</span><span class="p">,</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">    board_kernel.kernel_loop(&amp;artye21, chip, None, &amp;main_loop_cap);</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, now we have identified a function call to <code>load_processes</code>
that seems to be intimately related to the bug.</p>

<p>Unfortunately, <code>load_processes</code> is an item defined in an external
crate. (We will deal with that eventually.)</p>

<p>Now that we&rsquo;ve identified this function call to <code>load_processes</code> as part of the
cause of the bug, the new goal is to simplify
the earlier part of the function to the bare minimum necessary
to support this function call.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
In all of these cases, if an otherwise unused
statement or expression influences the type-inference for the body, you may
need to keep it around, or some variant of it.
</span></p>

<ul>
<li><p>Get rid of all non-binding statements. (We should not need any
side-effecting computations to reproduce the bug.)</p></li>
<li><p>Initialize things to their default values (see <a href="#Tactic:..Defaultification.">&ldquo;Defaultification&rdquo;</a> below).</p></li>
<li><p>Eliminate unused <code>let</code>s (see <a href="#Tactic:..Unusedification.">&ldquo;Unusedification&rdquo;</a> below).</p></li>
</ul>


<p>After applying those steps repeatedly, and further <a href="#Tactic:..Decommentification.">&ldquo;decommentification&rdquo;</a>,
we are left with this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cp">#[no_mangle]</span>
</span><span class='line'><span class="k">pub</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">reset_handler</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">chip</span> <span class="o">=</span> <span class="n">static_init</span><span class="o">!</span><span class="p">(</span><span class="n">arty_e21</span><span class="o">::</span><span class="n">chip</span><span class="o">::</span><span class="n">ArtyExx</span><span class="p">,</span> <span class="n">arty_e21</span><span class="o">::</span><span class="n">chip</span><span class="o">::</span><span class="n">ArtyExx</span><span class="o">::</span><span class="n">new</span><span class="p">());</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">process_mgmt_cap</span> <span class="o">=</span> <span class="n">create_capability</span><span class="o">!</span><span class="p">(</span><span class="n">capabilities</span><span class="o">::</span><span class="n">ProcessManagementCapability</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">board_kernel</span> <span class="o">=</span> <span class="n">static_init</span><span class="o">!</span><span class="p">(</span><span class="n">kernel</span><span class="o">::</span><span class="n">Kernel</span><span class="p">,</span> <span class="n">kernel</span><span class="o">::</span><span class="n">Kernel</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PROCESSES</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kernel</span><span class="o">::</span><span class="n">procs</span><span class="o">::</span><span class="n">load_processes</span><span class="p">(</span>
</span><span class='line'>        <span class="n">board_kernel</span><span class="p">,</span>
</span><span class='line'>        <span class="n">chip</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="mi">0</span><span class="k">u8</span> <span class="k">as</span> <span class="o">*</span><span class="kr">const</span> <span class="kt">u8</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="mi">8192</span><span class="p">],</span> <span class="c1">// APP_MEMORY,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="k">mut</span> <span class="n">PROCESSES</span><span class="p">,</span>
</span><span class='line'>        <span class="n">kernel</span><span class="o">::</span><span class="n">procs</span><span class="o">::</span><span class="n">FaultResponse</span><span class="o">::</span><span class="n">Panic</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="n">process_mgmt_cap</span><span class="p">,</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just checking: the bug still reproduces, and we now have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% wc tock/boards/arty-e21/src/main.rs
</span><span class='line'>     <span class="m">111</span>     <span class="m">289</span>    <span class="m">2807</span> tock/boards/arty-e21/src/main.rs
</span></code></pre></td></tr></table></div></figure>


<p>Its not 100% minimized yet, but its about as far as we can go in
changes to <code>fn reset_handler</code> without making changes to crates
upstream in dependency graph.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Delete the Unnecessary
</span></p>

<a name="Tactic:..Unusedification."></a>
<h2>Tactic: &ldquo;Unusedification&rdquo;</h2>

<p>Another way to remove distractions: remove them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">non_pub_locally_unused_item</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to <code>&lt;empty-string&gt;</code></p>

<p>At this point, after our initial round of <a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a>, we should
have a <strong>lot</strong> of unused stuff: variables, struct fields, imports,
etc. And even better, the compiler is probably already telling you about
all of them!</p>

<p>In the specific case of <code>arty-e21</code>, I am currently seeing 25 warnings:
13 unused import warnings, 4 unused variable warnings,
2 static item is never used warnings, 1 constant item is never used warning,
and 5 field is never used warnings.</p>

<p>If you&rsquo;re doing the compilation runs in your IDE, then you should be
able to just jump to each unused item and remove it in some way.</p>

<ul>
<li>In the case of <code>fn</code> parameters, you can replace it with <code>_</code>
as previously discussed.</li>
<li>ADT contents (struct and enum fields) may require more subtlety;
see <a href="#Technique:..ADT-reduction.">&ldquo;ADT-reduction&rdquo;</a> below. For now, you can prefix their names with <code>_</code>.</li>
<li>Warning: Items with attributes like <code>#[no_mangle]</code> or <code>#[link_section]</code> may
also want special treatment: you may be able to remove them without
causing the bug to go away, but once the bug <em>does</em> go away,
their absence may cause a confusing linker error.</li>
</ul>


<p>Make sure to check periodically that the bug still reproduces
(Sometimes supposedly unused things still matter)!</p>

<p><a href="https://github.com/pnkfelix/demo-minimization/commit/72412f6ce7e1ba13fc1f71a7f08ad4eed47f4524">This</a> got <code>boards/arty-e21</code> down to 95 lines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="o">%</span> <span class="n">wc</span> <span class="n">tock</span><span class="o">/</span><span class="n">boards</span><span class="o">/</span><span class="n">arty</span><span class="o">-</span><span class="n">e21</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>
</span><span class='line'>      <span class="mi">95</span>     <span class="mi">254</span>    <span class="mi">2382</span> <span class="n">tock</span><span class="o">/</span><span class="n">boards</span><span class="o">/</span><span class="n">arty</span><span class="o">-</span><span class="n">e21</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, not so impressive yet. But as with optimizations, sometimes
the effect of these techniques only becomes apparent when they
are combined together.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Delete the Unnecessary
</span></p>

<a name="Technique:..Cfgments."></a>
<h2>Technique: &ldquo;Cfgments&rdquo;</h2>

<p>As a note: As a test run, you can easilly preview the effects of
<a href="#Tactic:..Unusedification.">&ldquo;unusedification&rdquo;</a> and <a href="#Tactic:..Demodulification.">&ldquo;demodulification&rdquo;</a> (discussed below)
transformations without actually deleting code. (After all, you may
quickly discover that you need to put it back.) One classic approach
for this is a comment block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">non_pub_locally_unused_item(----) { ---- }</span>
</span><span class='line'><span class="cm">*/</span>
</span></code></pre></td></tr></table></div></figure>


<p>But it not always easy to toggle such comments on and off, since you
need add and remove the <code>/*</code> and matching <code>*/</code> each time you want to
toggle it. Some IDEs help with this, but I still prefer to use more
local changed if I can.</p>

<p>A less used option that is more specific to Rust (and that I use <em>all
the time</em>), is to use a <code>#[cfg]</code> attribute to temporarily remove the code:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">unused_or_little_used_item</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cp">#[cfg(not_now)]</span>
</span><span class='line'><span class="n">unused_or_little_used_item</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
No, I do not know how to pronounce &ldquo;cfgment&rdquo;; I have only typed it, never uttered it.
<em>Iä! Sheol-Nugganoth!</em>
</span>
I call this <a href="#Technique:..Cfgments.">&ldquo;cfgmenting&rdquo;</a> out code (as opposed to &ldquo;<em>commenting</em> out code&rdquo;).</p>

<p>Whether or not you choose to use comments, <a href="#Technique:..Cfgments.">&ldquo;cfgments&rdquo;</a>, or just delete
code outright is up to you, (though I do recommend you <em>eventually</em>
delete the lines in question, as discussed in <a href="#Tactic:..Decommentification.">&ldquo;decommentification&rdquo;</a>).</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Delete the Unnecessary
</span></p>

<a name="Tactic:..Demodulification."></a>
<h2>Tactic: &ldquo;Demodulification&rdquo;</h2>

<p>In addition to <a href="#Tactic:..Unusedification.">&ldquo;unusedifying&rdquo;</a> each identified unused item, you might
try this: You may <em>also</em> be lucky enough to be able to just remove
whole modules from this crate at this point. If the compiler is telling
you that a lot of the items in a given module are unused, maybe you
can get rid of the whole module. Go ahead and try it!</p>

<p>There can be a bit of guesswork involved here. For various reasons the
compiler&rsquo;s lints do not identify some definitions as unused even
though it may seem obvious that they are not used.</p>

<ul>
<li><p>This can be a consequence of the <code>impl</code>s in the source; see <a href="#Tactic:..Deimplificiation.">&ldquo;Deimplification&rdquo;</a> below.</p></li>
<li><p>Also some cases are only identified after doing
<a href="#Tactic:..Depublification.">&ldquo;depublification&rdquo;</a> of the contents of such modules, which is also discussed below.</p></li>
</ul>


<p>In the case of <code>boards/arty-e21</code> I was able to identify <code>mod timer_test</code>
as entirely unsed.</p>

<p>After <a href="#Technique:..Cfgments.">&ldquo;cfgmenting&rdquo;</a> it <a href="https://github.com/pnkfelix/demo-minimization/commit/564145229124075a23eb8967a80ce9d65ac0aa2a">out</a> and further  <a href="#Tactic:..Decommentification.">&ldquo;decommentification&rdquo;</a>, we have this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% wc tock/boards/arty-e21/src/main.rs
</span><span class='line'>      <span class="m">73</span>     <span class="m">191</span>    <span class="m">1967</span> tock/boards/arty-e21/src/main.rs
</span></code></pre></td></tr></table></div></figure>


<p>(For now we have to keep the <code>mod io { ... }</code>; it defines a panic-handler, and we won&rsquo;t
be able to get rid of that until we do more reduction elsewhere.)</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Delete the Unnecessary
</span></p>

<a name="Technique:..ADT-reduction."></a>
<h2>Technique: &ldquo;ADT-reduction&rdquo;</h2>

<p>What more is there to reduce here? Well, there is a <code>struct ArtyE21</code> all of whose fields are unused:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">ArtyE21</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">_console</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">capsules</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">Console</span><span class="o">&lt;</span><span class="k">&#39;static</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">_gpio</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">capsules</span><span class="o">::</span><span class="n">gpio</span><span class="o">::</span><span class="n">GPIO</span><span class="o">&lt;</span><span class="k">&#39;static</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">_alarm</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">capsules</span><span class="o">::</span><span class="n">alarm</span><span class="o">::</span><span class="n">AlarmDriver</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="k">&#39;static</span><span class="p">,</span>
</span><span class='line'>        <span class="n">VirtualMuxAlarm</span><span class="o">&lt;</span><span class="k">&#39;static</span><span class="p">,</span> <span class="n">rv32i</span><span class="o">::</span><span class="n">machine_timer</span><span class="o">::</span><span class="n">MachineTimer</span><span class="o">&lt;</span><span class="k">&#39;static</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">_led</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">capsules</span><span class="o">::</span><span class="n">led</span><span class="o">::</span><span class="n">LED</span><span class="o">&lt;</span><span class="k">&#39;static</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">_button</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">capsules</span><span class="o">::</span><span class="n">button</span><span class="o">::</span><span class="n">Button</span><span class="o">&lt;</span><span class="k">&#39;static</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We got lucky here: This <code>struct</code> has no lifetime or type parameters, so we can just
do a trivial replacement, like so:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span> <span class="p">{</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/pnkfelix/demo-minimization/commit/a41a1c17ea77a4e67ec86b8bda593f9d65e51946">This</a>, combined with <a href="#Tactic:..Unusedification.">&ldquo;unusedification&rdquo;</a> of a now-unused import, leaves us with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% wc tock/boards/arty-e21/src/main.rs
</span><span class='line'>      <span class="m">63</span>     <span class="m">170</span>    <span class="m">1549</span> tock/boards/arty-e21/src/main.rs
</span></code></pre></td></tr></table></div></figure>


<a name="L..ADT-reduction.....in.general"></a>
<h3><a href="#Technique:..ADT-reduction.">&ldquo;ADT-reduction&rdquo;</a> in general</h3>

<p>In the general case, if there is a generic parameter on the struct,
you will need it to retain a field (to allow the compiler to compute
the variance of the parameter).</p>

<p>Usually lifetime parameters are (co)variant, in which case this suffices:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">{</span> <span class="n">_inner</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="p">()</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
<code>struct S&lt;'a&gt;(Cell&lt;&amp;'a ())</code>
is another option for encoding invariance,
note it imports <code>std::cell::Cell</code>.
</span>
If you need an <em>invariant</em> lifetime parameter to reproduce the bug, then you
can do it this way:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">{</span> <span class="n">_inner</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="k">mut</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="p">()</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Likewise, type parameters can usually be encoded like so:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span> <span class="n">_inner</span><span class="o">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the type parameter has the <code>?Sized</code> (anti)bound, then you can use
this variant:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="n">T</span><span class="o">:</span> <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span> <span class="n">_inner</span><span class="o">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Box</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Often if there is both a lifetime and a type parameter, then I will combine them into one field:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span> <span class="n">_inner</span><span class="o">:</span> <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">&#39;a</span> <span class="n">T</span><span class="o">&gt;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>but in general that might not reflect the
contents<label for='outlives-inference' class='margin-toggle'> &#8853;</label><input type='checkbox' id='outlives-inference' class='margin-toggle'/><span class='marginnote'>for example, it implicitly requires that <code>T</code> outlive <code>'a</code>, which may not have been the case originaly </span>
of the original struct, and thus may cause the
original bug to be masked. So in general you may have to do:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">S</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span> <span class="n">_inner1</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="p">(),</span> <span class="n">_inner2</span><span class="o">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>or some variation thereof.</p>

<p>Having said that, its pretty rare that <code>struct S&lt;'a, T&gt; { _inner: Option&lt;&amp;'a T&gt; }</code> doesn&rsquo;t suffice.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
themes: Delete the Unnecessary, Identify the Unnecessary
</span></p>

<a name="Tactic:..Deimplificiation."></a>
<h2>Tactic: &ldquo;Deimplificiation&rdquo;</h2>

<p>After <a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a>, often whole <code>impl</code> blocks can be eliminated.</p>

<p>In the case of <code>arty-e21</code>, we have this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">Write</span> <span class="k">for</span> <span class="nb">Writer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">write_str</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">fmt</span><span class="o">::</span><span class="nb">Result</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>which is entirely unused.</p>

<p>So we can <a href="#Technique:..Cfgments.">&ldquo;cfgment&rdquo;</a> it out, and now the compiler identifies two unused
imports (since this <code>impl</code>-block was their only use); more
importantly, it now also identifies that the <code>struct Writer</code> is never
constructed. (Which we already knew since we were able to revise its
fields at will during <a href="#Technique:..ADT-reduction.">&ldquo;ADT-reduction&rdquo;</a>; but the point is that we
couldn&rsquo;t have removed its definition without first removing all of its
associated <code>impl</code> blocks. Thus, <a href="#Tactic:..Deimplificiation.">&ldquo;deimplification&rdquo;</a> is an important
step in our reduction odysssey.</p>

<p><a href="https://github.com/pnkfelix/demo-minimization/commit/c11012b6729b6f4a197a9f6e08a08797a2ecdd90">That</a>, plus more <a href="#Tactic:..Unusedification.">&ldquo;unusedification&rdquo;</a> gets us to 55 lines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% wc tock/boards/arty-e21/src/main.rs
</span><span class='line'>      <span class="m">55</span>     <span class="m">146</span>    <span class="m">1396</span> tock/boards/arty-e21/src/main.rs
</span></code></pre></td></tr></table></div></figure>


<a name="Fine-grained...deimplification...."></a>
<h3>Fine-grained <a href="#Tactic:..Deimplificiation.">&ldquo;deimplification&rdquo;</a></h3>

<p>In general you may not be able to remove the whole <code>impl</code> block.
But you can still try to remove individual items from it, like so:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">fn</span> <span class="n">method</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span><span class='line'>   <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>   <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Technique:..split-impls."></a>
<h4>Technique: &ldquo;split-impls&rdquo;</h4>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
aka Regroup <code>fn</code> items in inherent <code>impl</code>s.
</span>
I sometimes like to employ
As a special technique to remove individual methods from an inherent <code>impl</code>: Rust lets you define
<em>multiple</em> inherent impls for a given type. So rather than deleting code
or using <a href="#Technique:..Cfgments.">&ldquo;cfgments&rdquo;</a> for each item, I will instead take an impl and
break it into two, where one of them is <a href="#Technique:..Cfgments.">&ldquo;cfgmented&rdquo;</a> out:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method1</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method2</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method3</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cp">#[cfg(not_now)]</span>
</span><span class='line'><span class="k">impl</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method1</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">impl</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method2</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method3</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, you can now move items freely between the <a href="#Technique:..Cfgments.">&ldquo;cfgmented&rdquo;</a>-out <code>impl</code>
and the still present <code>impl</code>. It has a similar effect to <a href="#Technique:..Cfgments.">&ldquo;cfgmenting&rdquo;</a>
out the individual items, but in practice it feels a lot more like an
easy bisection process, at least for my fingers.</p>

<ul>
<li>Especially since you can start with the whole <code>impl</code> <a href="#Technique:..Cfgments.">&ldquo;cfgmented&rdquo;</a>-out,
and let the compiler tell you which methods you need to put back (e.g.
due to downstream uses.)</li>
</ul>


<p>You can also sometimes do this <code>impl</code> as a way to make more fine-grained
<code>impl</code>-blocks that have looser constraints, like so:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">X</span><span class="o">:</span> <span class="n">Bound</span><span class="o">&gt;</span> <span class="n">Foo</span><span class="o">&lt;</span><span class="n">X</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method1</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method2</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method3</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">X</span><span class="o">:</span> <span class="n">Bound</span><span class="o">&gt;</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method1</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">X</span><span class="o">&gt;</span> <span class="n">Foo</span><span class="o">&lt;</span><span class="n">X</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method2</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">method3</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>(where here we assume <code>method2</code> and <code>method3</code> do not require the <code>X: Bound</code>).</p>

<a name="A.pause"></a>
<h1>A pause</h1>

<p>This is about as far as we can usefully get in reducing <code>arty-e21</code> on its own.</p>

<p>To make further progress, we need to start making changes to upstream
dependencies.</p>

<p>Lets look at the situation there.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Identify the Unnecessary
</span></p>

<a name="Tactic:..dep-reduction."></a>
<h2>Tactic: &ldquo;dep-reduction&rdquo;</h2>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
aka &ldquo;eliminate upstream dependencies&rdquo;
</span>
We have not yet changed anything about the crate graph as a whole.
Technicaly, building <code>arty-e21</code> still builds 12 crates before starting
on <code>arty-e21</code>. (Maybe <code>cargo</code> has some flag to inform you about unused
dependencies?)</p>

<p>In any case, from inspecting <code>arty-e21</code>, we can see that it directly
uses only two dependencies now: <code>kernel</code> and <code>chips/arty_e21</code>.</p>

<p>We can <a href="https://github.com/pnkfelix/demo-minimization/commit/71b8fd41c5f9b8b5802e6e580c53f678a46bb8db">remove other dependencies</a> from the <code>Cargo.toml</code> and see where
it gets us:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='toml'><span class='line'><span class="p">[</span><span class="n">dependencies</span><span class="p">]</span>
</span><span class='line'><span class="n">kernel</span> <span class="o">=</span> <span class="p">{</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;../../kernel&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="n">arty_e21</span> <span class="o">=</span> <span class="p">{</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;../../chips/arty_e21&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A build after a <code>cargo clean</code> now shows just nine crates being built before
<code>arty-e21</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>   Compiling tock-registers v0.4.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/libraries/tock-register-interface<span class="o">)</span>
</span><span class='line'>   Compiling tock-cells v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/libraries/tock-cells<span class="o">)</span>
</span><span class='line'>   Compiling tock_rt0 v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/libraries/tock-rt0<span class="o">)</span>
</span><span class='line'>   Compiling arty-e21 v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/boards/arty-e21<span class="o">)</span>
</span><span class='line'>   Compiling riscv-csr v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/libraries/riscv-csr<span class="o">)</span>
</span><span class='line'>   Compiling kernel v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/kernel<span class="o">)</span>
</span><span class='line'>   Compiling rv32i v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/arch/rv32i<span class="o">)</span>
</span><span class='line'>   Compiling sifive v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/chips/sifive<span class="o">)</span>
</span><span class='line'>   Compiling arty_e21 v0.1.0 <span class="o">(</span>/Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/chips/arty_e21<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we want to make more progress here, we&rsquo;ll need to start working on upstream crates.</p>

<p>Looking at <code>chips/arty_e21/Cargo.toml</code>, we can see it <em>also</em> depends on the <code>kernel</code> crate:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='toml'><span class='line'><span class="p">[</span><span class="n">dependencies</span><span class="p">]</span>
</span><span class='line'><span class="n">sifive</span> <span class="o">=</span> <span class="p">{</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;../sifive&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="n">rv32i</span> <span class="o">=</span> <span class="p">{</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;../../arch/rv32i&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="n">kernel</span> <span class="o">=</span> <span class="p">{</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;../../kernel&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So this gives us a hint where to go next: Simplify <code>chips/arty_e21</code> as much as we can,
before we tackle trying to simplify the (hopefully root) <code>kernel</code> crate.</p>

<p>So lets see what we need from <code>chips/arty_e21</code>. It has a very small <code>lib.rs</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="c-Doc">//! Drivers and chip support for the E21 soft core.</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span><span class="o">!</span><span class="p">[</span><span class="n">feature</span><span class="p">(</span><span class="n">asm</span><span class="p">,</span> <span class="n">concat_idents</span><span class="p">,</span> <span class="n">const_fn</span><span class="p">)]</span>
</span><span class='line'><span class="err">#</span><span class="o">!</span><span class="p">[</span><span class="n">feature</span><span class="p">(</span><span class="n">exclusive_range_pattern</span><span class="p">)]</span>
</span><span class='line'><span class="err">#</span><span class="o">!</span><span class="p">[</span><span class="n">no_std</span><span class="p">]</span>
</span><span class='line'><span class="err">#</span><span class="o">!</span><span class="p">[</span><span class="n">crate_name</span> <span class="o">=</span> <span class="s">&quot;arty_e21&quot;</span><span class="p">]</span>
</span><span class='line'><span class="err">#</span><span class="o">!</span><span class="p">[</span><span class="n">crate_type</span> <span class="o">=</span> <span class="s">&quot;rlib&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="kn">mod</span> <span class="n">interrupts</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="kn">mod</span> <span class="n">chip</span><span class="p">;</span>
</span><span class='line'><span class="k">pub</span> <span class="kn">mod</span> <span class="n">gpio</span><span class="p">;</span>
</span><span class='line'><span class="k">pub</span> <span class="kn">mod</span> <span class="n">uart</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I have a choice: do I go ahead and inline these module defintions
like we did with <code>boards/arty-e21</code>? Well, lets figure out if we can
first isolate its exports to a bare minimum before doing that.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Identify the Unnecessary
</span></p>

<a name="Tactic:..Depublification."></a>
<h2>Tactic: &ldquo;Depublification&rdquo;</h2>

<p>As I already mentioned, the compiler is probably already tellling you
about some of these (see <a href="#Tactic:..Unusedification.">&ldquo;unusedification&rdquo;</a>).</p>

<p>But if you want to maximize the set of unused things that the compiler
will identify for you, you might need to help it along the way by
removing <code>pub</code> annotations, like so:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="kn">mod</span> <span class="n">foo</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kn">mod</span> <span class="n">foo</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>or</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="kn">use</span> <span class="n">foo</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kn">use</span> <span class="n">foo</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>or <code>struct</code>, <code>enum</code>, <code>type</code>, <code>trait</code>, <code>fn</code>, etc; basically any <code>pub</code> item.</p>

<p>This can help compiler see that items or imports are in fact not used
outside of the current crate, and thus can be eliminated.</p>

<p>For <code>chips/arty_e21</code>, I was able to successfully do <a href="https://github.com/pnkfelix/demo-minimization/commit/e0a22e4d07731f4f41a81606588ff3a9ad1d019a">this replacement</a>:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="kn">mod</span> <span class="n">chip</span><span class="p">;</span>
</span><span class='line'><span class="k">pub</span> <span class="kn">mod</span> <span class="n">gpio</span><span class="p">;</span>
</span><span class='line'><span class="k">pub</span> <span class="kn">mod</span> <span class="n">uart</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="kn">mod</span> <span class="n">chip</span><span class="p">;</span>
</span><span class='line'><span class="kn">mod</span> <span class="n">gpio</span><span class="p">;</span>
</span><span class='line'><span class="kn">mod</span> <span class="n">uart</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>and everything still built.</p>

<p>After this point, I attempted blind <a href="#Tactic:..Demodulification.">&ldquo;demodulification&rdquo;</a>
each of <code>mod interrupts</code>, <code>mod gpio</code>, and <code>mod uart</code>
(since its so easy to try when they are declared as out-of-line modules). Unfortunately,
<code>pub mod chip;</code> currently depends on all of them being present.</p>

<p>So that&rsquo;s when I went ahead and <a href="https://github.com/pnkfelix/demo-minimization/commit/76a8d5f8289ad4b974e2aebad219e424ac283b59">inlined</a> the module definitions, leaving me with a 371-line <code>lib.rs</code>
for <code>chips/arty_e21</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% wc tock/chips/arty_e21/src/lib.rs
</span><span class='line'>     <span class="m">371</span>    <span class="m">1354</span>   <span class="m">12137</span> tock/chips/arty_e21/src/lib.rs
</span></code></pre></td></tr></table></div></figure>


<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
Maybe this argues
for a strategy where one should attempt targetted <a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a> on
your reachable (<code>pub</code>) modules in the crate, and then do subsequent
<a href="#Tactic:..Demodulification.">&ldquo;demodulification&rdquo;</a> of the out-of-line modules before jumping into
<a href="#Technique:..mod-inlining.">&ldquo;mod-inlining&rdquo;</a>. I have not tried that workflow too seriously yet,
though; its not that hard to <a href="#Tactic:..Demodulification.">&ldquo;demodulify&rdquo;</a> a module, since its just a matter
of <a href="#Technique:..Cfgments.">&ldquo;cfgmenting&rdquo;</a> out the <code>mod</code> declaration.
</span>
Then I <a href="#Tactic:..Body.Loopification.">&ldquo;loopified&rdquo;</a> it; in this case, I was lucky and was able to <a href="https://github.com/pnkfelix/demo-minimization/commit/9381c62b9ade2d82709a86ff57ef64c7acb312d7">loopify <em>everything</em></a>
in <code>chips/arty_e21</code>, and the bug still reproduces.</p>

<p>After <a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a>, I was able to successfully <a href="#Tactic:..Demodulification.">&ldquo;demodulify&rdquo;</a> <em>all</em>
of <a href="https://github.com/pnkfelix/demo-minimization/commit/1187a5bd7dbf6e7e2734ccb7787592d2778aa1f1"><code>mod interrupts</code>, <code>mod gpio</code>, and <code>mod uart</code></a>.</p>

<p>Finally, I did some <a href="#Tactic:..Deimplificiation.">&ldquo;deimplification&rdquo;</a>, and managed to remove everything
except for a <code>impl kernel::Chip for ArtyExx { ... }</code> and
one inherent method on <code>struct ArtyExx</code>.</p>

<p>Those steps, plus <a href="#Tactic:..Decommentification.">&ldquo;decommentification&rdquo;</a>, removed about 320 lines.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% wc tock/chips/arty_e21/src/lib.rs
</span><span class='line'>      <span class="m">52</span>     <span class="m">163</span>    <span class="m">1180</span> tock/chips/arty_e21/src/lib.rs
</span></code></pre></td></tr></table></div></figure>


<p>Perhaps most importantly, it got the source code to the point where
it fits on a screen.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
themes: Enable Incremental Steps, Identify the Unnecessary
</span></p>

<a name="Tactic:..simpl-impl."></a>
<h3>Tactic: &ldquo;simpl-impl&rdquo;</h3>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
aka use trait defaults
</span>
I did just mention that I had to keep an <code>impl kernel::Chip for ArtyExx { ... }</code>.</p>

<p>In general, the <code>impl</code> blocks we are trying to eliminate may be trait
impls rather than inherent ones. In those cases,
we cannot just remove methods from the <code>impl</code>s willy-nilly, as that
would cause the compiler to reject the trait implementation.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
Did you see this coming?
</span>
So, you have to keep that <code>impl</code> entirely intact&hellip;
unless you do some work up front &hellip;</p>

<p>Here&rsquo;s the trick around that.
First add a trait default implementation:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">trait</span> <span class="n">Tr</span> <span class="p">{</span> <span class="p">...</span> <span class="k">fn</span> <span class="n">m</span><span class="p">();</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">trait</span> <span class="n">Tr</span> <span class="p">{</span> <span class="p">...</span> <span class="k">fn</span> <span class="n">m</span><span class="p">()</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This enables the subsequent transformation:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">Tr</span> <span class="k">for</span> <span class="n">C</span> <span class="p">{</span> <span class="p">...</span> <span class="k">fn</span> <span class="n">m</span><span class="p">()</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">Tr</span> <span class="k">for</span> <span class="n">C</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thats right, you can turn a non-default trait method into a <a href="#Tactic:..Body.Loopification.">&ldquo;loopified&rdquo;</a>
default trait method, and that enables you to freely remove instances of that
method from all of that trait&rsquo;s <code>impl</code>s.
You can do this transformation piecewise, or for
the whole trait definition, as you like.</p>

<p>And (I think) you can do it
pretty much as freely as you like: you should not need to worry about
changing a trait method to a <a href="#Tactic:..Body.Loopification.">&ldquo;loopified&rdquo;</a> default causing breakage
elsewhere when compiling the crate graph (unless there is some
potential interaction with specialization that I have not conidered).</p>

<p>If you apply the transformation repeatedly, it can often result in</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">trait</span> <span class="n">Tr</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span> <span class="c1">// all methods loopified</span>
</span><span class='line'><span class="k">impl</span> <span class="n">Tr</span> <span class="k">for</span> <span class="n">C</span> <span class="p">{</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>which is simply awesome.</p>

<p>In our specific case, the trait in question is upstream: <code>impl kernel::Chip for ArtyExx { ... }</code></p>

<p>So we are going to make an
exception to our earler rule about trying to work at the leaves first: Here, we are
justified in jumping upstream, to <code>kernel/src/platform/mod.rs</code>,
and changing the definition of <code>kernel::Chip</code>, doing <code>M-x query-replace</code> of <code>;</code> with <code>{ loop { } }</code> to easily jump through the <code>fn</code>-items and add
a <a href="#Tactic:..Body.Loopification.">&ldquo;loopified&rdquo;</a> body to each one.</p>

<p>(In my case, I&rsquo;m going to decommentify the relevant file first too.)</p>

<p>After adding <a href="#Tactic:..Body.Loopification.">&ldquo;loopified&rdquo;</a> default methods <a href="https://github.com/pnkfelix/demo-minimization/commit/c62a7b05755321ec7e6876d34d8aae7fb90d68df">to the traits in <code>kernel::platform</code></a>, we can return
to <code>chips/arty_e21</code> and <a href="https://github.com/pnkfelix/demo-minimization/commit/02d13aef0478443858d4a7bb13238858f183b4d7">further simplify</a> the <code>impl</code> there to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">kernel</span><span class="o">::</span><span class="n">Chip</span> <span class="k">for</span> <span class="n">ArtyExx</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">MPU</span> <span class="o">=</span> <span class="p">();</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">UserspaceKernelBoundary</span> <span class="o">=</span> <span class="n">rv32i</span><span class="o">::</span><span class="n">syscall</span><span class="o">::</span><span class="n">SysCall</span><span class="p">;</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">SysTick</span> <span class="o">=</span> <span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to apply a bit of artistry.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Trivialize Content
</span></p>

<a name="Tactic:..Type-trivialization."></a>
<h2>Tactic: &ldquo;Type-trivialization&rdquo;</h2>

<p>This associated type in <code>impl kernel::Chip for ArtyExx</code> is forcing dependency on <code>rv32i</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">type</span> <span class="n">UserspaceKernelBoundary</span> <span class="o">=</span> <span class="n">rv32i</span><span class="o">::</span><span class="n">syscall</span><span class="o">::</span><span class="n">SysCall</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>But we have removed all the methods! Chances are actually quite good that
there is no longer anyone that relies on that type defintion.
(Its not a <em>certainty</em>, of course; clients of the trait might be extracting the type directly,
and the associated may have trait bounds that will force us to use a non-trivial type there.)</p>

<p>But lets try it and see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">kernel</span><span class="o">::</span><span class="n">Chip</span> <span class="k">for</span> <span class="n">ArtyExx</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">MPU</span> <span class="o">=</span> <span class="p">();</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">UserspaceKernelBoundary</span> <span class="o">=</span> <span class="p">();</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">SysTick</span> <span class="o">=</span> <span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>yields:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">error</span><span class="p">[</span><span class="n">E0277</span><span class="p">]</span><span class="o">:</span> <span class="n">the</span> <span class="k">trait</span> <span class="n">bound</span> <span class="err">`</span><span class="p">()</span><span class="o">:</span> <span class="n">kernel</span><span class="o">::</span><span class="n">syscall</span><span class="o">::</span><span class="n">UserspaceKernelBoundary</span><span class="err">`</span> <span class="n">is</span> <span class="n">not</span> <span class="n">satisfied</span>
</span><span class='line'>  <span class="o">--&gt;</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">felixklock</span><span class="o">/</span><span class="n">Dev</span><span class="o">/</span><span class="n">Mozilla</span><span class="o">/</span><span class="n">issue65774</span><span class="o">/</span><span class="n">demo</span><span class="o">-</span><span class="n">minimization</span><span class="o">/</span><span class="n">tock</span><span class="o">/</span><span class="n">chips</span><span class="o">/</span><span class="n">arty_e21</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span><span class="mi">6</span>
</span><span class='line'>   <span class="o">|</span>
</span><span class='line'><span class="mi">22</span> <span class="o">|</span> <span class="k">impl</span> <span class="n">kernel</span><span class="o">::</span><span class="n">Chip</span> <span class="k">for</span> <span class="n">ArtyExx</span> <span class="p">{</span>
</span><span class='line'>   <span class="o">|</span>      <span class="o">^^^^^^^^^^^^</span> <span class="n">the</span> <span class="k">trait</span> <span class="err">`</span><span class="n">kernel</span><span class="o">::</span><span class="n">syscall</span><span class="o">::</span><span class="n">UserspaceKernelBoundary</span><span class="err">`</span> <span class="n">is</span> <span class="n">not</span> <span class="n">implemented</span> <span class="k">for</span> <span class="err">`</span><span class="p">()</span><span class="err">`</span>
</span><span class='line'>
</span><span class='line'><span class="n">error</span><span class="o">:</span> <span class="n">aborting</span> <span class="n">due</span> <span class="n">to</span> <span class="n">previous</span> <span class="n">error</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, what to do about this?</p>

<p>Honestly, I figure this is another case where we are justified in going upstream and removing
the bound in question, just to see what happens:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/tock/kernel/src/platform/mod.rs b/tock/kernel/src/platform/mod.rs</span>
</span><span class='line'><span class="gh">index 9544899..dd107dd 100644</span>
</span><span class='line'><span class="gd">--- a/tock/kernel/src/platform/mod.rs</span>
</span><span class='line'><span class="gi">+++ b/tock/kernel/src/platform/mod.rs</span>
</span><span class='line'><span class="gu">@@ -13,7 +13,7 @@ pub trait Platform {</span>
</span><span class='line'> pub trait Chip {
</span><span class='line'>     type MPU: mpu::MPU;
</span><span class='line'>
</span><span class='line'><span class="gd">-    type UserspaceKernelBoundary: syscall::UserspaceKernelBoundary;</span>
</span><span class='line'><span class="gi">+    type UserspaceKernelBoundary;</span>
</span><span class='line'>
</span><span class='line'>     type SysTick: systick::SysTick;
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>And the answer is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'>error[E0277]: the trait bound `&lt;C as platform::Chip&gt;::UserspaceKernelBoundary: syscall::UserspaceKernelBoundary` is not satisfied
</span><span class='line'>   --&gt; /Users/felixklock/Dev/Mozilla/issue65774/demo-minimization/tock/kernel/src/process.rs:468:5
</span><span class='line'>    |
</span><span class='line'>468 | /     stored_state:
</span><span class='line'>469 | |         Cell&lt;&lt;&lt;C as Chip&gt;::UserspaceKernelBoundary as UserspaceKernelBoundary&gt;::StoredState&gt;,
</span><span class='line'>    | |____________________________________________________________________________________________^ the trait `syscall::UserspaceKernelBoundary` is not implemented for `&lt;C as platform::Chip&gt;::UserspaceKernelBoundary`
</span><span class='line'>    |
</span><span class='line'>    = help: consider adding a `where &lt;C as platform::Chip&gt;::UserspaceKernelBoundary: syscall::UserspaceKernelBoundary` bound
</span><span class='line'>
</span><span class='line'>error: aborting due to previous error
</span></code></pre></td></tr></table></div></figure>


<p>Darn.
(We could take the compilers advice and add the aforementioned <code>where</code> clause, but that stands a good chance of just shifting the blame around without actually helping us make progress on reduction itself.)</p>

<p>You might think: &ldquo;Lets try removing that field from the <code>struct</code>&rdquo;; but
note that the <code>struct Process</code> lives in the <code>kernel</code> crate, and that
code has not yet been <a href="#Tactic:..Body.Loopification.">&ldquo;loopified.&rdquo;</a> So there&rsquo;s a good chance that
there&rsquo;s existing code that relies on that field being there, and we
have to get rid of that code first.</p>

<p>Well, we did a good job getting <code>chips/arty_e21</code> as small as we did.
Let us take this as a sign that we should keep moving up, to now focus
on reducing the <code>kernel</code> crate.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Simplify Workflow
</span></p>

<a name="Technique:...mod-inlining.....and...loopification.....via.pretty-printer"></a>
<h2>Technique: <a href="#Technique:..mod-inlining.">&ldquo;mod-inlining&rdquo;</a> and <a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a> via pretty-printer</h2>

<p>I want to simplify the kernel crate.</p>

<p>However, its module hierarchy is a bit larger than the other two crates we&rsquo;ve looked at so far:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% find tock/kernel -name <span class="s1">&#39;*.rs&#39;</span>
</span><span class='line'>tock/kernel/src/tbfheader.rs
</span><span class='line'>tock/kernel/src/ipc.rs
</span><span class='line'>tock/kernel/src/memop.rs
</span><span class='line'>tock/kernel/src/lib.rs
</span><span class='line'>tock/kernel/src/platform/mod.rs
</span><span class='line'>tock/kernel/src/platform/systick.rs
</span><span class='line'>tock/kernel/src/platform/mpu.rs
</span><span class='line'>tock/kernel/src/callback.rs
</span><span class='line'>tock/kernel/src/common/static_ref.rs
</span><span class='line'>tock/kernel/src/common/list.rs
</span><span class='line'>tock/kernel/src/common/peripherals.rs
</span><span class='line'>tock/kernel/src/common/queue.rs
</span><span class='line'>tock/kernel/src/common/ring_buffer.rs
</span><span class='line'>tock/kernel/src/common/dynamic_deferred_call.rs
</span><span class='line'>tock/kernel/src/common/mod.rs
</span><span class='line'>tock/kernel/src/common/math.rs
</span><span class='line'>tock/kernel/src/common/deferred_call.rs
</span><span class='line'>tock/kernel/src/common/utils.rs
</span><span class='line'>tock/kernel/src/hil/symmetric_encryption.rs
</span><span class='line'>tock/kernel/src/hil/dac.rs
</span><span class='line'>tock/kernel/src/hil/rng.rs
</span><span class='line'>tock/kernel/src/hil/i2c.rs
</span><span class='line'>tock/kernel/src/hil/pwm.rs
</span><span class='line'>tock/kernel/src/hil/sensors.rs
</span><span class='line'>tock/kernel/src/hil/watchdog.rs
</span><span class='line'>tock/kernel/src/hil/led.rs
</span><span class='line'>tock/kernel/src/hil/time.rs
</span><span class='line'>tock/kernel/src/hil/crc.rs
</span><span class='line'>tock/kernel/src/hil/ninedof.rs
</span><span class='line'>tock/kernel/src/hil/entropy.rs
</span><span class='line'>tock/kernel/src/hil/spi.rs
</span><span class='line'>tock/kernel/src/hil/nonvolatile_storage.rs
</span><span class='line'>tock/kernel/src/hil/mod.rs
</span><span class='line'>tock/kernel/src/hil/usb.rs
</span><span class='line'>tock/kernel/src/hil/adc.rs
</span><span class='line'>tock/kernel/src/hil/gpio_async.rs
</span><span class='line'>tock/kernel/src/hil/analog_comparator.rs
</span><span class='line'>tock/kernel/src/hil/gpio.rs
</span><span class='line'>tock/kernel/src/hil/radio.rs
</span><span class='line'>tock/kernel/src/hil/eic.rs
</span><span class='line'>tock/kernel/src/hil/flash.rs
</span><span class='line'>tock/kernel/src/hil/uart.rs
</span><span class='line'>tock/kernel/src/hil/ble_advertising.rs
</span><span class='line'>tock/kernel/src/driver.rs
</span><span class='line'>tock/kernel/src/component.rs
</span><span class='line'>tock/kernel/src/sched.rs
</span><span class='line'>tock/kernel/src/introspection.rs
</span><span class='line'>tock/kernel/src/debug.rs
</span><span class='line'>tock/kernel/src/process.rs
</span><span class='line'>tock/kernel/src/syscall.rs
</span><span class='line'>tock/kernel/src/returncode.rs
</span><span class='line'>tock/kernel/src/grant.rs
</span><span class='line'>tock/kernel/src/capabilities.rs
</span><span class='line'>tock/kernel/src/mem.rs
</span></code></pre></td></tr></table></div></figure>


<p>I don&rsquo;t want to manually-inline all those modules into <code>kernel</code>.</p>

<p>I&rsquo;m also not too eager to manually <a href="#Tactic:..Body.Loopification.">&ldquo;loopify&rdquo;</a> it (though that would be
easier if the <a href="#Technique:..mod-inlining.">&ldquo;mod-inlining&rdquo;</a> were done).</p>

<p>Luckily, we can leverage the compiler here.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Simplify Workflow
</span></p>

<a name="L..mod-inlining.....via.pretty-printer"></a>
<h3><a href="#Technique:..mod-inlining.">&ldquo;mod-inlining&rdquo;</a> via pretty-printer</h3>

<p>As mentioned earlier, we can add <code>-Z unstable-options --pretty=expanded</code> to the relevant <code>rustc</code> invocation
(in ths case, the one compiling <code>kernel/src/lib.rs</code>)
to get the content of the crate as one module tree.</p>

<ul>
<li>(Unfortunately for our immediate purposes, the macros in it are also
 expanded. But since macros could expand into <code>mod</code>-declarations, this
 is tough to avoid in the general case for solving this problem.)</li>
</ul>


<p>Pipe that output to a file, copy that file to
<code>tock/kernel/src/lib.rs</code>, and you&rsquo;re don- &hellip; well, no; you&rsquo;re not done yet.</p>

<p>If you try to compile that as is, you get a slew of errors. Because some of the macros that
expanded came from Rust&rsquo;s <code>core</code> library, and make use of features that are not available
in stable Rust. So you have to add feature-gates to enable each one. Luckily, the nightly compiler
tells us which gates to add, so I was able to get away with adding this line to the top
of the generated file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="err">#</span><span class="o">!</span><span class="p">[</span><span class="n">feature</span><span class="p">(</span><span class="n">derive_clone_copy</span><span class="p">,</span> <span class="n">compiler_builtins_lib</span><span class="p">,</span> <span class="n">fmt_internals</span><span class="p">,</span> <span class="n">core_panic</span><span class="p">,</span> <span class="n">derive_eq</span><span class="p">)]</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Then</em> the compilation of this expanded <code>kernel</code> <a href="https://github.com/pnkfelix/demo-minimization/commit/00bb383f27ced7463263868dd36857c6e47ffbc6">worked</a>, and the downstream problem continued to reproduce.
Success!</p>

<p>At least, success if your definition of success is this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% wc tock/kernel/src/lib.rs
</span><span class='line'>   <span class="m">10238</span>   <span class="m">40254</span>  <span class="m">540987</span> tock/kernel/src/lib.rs
</span></code></pre></td></tr></table></div></figure>


<p>Yikes, 10K lines.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Simplify Workflow
</span></p>

<a name="L..loopification.....via.pretty-printer"></a>
<h3><a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a> via pretty-printer</h3>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
aka <code>-Z everybody_loops</code>
</span>
Well, that&rsquo;s okay: There are some steps we haven&rsquo;t taken yet. Specifically, we haven&rsquo;t done <a href="#Tactic:..Body.Loopification.">&ldquo;loopification.&rdquo;</a></p>

<p>Now, its not so much fun to <a href="#Tactic:..Body.Loopification.">&ldquo;loopify&rdquo;</a> a file like this by hand. The keyboard macro I described above
isn&rsquo;t <em>tha</em> robust; it can end up really messing up the code if you apply it blindly.</p>

<p>But luckily, we have another option:</p>

<p><code>rustc -Z unpretty=everybody_loops</code> is your friend.</p>

<p>Basically, take the command line we used up above for macro-expanding
pretty-printing, but replace the <code>--pretty=expanded</code> with
<code>-Zunpretty=everybody_loops</code>.</p>

<p>As before, pipe the output to a temporary file, and then copy that
over to <code>kernel/src/lib.rs</code>.</p>

<p>And then we build &hellip; and &hellip; oh. The bug didn&rsquo;t replicate.</p>

<ul>
<li>This is okay. It is <em>not</em> a disaster.</li>
</ul>


<p>It in fact motivates another technique: bisecting <a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a>.</p>

<a name="Bisecting.the.module.tree"></a>
<h3>Bisecting the module tree</h3>

<p>Warning: this technique may seem&hellip; strange. But I love it so.</p>

<p>The three steps are as follows:</p>

<ol>
<li><p>Unify modules into a single source file (which we did up above, via the pretty-printer).
But in particular, <em>leave</em> leave the original source files for the mod tree in
place. (You&rsquo;ll see why in a moment.)</p></li>
<li><p>Replace all function bodies with
<code>loop { }</code><label for='congrats-same-failure' class='margin-toggle'> &#8853;</label><input type='checkbox' id='congrats-same-failure' class='margin-toggle'/><span class='marginnote'>If after doing this, you still get the same failure again, then congratulations: You have a single file (with a potentially huge module tree) and all of its function bodies are trivial <code>loop { }</code>. But of course, in our case of <code>kernel</code>, we know that we are not in this scenario. </span>
(which we just did, again via the pretty-printer).</p></li>
<li><p>Finally, swap modules in and out via <a href="#Technique:..Cfgments.">&ldquo;cfgmenting&rdquo;</a>.</p></li>
</ol>


<p>Remember <a href="#Technique:..mod-inlining.">up above</a> when I suggested leaving the source files in place?
This is where that comes into play.</p>

<p>A relatively tiny (and easily mechanized) change to the source
code readily reverts individual modules back to their prior form:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kn">mod</span> <span class="n">child_mod_1</span> <span class="p">{</span>
</span><span class='line'>    <span class="kn">use</span> <span class="n">import</span><span class="o">::</span><span class="n">stuff</span><span class="p">;</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">some_function</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">mod</span> <span class="n">even_more_inner</span> <span class="p">{</span>
</span><span class='line'>       <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kn">mod</span> <span class="n">child_mod_1</span><span class="p">;</span>
</span><span class='line'><span class="cp">#[cfg(commented_out_for_bisection)]</span>
</span><span class='line'><span class="kn">mod</span> <span class="n">child_mod_1</span> <span class="p">{</span>
</span><span class='line'>    <span class="kn">use</span> <span class="n">import</span><span class="o">::</span><span class="n">stuff</span><span class="p">;</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">some_function</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">mod</span> <span class="n">even_more_inner</span> <span class="p">{</span>
</span><span class='line'>       <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This effectively puts back in the original code for <code>child_mod_1</code>.</p>

<p>You can search through your single <code>lib.rs</code> (or <code>main.rs</code>) file that
holds the whole module tree (where function bodies are replaced with
<code>loop { }</code>), and then choose a subset of these modules and apply the
above transformation to point them at their original source file.</p>

<p>You can do this for, e.g., the first half the modules, and then re-run
the compiler to see if the failure re-arises. If so, huzzah!</p>

<p>I successfully used this methodology to identify <em>which</em> <code>mod</code> in <code>kernel</code>
we <a href="https://github.com/pnkfelix/demo-minimization/commit/b9c47edced44c33c5362137040acbb814ddd70b5">needed to keep</a> in non-loopified form
in order to reproduce the bug: <code>mod process;</code>.</p>

<p>And that gets us down to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wc tock/kernel/src/lib.rs
</span><span class='line'>    <span class="m">3253</span>   <span class="m">11085</span>  <span class="m">112858</span> tock/kernel/src/lib.rs
</span></code></pre></td></tr></table></div></figure>


<p>Yeah, still 3K lines. But that&rsquo;s a lot better than 10K, and there&rsquo;s
plenty more stuff to remove.</p>

<p>First, lets see if we can further narrow down which methods in <code>mod
process</code> are the ones that we need for replicating the bug. For this,
we can do bisection over the <code>fn</code> items within the (still
out-of-line) <code>mod process</code>.</p>

<a name="Reduction.via.Bisection"></a>
<h2>Reduction via Bisection</h2>

<p>Sometimes you cannot simply remove all (or all but one) of the method
bodies. For one reason or another (e.g. <code>impl Trait</code> in return position)
you need to preserve the bodies of one or more methods that are not
directly relevant to the bug at hand.</p>

<p>In this scenario, it can stil be useful to use the techniques above to
eliminate irrelevant details in the <em>other</em> methods. But what is the
best way to identify which methods are relevant and which aren&rsquo;t?
Well, that&rsquo;s a fine segue to our original topic.</p>

<p>(&hellip; a significant amount of time has passed.)</p>

<p>Okay: after spending a lot of time doing pseudo-bisection, I managed
to <a href="https://github.com/pnkfelix/demo-minimization/commit/62ebace8bfb317e4419d7939e66b9d99c4edcc28">isolate <em>three</em> methods</a> in process.rs that are necessary to
reproduce the issue.</p>

<p>Part of my own process here (not <code>process</code>, ha ha) was to switch mindset away from trying to
bisect to find the &ldquo;one fn body&rdquo; that causes the faiure. Instead, I
had to focus on identifying a minimal subset of bodies that are
necessary to cause it to <em>arise</em>.</p>

<p>That is, starting with N <code>fn</code> items, I&rsquo;d <a href="#Tactic:..Body.Loopification.">&ldquo;loopify&rdquo;</a> N/2 of them, and if
the bug went away on that half, I&rsquo;d put back in the previous bodies,
cut that set in in half, and repeat until the bug came back. This
tended to narrow things down to one <code>fn</code> item that, when <a href="#Tactic:..Body.Loopification.">&ldquo;loopified&rdquo;</a>,
made the bug go away.</p>

<p>Then I&rsquo;d mark that one <code>fn</code> as strictly necessary, and repeat the
process on the N-1 <code>fn</code>-items that still remained.</p>

<p>To be clear: this switch in mindset changes so-called &ldquo;bisection&rdquo; from
a O(log&nbsp;n) process to an O(n&nbsp;log&nbsp;n) one: because you are going to do a
separate O(log&nbsp;n) bisection step on O(n) <code>fn</code>-items. But on the plus
side, its still a pretty mindless process (and probably could be
mechanically automated).</p>

<p>Eventually, this led me to identify the three functions in <code>process.rs</code>
whose non-<a href="#Tactic:..Body.Loopification.">&ldquo;loopified&rdquo;</a> definitions are needed to witness the bug:</p>

<ul>
<li><code>load_processes</code></li>
<li><code>&lt;Process as ProcessType&gt;::process_detail_fmt</code>, and</li>
<li><code>Process::create</code>.</li>
</ul>


<p>With that done, I redid the <a href="#Technique:..mod-inlining.">&ldquo;mod-inlining&rdquo;</a> of <code>mod process</code> into <code>kernel</code>.</p>

<a name="Popping.the.stack"></a>
<h1>Popping the stack</h1>

<p>Now, as a reminder: the reason we dived into <code>kernel</code> was to see if we could
remove the <code>stored_state</code> field from <code>struct Process</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">stored_state</span><span class="o">:</span>
</span><span class='line'>    <span class="n">Cell</span><span class="o">&lt;&lt;&lt;</span><span class="n">C</span> <span class="k">as</span> <span class="n">Chip</span><span class="o">&gt;::</span><span class="n">UserspaceKernelBoundary</span> <span class="k">as</span> <span class="n">UserspaceKernelBoundary</span><span class="o">&gt;::</span><span class="n">StoredState</span><span class="o">&gt;</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>The answer is unfortuately still no: two of the three methods we kept from <code>mod process</code>
refer to that field.</p>

<p>But we can do some <a href="https://github.com/pnkfelix/demo-minimization/commit/84e6e3d9ecf746e16480d827a5eadacb55246720">directed editing</a> to see if the bug repreoduces after <em>removing</em> those references:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -3067,12 +3067,6 @@ impl&lt;C: Chip&gt; ProcessType for Process&lt;&#39;a, C&gt; {</span>
</span><span class='line'>             flash_start
</span><span class='line'>         ));
</span><span class='line'>
</span><span class='line'><span class="gd">-        self.chip.userspace_kernel_boundary().process_detail_fmt(</span>
</span><span class='line'><span class="gd">-            self.sp(),</span>
</span><span class='line'><span class="gd">-            &amp;self.stored_state.get(),</span>
</span><span class='line'><span class="gd">-            writer,</span>
</span><span class='line'><span class="gd">-        );</span>
</span><span class='line'><span class="gd">-</span>
</span><span class='line'>         self.mpu_config.map(|config| {
</span><span class='line'>             let _ = writer.write_fmt(format_args!(&quot;{}&quot;, config));
</span><span class='line'>         });
</span><span class='line'><span class="gu">@@ -3205,7 +3199,7 @@ impl&lt;C: &#39;static + Chip&gt; Process&lt;&#39;a, C&gt; {</span>
</span><span class='line'>
</span><span class='line'>             process.flash = slice::from_raw_parts(app_flash_address, app_flash_size);
</span><span class='line'>
</span><span class='line'><span class="gd">-            process.stored_state = Cell::new(Default::default());</span>
</span><span class='line'><span class="gi">+            // process.stored_state = Cell::new(Default::default());</span>
</span><span class='line'>             process.state = Cell::new(State::Unstarted);
</span><span class='line'>             process.fault_response = fault_response;
</span><span class='line'>
</span><span class='line'><span class="gu">@@ -3246,6 +3240,7 @@ impl&lt;C: &#39;static + Chip&gt; Process&lt;&#39;a, C&gt; {</span>
</span><span class='line'>                 }));
</span><span class='line'>             });
</span><span class='line'>
</span><span class='line'><span class="gi">+            /*</span>
</span><span class='line'>             let mut stored_state = process.stored_state.get();
</span><span class='line'>             match chip.userspace_kernel_boundary().initialize_new_process(
</span><span class='line'>                 process.sp(),
</span><span class='line'><span class="gu">@@ -3263,6 +3258,7 @@ impl&lt;C: &#39;static + Chip&gt; Process&lt;&#39;a, C&gt; {</span>
</span><span class='line'>                     return (None, app_flash_size, 0);
</span><span class='line'>                 }
</span><span class='line'>             };
</span><span class='line'><span class="gi">+             */</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the answer is: YES. The bug reproduces!</p>

<p>And <em>now</em> we can move forward
with <a href="https://github.com/pnkfelix/demo-minimization/commit/1e6f3af833a5e84f94fefccaacc41cc473af1a55">removing that field</a>&hellip; YES, still reproduces:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- a/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ b/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -2809,9 +2809,6 @@ pub struct Process&lt;&#39;a, C: &#39;static + Chip&gt; {</span>
</span><span class='line'>
</span><span class='line'>     header: tbfheader::TbfHeader,
</span><span class='line'>
</span><span class='line'><span class="gd">-    stored_state:</span>
</span><span class='line'><span class="gd">-        Cell&lt;&lt;&lt;C as Chip&gt;::UserspaceKernelBoundary as UserspaceKernelBoundary&gt;::StoredState&gt;,</span>
</span><span class='line'><span class="gd">-</span>
</span><span class='line'>     state: Cell&lt;State&gt;,
</span><span class='line'>
</span><span class='line'>     fault_response: FaultResponse,
</span></code></pre></td></tr></table></div></figure>


<p>And then see about
<a href="https://github.com/pnkfelix/demo-minimization/commit/454e113532cded34be70fd11ab729785db061c20">removed the bound</a> on the associated type that sent us on this path&hellip; YES</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- a/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ b/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -2525,7 +2525,7 @@ mod platform {</span>
</span><span class='line'>         type
</span><span class='line'>         MPU: mpu::MPU;
</span><span class='line'>         type
</span><span class='line'><span class="gd">-        UserspaceKernelBoundary: syscall::UserspaceKernelBoundary;</span>
</span><span class='line'><span class="gi">+        UserspaceKernelBoundary;</span>
</span><span class='line'>         type
</span><span class='line'>         SysTick: systick::SysTick;
</span><span class='line'>         fn service_pending_interrupts(&amp;self) { loop  { } }
</span></code></pre></td></tr></table></div></figure>


<p>So <em>now</em> we can pop our stack: We can go back to <code>chips/arty_e21</code>,
and apply <a href="#Tactic:..Type-trivialization.">&ldquo;type-trivialization&rdquo;</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- a/tock/chips/arty_e21/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ b/tock/chips/arty_e21/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -21,7 +21,7 @@ impl ArtyExx {</span>
</span><span class='line'>
</span><span class='line'> impl kernel::Chip for ArtyExx {
</span><span class='line'>     type MPU = ();
</span><span class='line'><span class="gd">-    type UserspaceKernelBoundary = rv32i::syscall::SysCall;</span>
</span><span class='line'><span class="gi">+    type UserspaceKernelBoundary = ();</span>
</span><span class='line'>     type SysTick = ();
</span><span class='line'> }
</span></code></pre></td></tr></table></div></figure>


<p>We did it!</p>

<p><a href="https://github.com/pnkfelix/demo-minimization/commit/b9abaf69418a2cb94c508586c35f4c340221d596">With that in place, we can do</a> more <a href="#Tactic:..dep-reduction.">&ldquo;dep-reduction&rdquo;</a>, by removing the <code>rv32i</code> dependency from <code>chips/arty_e21</code>.</p>

<p>At this point, we could continue with the above transformations to further reduce <code>kernel</code>.</p>

<p>But I want to switch to showing a different kind of minimization transformation, one that will
let us make further simplifications to <code>boards/arty-e21</code>.</p>

<a name="Simplfying.the.existing.code"></a>
<h2>Simplfying the existing code</h2>

<p>Looking again at <code>boards/arty-e21</code>, we have this method body:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cp">#[no_mangle]</span>
</span><span class='line'><span class="k">pub</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">reset_handler</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">chip</span> <span class="o">=</span> <span class="n">static_init</span><span class="o">!</span><span class="p">(</span><span class="n">arty_e21</span><span class="o">::</span><span class="n">chip</span><span class="o">::</span><span class="n">ArtyExx</span><span class="p">,</span> <span class="n">arty_e21</span><span class="o">::</span><span class="n">chip</span><span class="o">::</span><span class="n">ArtyExx</span><span class="o">::</span><span class="n">new</span><span class="p">());</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">process_mgmt_cap</span> <span class="o">=</span> <span class="n">create_capability</span><span class="o">!</span><span class="p">(</span><span class="n">capabilities</span><span class="o">::</span><span class="n">ProcessManagementCapability</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">board_kernel</span> <span class="o">=</span> <span class="n">static_init</span><span class="o">!</span><span class="p">(</span><span class="n">kernel</span><span class="o">::</span><span class="n">Kernel</span><span class="p">,</span> <span class="n">kernel</span><span class="o">::</span><span class="n">Kernel</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PROCESSES</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kernel</span><span class="o">::</span><span class="n">procs</span><span class="o">::</span><span class="n">load_processes</span><span class="p">(</span>
</span><span class='line'>        <span class="n">board_kernel</span><span class="p">,</span>
</span><span class='line'>        <span class="n">chip</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="mi">0</span><span class="k">u8</span> <span class="k">as</span> <span class="o">*</span><span class="kr">const</span> <span class="kt">u8</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="mi">8192</span><span class="p">],</span> <span class="c1">// APP_MEMORY,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="k">mut</span> <span class="n">PROCESSES</span><span class="p">,</span>
</span><span class='line'>        <span class="n">kernel</span><span class="o">::</span><span class="n">procs</span><span class="o">::</span><span class="n">FaultResponse</span><span class="o">::</span><span class="n">Panic</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="n">process_mgmt_cap</span><span class="p">,</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It would be nice to figure out which parts of this are actually relevant.</p>

<p>Unfortunately, <code>kernel::procs::load_processes</code> was one of the functions
where we could not apply <a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a> without masking the <code>rustc</code> bug.</p>

<p>Let us see if we can at least simplfify the API of <code>load_processes</code> itself.</p>

<p>It currently looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">load_processes</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="n">Chip</span><span class="o">&gt;</span><span class="p">(</span>
</span><span class='line'>    <span class="n">kernel</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">Kernel</span><span class="p">,</span>
</span><span class='line'>    <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'>    <span class="n">start_of_flash</span><span class="o">:</span> <span class="o">*</span><span class="kr">const</span> <span class="kt">u8</span><span class="p">,</span>
</span><span class='line'>    <span class="n">app_memory</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
</span><span class='line'>    <span class="n">procs</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="k">mut</span> <span class="p">[</span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">&#39;static</span> <span class="n">dyn</span> <span class="n">ProcessType</span><span class="o">&gt;</span><span class="p">],</span>
</span><span class='line'>    <span class="n">fault_response</span><span class="o">:</span> <span class="n">FaultResponse</span><span class="p">,</span>
</span><span class='line'>    <span class="n">_capability</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">dyn</span> <span class="n">ProcessManagementCapability</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">apps_in_flash_ptr</span> <span class="o">=</span> <span class="n">start_of_flash</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">app_memory_ptr</span> <span class="o">=</span> <span class="n">app_memory</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">app_memory_size</span> <span class="o">=</span> <span class="n">app_memory</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.</span><span class="n">procs</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">flash_offset</span><span class="p">,</span> <span class="n">memory_offset</span><span class="p">)</span> <span class="o">=</span> <span class="n">Process</span><span class="o">::</span><span class="n">create</span><span class="p">(</span>
</span><span class='line'>                <span class="n">kernel</span><span class="p">,</span>
</span><span class='line'>                <span class="n">chip</span><span class="p">,</span>
</span><span class='line'>                <span class="n">apps_in_flash_ptr</span><span class="p">,</span>
</span><span class='line'>                <span class="n">app_memory_ptr</span><span class="p">,</span>
</span><span class='line'>                <span class="n">app_memory_size</span><span class="p">,</span>
</span><span class='line'>                <span class="n">fault_response</span><span class="p">,</span>
</span><span class='line'>                <span class="n">i</span><span class="p">,</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="n">process</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">flash_offset</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">memory_offset</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">apps_in_flash_ptr</span> <span class="o">=</span> <span class="n">apps_in_flash_ptr</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">flash_offset</span><span class="p">);</span>
</span><span class='line'>            <span class="n">app_memory_ptr</span> <span class="o">=</span> <span class="n">app_memory_ptr</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">memory_offset</span><span class="p">);</span>
</span><span class='line'>            <span class="n">app_memory_size</span> <span class="o">-=</span> <span class="n">memory_offset</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The fact that <code>Process::create</code> was <em>another</em> function that we could
not <a href="#Tactic:..Body.Loopification.">&ldquo;loopify&rdquo;</a> gives us a hint has to how to simplfy this further: can we
<a href="https://github.com/pnkfelix/demo-minimization/commit/4b60bdd00f670d55c3508ad5cee9d1f4778e361d">reduce this method body</a> to <em>just</em> a <code>Process::create</code> call, and see
if the bug persists?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -2586,31 +2586,17 @@ pub fn load_processes&lt;C: Chip&gt;(</span>
</span><span class='line'>     let mut apps_in_flash_ptr = start_of_flash;
</span><span class='line'>     let mut app_memory_ptr = app_memory.as_mut_ptr();
</span><span class='line'>     let mut app_memory_size = app_memory.len();
</span><span class='line'><span class="gd">-    for i in 0..procs.len() {</span>
</span><span class='line'>         unsafe {
</span><span class='line'><span class="gd">-            let (process, flash_offset, memory_offset) = Process::create(</span>
</span><span class='line'><span class="gi">+            Process::create(</span>
</span><span class='line'>                 kernel,
</span><span class='line'>                 chip,
</span><span class='line'>                 apps_in_flash_ptr,
</span><span class='line'>                 app_memory_ptr,
</span><span class='line'>                 app_memory_size,
</span><span class='line'>                 fault_response,
</span><span class='line'><span class="gd">-                i,</span>
</span><span class='line'><span class="gi">+                0,</span>
</span><span class='line'>             );
</span><span class='line'><span class="gd">-</span>
</span><span class='line'><span class="gd">-            if process.is_none() {</span>
</span><span class='line'><span class="gd">-                if flash_offset == 0 &amp;&amp; memory_offset == 0 {</span>
</span><span class='line'><span class="gd">-                    break;</span>
</span><span class='line'><span class="gd">-                }</span>
</span><span class='line'><span class="gd">-            } else {</span>
</span><span class='line'><span class="gd">-                procs[i] = process;</span>
</span><span class='line'><span class="gd">-            }</span>
</span><span class='line'><span class="gd">-</span>
</span><span class='line'><span class="gd">-            apps_in_flash_ptr = apps_in_flash_ptr.add(flash_offset);</span>
</span><span class='line'><span class="gd">-            app_memory_ptr = app_memory_ptr.add(memory_offset);</span>
</span><span class='line'><span class="gd">-            app_memory_size -= memory_offset;</span>
</span><span class='line'>         }
</span><span class='line'><span class="gd">-    }</span>
</span><span class='line'> }
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>And <em>yes</em>, the bug still reproduces.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Simplify Workflow
</span></p>

<a name="Tactic:..RHS-inlining."></a>
<h2>Tactic: &ldquo;RHS-inlining&rdquo;</h2>

<p>This is just the classic transformation of taking the right-hand side
of a <code>let</code> or <code>const</code> and copying it into the usage sites for the
variable defined by the <code>let</code> or <code>const</code>. Once all uses of the
variable have been replaced, you can try removing the <code>let</code> or <code>const</code>
itself (i.e. <a href="#Tactic:..Unusedification.">&ldquo;unusedification&rdquo;</a>)</p>

<p>In our specific case, we <a href="https://github.com/pnkfelix/demo-minimization/commit/f80808f057c22d0b8bbdee6765cbef6304565fe5">can apply this</a> to <code>load_processes</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- a/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ b/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -2583,16 +2583,13 @@ pub fn load_processes&lt;C: Chip&gt;(</span>
</span><span class='line'>     fault_response: FaultResponse,
</span><span class='line'>     _capability: &amp;dyn ProcessManagementCapability,
</span><span class='line'> ) {
</span><span class='line'><span class="gd">-    let mut apps_in_flash_ptr = start_of_flash;</span>
</span><span class='line'><span class="gd">-    let mut app_memory_ptr = app_memory.as_mut_ptr();</span>
</span><span class='line'><span class="gd">-    let mut app_memory_size = app_memory.len();</span>
</span><span class='line'>         unsafe {
</span><span class='line'>             Process::create(
</span><span class='line'>                 kernel,
</span><span class='line'>                 chip,
</span><span class='line'><span class="gd">-                apps_in_flash_ptr,</span>
</span><span class='line'><span class="gd">-                app_memory_ptr,</span>
</span><span class='line'><span class="gd">-                app_memory_size,</span>
</span><span class='line'><span class="gi">+                start_of_flash,</span>
</span><span class='line'><span class="gi">+                app_memory.as_mut_ptr(),</span>
</span><span class='line'><span class="gi">+                app_memory.len(),</span>
</span><span class='line'>                 fault_response,
</span><span class='line'>                 0,
</span><span class='line'>             );
</span></code></pre></td></tr></table></div></figure>


<p>However, this technique on its own does not tend to actually reduce
the problem at hand, in terms of making it possible for us to remove
imports or simplify <code>fn</code> API signatures.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Trivialize Content
</span></p>

<a name="Tactic:..Defaultification."></a>
<h2>Tactic: &ldquo;Defaultification&rdquo;</h2>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
aka &ldquo;Scalars Gotta Scale&rdquo;
</span>
If you really want to <em>simplify</em>, then you should replace the
occurences of the variable with some &ldquo;obvious&rdquo; value based on its
type.</p>

<p>(This is the obvious alternative to <a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a> when it comes to simplifying <code>const fn</code>.)</p>

<p>More specifically: frequently, the return type of a <code>const fn</code> (or the
type of a <code>const</code> item) is some scalar type (like <code>u32</code>, <code>f64</code>, or
<code>bool</code>). These all have &ldquo;obvious&rdquo; values that you can just plug in
(respectively <code>0</code>, <code>0.0</code>, or <code>false</code>).</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kr">const</span> <span class="k">fn</span> <span class="n">cfoo</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">u32</span> <span class="p">{</span> <span class="o">----</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kr">const</span> <span class="k">fn</span> <span class="n">cfoo</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">u32</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the case of <code>load_processes</code>, <a href="#Tactic:..Defaultification.">&ldquo;defaultification&rdquo;</a> <a href="https://github.com/pnkfelix/demo-minimization/commit/c6ed070fc55ce2ca5364f477154f53174eec5849">yields this</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -2587,9 +2587,9 @@ pub fn load_processes&lt;C: Chip&gt;(</span>
</span><span class='line'>             Process::create(
</span><span class='line'>                 kernel,
</span><span class='line'>                 chip,
</span><span class='line'><span class="gd">-                start_of_flash,</span>
</span><span class='line'><span class="gd">-                app_memory.as_mut_ptr(),</span>
</span><span class='line'><span class="gd">-                app_memory.len(),</span>
</span><span class='line'><span class="gi">+                0 as *const u8,</span>
</span><span class='line'><span class="gi">+                (&amp;mut []).as_mut_ptr(),</span>
</span><span class='line'><span class="gi">+                0,</span>
</span><span class='line'>                 fault_response,
</span><span class='line'>                 0,
</span><span class='line'>             );
</span></code></pre></td></tr></table></div></figure>


<p>That means we&rsquo;ve gotten rid of the uses of three <code>fn</code> parameters in
the body of <code>load_processes</code>. Lets see what that can buy us for
further reduction.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Trivialize Content
</span></p>

<a name="Technique:..Genertrification."></a>
<h2>Technique: &ldquo;Genertrification&rdquo;</h2>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
aka &ldquo;Type Freedom&rdquo;
</span>
Once you remove all uses of parameter (which is readily identifiable
via either lint diagnostics or if the parameter has just
<code>_: ParamType</code> for its declaration), you can <a href="#Technique:..Genertrification.">&ldquo;genertrify&rdquo;</a> it to get rid of the
use of <code>ParamType</code>.</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">_</span><span class="o">:</span> <span class="n">ParamType</span><span class="p">,</span> <span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span><span class="o">:</span> <span class="n">A</span><span class="p">,</span> <span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>or even more simply (in terms of locality of the transformation):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">_</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span> <span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The beauty of this is that it can almost always be applied even if
there remain uses of <code>foo</code> elsewhere in the code.</p>

<p>Therefore, I tend to recommend it over
<a href="#Technique:..Param-elimination.">&ldquo;param-elimination&rdquo;</a>, described below.</p>

<ul>
<li><p>However, this transformation does not work if <code>fn foo</code> must not carry
any generic type parameters; e.g., if <code>fn foo</code> needs to be
object-safe, then you cannot add the type parameteter <code>A</code>.</p></li>
<li><p>The other case where it cannot be applied is when an existing
use is relying on the existing type for inference purposes.
We will <a href="#L.you.can.t.always.genertrify.what.you.want.">see an example of this below</a>.</p></li>
</ul>


<p>In the case of <code>load_processes</code>, <a href="#Technique:..Genertrification.">&ldquo;genertrification&rdquo;</a> allows <a href="https://github.com/pnkfelix/demo-minimization/commit/25dbbfbe418263460e671bbb6401c290e191d226">this change</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -2577,11 +2577,11 @@ use core::cmp::max;</span>
</span><span class='line'> pub fn load_processes&lt;C: Chip&gt;(
</span><span class='line'>     kernel: &amp;&#39;static Kernel,
</span><span class='line'>     chip: &amp;&#39;static C,
</span><span class='line'><span class="gd">-    start_of_flash: *const u8,</span>
</span><span class='line'><span class="gd">-    app_memory: &amp;mut [u8],</span>
</span><span class='line'><span class="gd">-    procs: &amp;&#39;static mut [Option&lt;&amp;&#39;static dyn ProcessType&gt;],</span>
</span><span class='line'><span class="gi">+    _: impl Sized,</span>
</span><span class='line'><span class="gi">+    _: impl Sized,</span>
</span><span class='line'><span class="gi">+    _: impl Sized,</span>
</span><span class='line'>     fault_response: FaultResponse,
</span><span class='line'><span class="gd">-    _capability: &amp;dyn ProcessManagementCapability,</span>
</span><span class='line'><span class="gi">+    _: impl Sized,</span>
</span><span class='line'> ) {
</span><span class='line'>         unsafe {
</span><span class='line'>             Process::create(
</span></code></pre></td></tr></table></div></figure>


<p>And once we do <em>that</em>, we can revise any calls to <code>load_processes</code> and
pass any value we like for the <code>impl Sized</code> arguments. So we&rsquo;ve opened
up new opportunities for <a href="#Tactic:..Expr-elimination.">&ldquo;expr-elimination&rdquo;</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/boards/arty-e21/src/main.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/boards/arty-e21/src/main.rs</span>
</span><span class='line'><span class="gu">@@ -39,17 +39,16 @@ impl Platform for ArtyE21 {</span>
</span><span class='line'> #[no_mangle]
</span><span class='line'> pub unsafe fn reset_handler() {
</span><span class='line'>     let chip = static_init!(arty_e21::chip::ArtyExx, arty_e21::chip::ArtyExx::new());
</span><span class='line'><span class="gd">-    let process_mgmt_cap = create_capability!(capabilities::ProcessManagementCapability);</span>
</span><span class='line'>     let board_kernel = static_init!(kernel::Kernel, kernel::Kernel::new(&amp;PROCESSES));
</span><span class='line'>
</span><span class='line'>     kernel::procs::load_processes(
</span><span class='line'>         board_kernel,
</span><span class='line'>         chip,
</span><span class='line'><span class="gd">-        &amp;0u8 as *const u8,</span>
</span><span class='line'><span class="gd">-        &amp;mut [0; 8192], // APP_MEMORY,</span>
</span><span class='line'><span class="gd">-        &amp;mut PROCESSES,</span>
</span><span class='line'><span class="gi">+        (),</span>
</span><span class='line'><span class="gi">+        (),</span>
</span><span class='line'><span class="gi">+        (),</span>
</span><span class='line'>         kernel::procs::FaultResponse::Panic,
</span><span class='line'><span class="gd">-        &amp;process_mgmt_cap,</span>
</span><span class='line'><span class="gi">+        (),</span>
</span><span class='line'>     );
</span><span class='line'>
</span><span class='line'> }
</span></code></pre></td></tr></table></div></figure>


<p>We would like to continue simplifying the APIs by applying <a href="#Technique:..Genertrification.">&ldquo;genertrification&rdquo;</a> elsewhere.
For example, <code>load_processes</code> calls <code>Process::create</code>, so it would be useful to simplify
its API.</p>

<p>The body of <code>Process::create</code> is currently over 150 lines of code. But after
bisection-based <a href="#Tactic:..Expr-elimination.">&ldquo;expr-elimination&rdquo;</a>, coupled with <a href="#Tactic:..RHS-inlining.">&ldquo;RHS-inlining&rdquo;</a>, <a href="#Tactic:..Defaultification.">&ldquo;defaultification&rdquo;</a>, and <a href="#Tactic:..Unusedification.">&ldquo;unusedification&rdquo;</a>,
we can get the body down to this far more managable 20 lines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="k">&#39;static</span> <span class="o">+</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[allow(clippy::cast_ptr_alignment)]</span>
</span><span class='line'>    <span class="n">crate</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">create</span><span class="p">(</span>
</span><span class='line'>        <span class="n">kernel</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">Kernel</span><span class="p">,</span>
</span><span class='line'>        <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'>        <span class="n">app_flash_address</span><span class="o">:</span> <span class="o">*</span><span class="kr">const</span> <span class="kt">u8</span><span class="p">,</span>
</span><span class='line'>        <span class="n">remaining_app_memory</span><span class="o">:</span> <span class="o">*</span><span class="k">mut</span> <span class="kt">u8</span><span class="p">,</span>
</span><span class='line'>        <span class="n">remaining_app_memory_size</span><span class="o">:</span> <span class="n">usize</span><span class="p">,</span>
</span><span class='line'>        <span class="n">fault_response</span><span class="o">:</span> <span class="n">FaultResponse</span><span class="p">,</span>
</span><span class='line'>        <span class="n">index</span><span class="o">:</span> <span class="n">usize</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">&#39;static</span> <span class="n">dyn</span> <span class="n">ProcessType</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">usize</span><span class="p">,</span> <span class="n">usize</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="k">mut</span> <span class="n">process</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Process</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="p">((</span><span class="o">&amp;</span><span class="k">mut</span> <span class="p">[]).</span><span class="n">as_mut_ptr</span><span class="p">()</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="n">Process</span><span class="o">&lt;</span><span class="k">&#39;static</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">process</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">MapCell</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">ProcessDebug</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">app_heap_start_pointer</span><span class="o">:</span> <span class="nb">None</span><span class="p">,</span>
</span><span class='line'>                <span class="n">app_stack_start_pointer</span><span class="o">:</span> <span class="nb">None</span><span class="p">,</span>
</span><span class='line'>                <span class="n">min_stack_pointer</span><span class="o">:</span> <span class="mi">0</span> <span class="k">as</span> <span class="o">*</span><span class="kr">const</span> <span class="kt">u8</span><span class="p">,</span>
</span><span class='line'>                <span class="n">syscall_count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                <span class="n">last_syscall</span><span class="o">:</span> <span class="nb">None</span><span class="p">,</span>
</span><span class='line'>                <span class="n">dropped_callback_count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                <span class="n">restart_count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                <span class="n">timeslice_expiration_count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="n">process</span><span class="p">),</span>
</span><span class='line'>                <span class="mi">0</span><span class="k">u</span><span class="n">size</span><span class="p">,</span>
</span><span class='line'>                <span class="mi">0</span><span class="k">u</span><span class="n">size</span><span class="p">,</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now we can apply <a href="#Technique:..Genertrification.">&ldquo;genertrification&rdquo;</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -3065,13 +3065,13 @@ fn exceeded_check(size: usize, allocated: usize) -&gt; &amp;&#39;static str { loop { } }</span>
</span><span class='line'> impl&lt;C: &#39;static + Chip&gt; Process&lt;&#39;a, C&gt; {
</span><span class='line'>     #[allow(clippy::cast_ptr_alignment)]
</span><span class='line'>     crate unsafe fn create(
</span><span class='line'><span class="gd">-        kernel: &amp;&#39;static Kernel,</span>
</span><span class='line'><span class="gi">+        kernel: impl Sized,</span>
</span><span class='line'>         chip: &amp;&#39;static C,
</span><span class='line'><span class="gd">-        app_flash_address: *const u8,</span>
</span><span class='line'><span class="gi">+        app_flash_address: impl Sized,</span>
</span><span class='line'>         remaining_app_memory: *mut u8,
</span><span class='line'><span class="gd">-        remaining_app_memory_size: usize,</span>
</span><span class='line'><span class="gd">-        fault_response: FaultResponse,</span>
</span><span class='line'><span class="gd">-        index: usize,</span>
</span><span class='line'><span class="gi">+        remaining_app_memory_size: impl Sized,</span>
</span><span class='line'><span class="gi">+        fault_response: impl Sized,</span>
</span><span class='line'><span class="gi">+        index: impl Sized,</span>
</span><span class='line'>     ) -&gt; (Option&lt;&amp;&#39;static dyn ProcessType&gt;, usize, usize) {
</span><span class='line'>             let mut process: &amp;mut Process&lt;C&gt; =
</span><span class='line'>                 &amp;mut *((&amp;mut []).as_mut_ptr() as *mut Process&lt;&#39;static, C&gt;);
</span></code></pre></td></tr></table></div></figure>


<a name="L.you.can.t.always.genertrify.what.you.want."></a>
<h4>&ldquo;you can&rsquo;t always genertrify what you want&rdquo;</h4>

<p>Unfortunately, I was not able to <a href="#Technique:..Genertrification.">&ldquo;genertrify&rdquo;</a> the <code>remaining_app_memory</code>
formal parameter, even though it is unused in the function body. Why
is this? Because the current call-site is <em>relying</em> on the type of the
formal parameter for inference purposes. So in this case, we need to
update the API in tandem with the call site:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -2588,7 +2588,7 @@ pub fn load_processes&lt;C: Chip&gt;(</span>
</span><span class='line'>                 (),
</span><span class='line'>                 chip,
</span><span class='line'>                 (),
</span><span class='line'><span class="gd">-                (&amp;mut []).as_mut_ptr(),</span>
</span><span class='line'><span class="gi">+                (),</span>
</span><span class='line'>                 0,
</span><span class='line'>                 (),
</span><span class='line'>                 0,
</span><span class='line'><span class="gu">@@ -3068,7 +3068,7 @@ impl&lt;C: &#39;static + Chip&gt; Process&lt;&#39;a, C&gt; {</span>
</span><span class='line'>         kernel: impl Sized,
</span><span class='line'>         chip: &amp;&#39;static C,
</span><span class='line'>         app_flash_address: impl Sized,
</span><span class='line'><span class="gd">-        remaining_app_memory: *mut u8,</span>
</span><span class='line'><span class="gi">+        remaining_app_memory: impl Sized,</span>
</span><span class='line'>         remaining_app_memory_size: impl Sized,
</span><span class='line'>         fault_response: impl Sized,
</span><span class='line'>         index: impl Sized,
</span></code></pre></td></tr></table></div></figure>


<p>This allows further <a href="#Tactic:..Expr-elimination.">&ldquo;expr-elimination&rdquo;</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -3076,17 +3076,6 @@ impl&lt;C: &#39;static + Chip&gt; Process&lt;&#39;a, C&gt; {</span>
</span><span class='line'>             let mut process: &amp;mut Process&lt;C&gt; =
</span><span class='line'>                 &amp;mut *((&amp;mut []).as_mut_ptr() as *mut Process&lt;&#39;static, C&gt;);
</span><span class='line'>
</span><span class='line'><span class="gd">-            process.debug = MapCell::new(ProcessDebug {</span>
</span><span class='line'><span class="gd">-                app_heap_start_pointer: None,</span>
</span><span class='line'><span class="gd">-                app_stack_start_pointer: None,</span>
</span><span class='line'><span class="gd">-                min_stack_pointer: 0 as *const u8,</span>
</span><span class='line'><span class="gd">-                syscall_count: 0,</span>
</span><span class='line'><span class="gd">-                last_syscall: None,</span>
</span><span class='line'><span class="gd">-                dropped_callback_count: 0,</span>
</span><span class='line'><span class="gd">-                restart_count: 0,</span>
</span><span class='line'><span class="gd">-                timeslice_expiration_count: 0,</span>
</span><span class='line'><span class="gd">-            });</span>
</span><span class='line'><span class="gd">-</span>
</span><span class='line'>             return (
</span><span class='line'>                 Some(process),
</span><span class='line'>                 0usize,
</span></code></pre></td></tr></table></div></figure>


<p>and we bave gotten <code>Process::create</code> down to something that actually is close to minimal,
at least with given the transformations we have covered so far:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="k">&#39;static</span> <span class="o">+</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[allow(clippy::cast_ptr_alignment)]</span>
</span><span class='line'>    <span class="n">crate</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">create</span><span class="p">(</span>
</span><span class='line'>        <span class="n">kernel</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>        <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'>        <span class="n">app_flash_address</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>        <span class="n">remaining_app_memory</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>        <span class="n">remaining_app_memory_size</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>        <span class="n">fault_response</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>        <span class="n">index</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">&#39;static</span> <span class="n">dyn</span> <span class="n">ProcessType</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">usize</span><span class="p">,</span> <span class="n">usize</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="k">mut</span> <span class="n">process</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Process</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="p">((</span><span class="o">&amp;</span><span class="k">mut</span> <span class="p">[]).</span><span class="n">as_mut_ptr</span><span class="p">()</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="n">Process</span><span class="o">&lt;</span><span class="k">&#39;static</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="n">process</span><span class="p">),</span>
</span><span class='line'>                <span class="mi">0</span><span class="k">u</span><span class="n">size</span><span class="p">,</span>
</span><span class='line'>                <span class="mi">0</span><span class="k">u</span><span class="n">size</span><span class="p">,</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But of course, we can go further!</p>

<a name="Once.all.the.code.is.gone...."></a>
<h2>Once all the code is gone &hellip;</h2>

<p>The applicability of many of the remaining patterns <em>depends on</em>
whether you have successfully trivialized all or most method bodies.
That is, if you have gotten rid of most of the complex expressions in
the program, then you can usually remove things like struct field
declarations or any &ldquo;interesting&rdquo; types on formal parameters.</p>

<p>So, lets see if we can further reduce the complexity of our example
by simplifying the APIs of the functions involved.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Trivialize Content
</span></p>

<a name="Technique:..Param-elimination."></a>
<h2>Technique: &ldquo;Param-elimination&rdquo;</h2>

<p>If you have successfully eliminated all uses of a method <code>foo</code>,
then you can apply this transformation:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">_</span><span class="o">:</span> <span class="n">ArgType</span><span class="p">,</span> <span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In some rare cases, the compiler bug will requires a method signature
to keep the same number of arguments; for that scenario, you can
instead use <a href="#Tactic:..Type-trivialization.">&ldquo;type-trivialization&rdquo;</a> for the parameter:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">_</span><span class="o">:</span> <span class="n">ArgType</span><span class="p">,</span> <span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">_</span><span class="o">:</span> <span class="p">(),</span> <span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Either way, these transformations can only be applied if all <em>uses</em> of
<code>foo</code> have been eliminated via trivialization of bodies as described
above (or if you are willing to update them all accordingly). Thus, I
tend to recommend applying <a href="#Technique:..Genertrification.">&ldquo;genertrification&rdquo;</a> instead: that transformation
can be applied without concern about the usage sites.</p>

<p>Of course, if you have already applied <a href="#Technique:..Genertrification.">&ldquo;genertrification&rdquo;</a> and also updated
all call sites to pass something trivial like <code>()</code>, then you can readily
apply either <a href="#Technique:..Param-elimination.">&ldquo;param-elimination&rdquo;</a> or <a href="#Tactic:..Type-trivialization.">&ldquo;type-trivialization&rdquo;</a>: it really should be
easy to update the call-sites in that scenario.</p>

<p>In our particular case of <code>Process::create</code>, we currently have a <code>fn</code>-signature that looks
like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">crate</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">create</span><span class="p">(</span>
</span><span class='line'>    <span class="n">kernel</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>    <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'>    <span class="n">app_flash_address</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>    <span class="n">remaining_app_memory</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>    <span class="n">remaining_app_memory_size</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>    <span class="n">fault_response</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'>    <span class="n">index</span><span class="o">:</span> <span class="k">impl</span> <span class="nb">Sized</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">&#39;static</span> <span class="n">dyn</span> <span class="n">ProcessType</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">usize</span><span class="p">,</span> <span class="n">usize</span><span class="p">)</span> <span class="p">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we already updated the single call-site to pass <code>()</code> or <code>0</code> for each of the parameters of type <code>impl Sized</code>,
so now <a href="https://github.com/pnkfelix/demo-minimization/commit/540231a22733485eef87bdfe1314f079821d7abc">we can just remove them entirely</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -2585,13 +2585,7 @@ pub fn load_processes&lt;C: Chip&gt;(</span>
</span><span class='line'> ) {
</span><span class='line'>         unsafe {
</span><span class='line'>             Process::create(
</span><span class='line'><span class="gd">-                (),</span>
</span><span class='line'>                 chip,
</span><span class='line'><span class="gd">-                (),</span>
</span><span class='line'><span class="gd">-                (),</span>
</span><span class='line'><span class="gd">-                0,</span>
</span><span class='line'><span class="gd">-                (),</span>
</span><span class='line'><span class="gd">-                0,</span>
</span><span class='line'>             );
</span><span class='line'>         }
</span><span class='line'> }
</span><span class='line'><span class="gu">@@ -3065,13 +3059,7 @@ fn exceeded_check(size: usize, allocated: usize) -&gt; &amp;&#39;static str { loop { } }</span>
</span><span class='line'> impl&lt;C: &#39;static + Chip&gt; Process&lt;&#39;a, C&gt; {
</span><span class='line'>     #[allow(clippy::cast_ptr_alignment)]
</span><span class='line'>     crate unsafe fn create(
</span><span class='line'><span class="gd">-        kernel: impl Sized,</span>
</span><span class='line'>         chip: &amp;&#39;static C,
</span><span class='line'><span class="gd">-        app_flash_address: impl Sized,</span>
</span><span class='line'><span class="gd">-        remaining_app_memory: impl Sized,</span>
</span><span class='line'><span class="gd">-        remaining_app_memory_size: impl Sized,</span>
</span><span class='line'><span class="gd">-        fault_response: impl Sized,</span>
</span><span class='line'><span class="gd">-        index: impl Sized,</span>
</span><span class='line'>     ) -&gt; (Option&lt;&amp;&#39;static dyn ProcessType&gt;, usize, usize) {
</span><span class='line'>             let mut process: &amp;mut Process&lt;C&gt; =
</span><span class='line'>                 &amp;mut *((&amp;mut []).as_mut_ptr() as *mut Process&lt;&#39;static, C&gt;);
</span></code></pre></td></tr></table></div></figure>


<p>And compiling still hits the same ICE, so this <a href="#Technique:..Param-elimination.">&ldquo;param-elimination&rdquo;</a> was a legitimate reduction
of the problem.</p>

<p>Next we&rsquo;ll consider a related transformation on the <code>fn</code>-signature.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Trivialize Content
</span></p>

<a name="Technique:..Ret-elimination."></a>
<h2>Technique: &ldquo;Ret-elimination&rdquo;</h2>

<p>If you have successfully eliminated all uses of the value returned from calls to <code>foo</code>,
then you can apply this transformation:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If <code>fn foo</code> still has a body, then you can just turn every return point in the body into
a normal expression:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">if</span> <span class="n">A</span> <span class="p">{</span> <span class="k">return</span> <span class="n">B</span><span class="p">;</span> <span class="p">}</span> <span class="n">TailReturn</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="n">A</span> <span class="p">{</span> <span class="n">B</span><span class="p">;</span> <span class="p">}</span> <span class="n">TailReturn</span><span class="p">;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our case, the sole call to <code>Process::create</code> now looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'>    <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Process</span><span class="o">::</span><span class="n">create</span><span class="p">(</span>
</span><span class='line'>            <span class="n">chip</span><span class="p">,</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we can directly apply <a href="#Technique:..Ret-elimination.">&ldquo;ret-elimination&rdquo;</a> to the definition of <code>Process::create</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -3060,11 +3060,11 @@ impl&lt;C: &#39;static + Chip&gt; Process&lt;&#39;a, C&gt; {</span>
</span><span class='line'>     #[allow(clippy::cast_ptr_alignment)]
</span><span class='line'>     crate unsafe fn create(
</span><span class='line'>         chip: &amp;&#39;static C,
</span><span class='line'><span class="gd">-    ) -&gt; (Option&lt;&amp;&#39;static dyn ProcessType&gt;, usize, usize) {</span>
</span><span class='line'><span class="gi">+    ) {</span>
</span><span class='line'>             let mut process: &amp;mut Process&lt;C&gt; =
</span><span class='line'>                 &amp;mut *((&amp;mut []).as_mut_ptr() as *mut Process&lt;&#39;static, C&gt;);
</span><span class='line'>
</span><span class='line'><span class="gd">-            return (</span>
</span><span class='line'><span class="gi">+            (</span>
</span><span class='line'>                 Some(process),
</span><span class='line'>                 0usize,
</span><span class='line'>                 0usize,
</span></code></pre></td></tr></table></div></figure>


<p>But&hellip; Ah ha! Doing this causes the compilation error to disappear!</p>

<p>What happened?</p>

<p>Well, inspecting the return type, we can see that <a href="#Technique:..Ret-elimination.">&ldquo;Ret-elimination&rdquo;</a> in this
case has gotten rid of the type: <code>(Option&lt;&amp;'static dyn ProcessType&gt;, usize, usize)</code>.
Nested within that tuple, we see the type <code>&amp;'static dyn ProcessType</code>.
So, the attemtpt to return <code>(Some(process), 0, 0)</code> is causing the generated
code to coerce the <code>process: &amp;mut Process&lt;C&gt;</code> into a <em>trait-object</em> of
type <code>&amp;dyn ProcessType</code>. And apparently this is part of generating the bug!</p>

<p>So, do not look at this reduction-failure as a set-back: It in fact may
serve as a clue as to the root cause of the bug.</p>

<a name="Final.reduction.touches.on..code.Process::create..code."></a>
<h2>Final reduction touches on <code>Process::create</code></h2>

<p>For <code>Process::create</code>, we have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="k">&#39;static</span> <span class="o">+</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[allow(clippy::cast_ptr_alignment)]</span>
</span><span class='line'>    <span class="n">crate</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">create</span><span class="p">(</span>
</span><span class='line'>        <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">&#39;static</span> <span class="n">dyn</span> <span class="n">ProcessType</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">usize</span><span class="p">,</span> <span class="n">usize</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="k">mut</span> <span class="n">process</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Process</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="p">((</span><span class="o">&amp;</span><span class="k">mut</span> <span class="p">[]).</span><span class="n">as_mut_ptr</span><span class="p">()</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="n">Process</span><span class="o">&lt;</span><span class="k">&#39;static</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="n">process</span><span class="p">),</span>
</span><span class='line'>                <span class="mi">0</span><span class="k">u</span><span class="n">size</span><span class="p">,</span>
</span><span class='line'>                <span class="mi">0</span><span class="k">u</span><span class="n">size</span><span class="p">,</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can <a href="https://github.com/pnkfelix/demo-minimization/commit/27540630839cf2efc4a52dee42657fca35dce0f0">simplfy this API</a> by reducing the return type to the core element that matters: the trait object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- a/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ b/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -3045,15 +3045,11 @@ impl&lt;C: &#39;static + Chip&gt; Process&lt;&#39;a, C&gt; {</span>
</span><span class='line'>     #[allow(clippy::cast_ptr_alignment)]
</span><span class='line'>     crate unsafe fn create(
</span><span class='line'>         chip: &amp;&#39;static C,
</span><span class='line'><span class="gd">-    ) -&gt; (Option&lt;&amp;&#39;static dyn ProcessType&gt;, usize, usize) {</span>
</span><span class='line'><span class="gi">+    ) -&gt; &amp;&#39;static dyn ProcessType {</span>
</span><span class='line'>             let mut process: &amp;mut Process&lt;C&gt; =
</span><span class='line'>                 &amp;mut *((&amp;mut []).as_mut_ptr() as *mut Process&lt;&#39;static, C&gt;);
</span><span class='line'>
</span><span class='line'><span class="gd">-            return (</span>
</span><span class='line'><span class="gd">-                Some(process),</span>
</span><span class='line'><span class="gd">-                0usize,</span>
</span><span class='line'><span class="gd">-                0usize,</span>
</span><span class='line'><span class="gd">-            );</span>
</span><span class='line'><span class="gi">+            process</span>
</span><span class='line'>     }
</span><span class='line'>
</span><span class='line'>     #[allow(clippy::cast_ptr_alignment)]
</span></code></pre></td></tr></table></div></figure>


<p>In fact, we can do even better. The initialization expression on the right-hand side
of <code>let mut process = ...</code> is ugly, and its actually completely irrelevant.</p>

<p>In cases like these where we are hitting an ICE, we can use a special kind of <a href="#Tactic:..Defaultification.">&ldquo;defaultification&rdquo;</a>
to conjure up types without needing any knowledge of their expression.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Trivialize Content
</span></p>

<a name="Technique:..None-defaulting."></a>
<h2>Technique: &ldquo;None-defaulting&rdquo;</h2>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
This is yet another case where the fact that we are debugging a compile-time issue is
crucial. You obviously cannot be tossing <code>None.unwrap()</code> into code you expect to run
usefully.
</span>
The idea of <a href="#Technique:..None-defaulting.">&ldquo;none-defaulting&rdquo;</a> is simple: You need the compiler to think you have a value of type
<code>T</code>. But the steps to make an instance of <code>T</code> are not relevant to reproducing the bug.
So just make a <code>None::&lt;T&gt;</code>, and unwrap it.</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kd">let</span> <span class="n">x</span><span class="o">:</span> <span class="n">T</span> <span class="o">=</span> <span class="o">----</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kd">let</span> <span class="n">x</span><span class="o">:</span> <span class="n">T</span> <span class="o">=</span> <span class="nb">None</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our case, <a href="https://github.com/pnkfelix/demo-minimization/commit/c52b9f55c95c55723a32077c72451c772e00e618">applying this technique</a> to <code>Process::create</code> yields this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="k">&#39;static</span> <span class="o">+</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[allow(clippy::cast_ptr_alignment)]</span>
</span><span class='line'>    <span class="n">crate</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">create</span><span class="p">(</span>
</span><span class='line'>        <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">dyn</span> <span class="n">ProcessType</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="k">mut</span> <span class="n">process</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Process</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nb">None</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">process</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And compiling this, the ICE still reproduces!</p>

<a name="So..where.are.we.now"></a>
<h1>So, where are we now</h1>

<p>We&rsquo;ve still got a set of three crates, one of which is over 3,000 lines long.</p>

<p>But we&rsquo;ve also reduced the set of non-trival functions in that big crate to just
three:</p>

<ul>
<li><code>Process::create</code>,</li>
<li><code>load_processes</code>, and</li>
<li><code>&lt;Process as ProcessType&gt;::process_detail_fmt</code>.</li>
</ul>


<p>If you think for a momeent, you can see how everything is tying together here:
This ICE is occurring in the midst of some step of code-generation. We previously
established that in order to observe the ICE,
the compiler needs to handle code-generation for the coercion from
<code>&amp;Process</code> to a trait object <code>&amp;dyn ProcessType</code> .
A method like <code>&lt;Process as ProcessType&gt;::process_detail_fmt</code> is part of the virtual-methods
that get their code generated as part of that coercion.</p>

<p>We already showed <code>Process::create</code> is now pretty trivial.</p>

<p>As for <code>load_processes</code>,
after doing some additional <a href="#Tactic:..Unusedification.">&ldquo;unusedification&rdquo;</a> and <a href="#Technique:..Param-elimination.">&ldquo;param-elimination&rdquo;</a>
we can get it down to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">load_processes</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="n">Chip</span><span class="o">&gt;</span><span class="p">(</span>
</span><span class='line'>    <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Process</span><span class="o">::</span><span class="n">create</span><span class="p">(</span>
</span><span class='line'>                <span class="n">chip</span><span class="p">,</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>which we might as well rewrite into the one-liner:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">load_processes</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="n">Chip</span><span class="o">&gt;</span><span class="p">(</span><span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">)</span> <span class="p">{</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">Process</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That just leaves <code>&lt;Process as ProcessType&gt;::process_detail_fmt</code>, which we have not looked at yet.</p>

<p>As part of the earlier (undocumented) bisection process on the out-of-line <code>mod process;</code>, I
already <a href="#Tactic:..simpl-impl.">&ldquo;simpl-impled&rdquo;</a> the <code>ProcessType</code> trait declaration, so it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">ProcessType</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">appid</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AppId</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">process_detail_fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">dyn</span> <span class="n">Write</span><span class="p">)</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This means we can remove all of the irrelevant methods from the <code>impl&lt;C: Chip&gt; ProcessType for Process&lt;'a, C&gt;</code>,
leaving us with just the single method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="n">ProcessType</span> <span class="k">for</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">process_detail_fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">dyn</span> <span class="n">Write</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And since this is now the <em>only</em> <code>impl</code> of <code>ProcessType</code>, we can also
remove the other methods from the <code>ProcessType</code> trait itself:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">ProcessType</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">process_detail_fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">dyn</span> <span class="n">Write</span><span class="p">)</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I cannot stress how satisfying it is to be able to <em>retest</em> the ICE in
between each of these steps. It gives you excellent points to pause,
get up from the keyboard and take a walk (which is another
surprisingly effective debugging methodology).</p>

<p>But we still have the body of <code>fn process_detail_fmt</code> itself, which is
about 175 lines of code. So lets try to winnow that down.</p>

<p><a href="#Technique:.Suffix-bisection">&ldquo;Suffix-bisection&rdquo;</a> ends up revealing that the ICE is triggered by this bit of code
in the method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'>    <span class="bp">self</span><span class="p">.</span><span class="n">mpu_config</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">config</span><span class="o">|</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">writer</span><span class="p">.</span><span class="n">write_fmt</span><span class="p">(</span><span class="n">format_args</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">));</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>And so we can <a href="#Tactic:..Expr-elimination.">&ldquo;expr-eliminate&rdquo;</a> all the rest, leaving this defintion of the method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="n">ProcessType</span> <span class="k">for</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">process_detail_fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">dyn</span> <span class="n">Write</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">mpu_config</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">config</span><span class="o">|</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">writer</span><span class="p">.</span><span class="n">write_fmt</span><span class="p">(</span><span class="n">format_args</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">));</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That <em>looks</em> pretty simple (after all, its a a three line body).
But its still doing some relatively interesting stuff: there&rsquo;s that
<code>format_args!</code> macro in there, and a closure being constructed.</p>

<p>We might try to simplify the body further: turn the closure body into
the main body of <code>process_detail_fmt</code> itself.</p>

<p>The closure takes an input of type <code>config</code>; a quick inspect of the <code>map</code> method
shows that should have the same type as is fed into the <code>MapCell</code> here:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">mpu_config</span><span class="o">:</span> <span class="n">MapCell</span><span class="o">&lt;&lt;&lt;</span><span class="n">C</span> <span class="k">as</span> <span class="n">Chip</span><span class="o">&gt;::</span><span class="n">MPU</span> <span class="k">as</span> <span class="n">MPU</span><span class="o">&gt;::</span><span class="n">MpuConfig</span><span class="o">&gt;</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, we quickly discover that just moving the closure body into the <code>process_detail_fmt</code>
method is not a valid reduction. That is, I tried compiling with this definition instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="n">ProcessType</span> <span class="k">for</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">process_detail_fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">dyn</span> <span class="n">Write</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nb">None</span><span class="o">::&lt;&lt;&lt;</span><span class="n">C</span> <span class="k">as</span> <span class="n">Chip</span><span class="o">&gt;::</span><span class="n">MPU</span> <span class="k">as</span> <span class="n">MPU</span><span class="o">&gt;::</span><span class="n">MpuConfig</span><span class="o">&gt;</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">writer</span><span class="p">.</span><span class="n">write_fmt</span><span class="p">(</span><span class="n">format_args</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and got this ICE:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">error</span><span class="o">:</span> <span class="n">internal</span> <span class="n">compiler</span> <span class="n">error</span><span class="o">:</span> <span class="n">src</span><span class="o">/</span><span class="n">librustc</span><span class="o">/</span><span class="n">traits</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="kn">mod</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">53</span><span class="o">:</span> <span class="n">Encountered</span> <span class="n">error</span> <span class="err">`</span><span class="n">Unimplemented</span><span class="err">`</span> <span class="n">selecting</span> <span class="err">`</span><span class="n">Binder</span><span class="p">(</span><span class="o">&lt;</span><span class="p">()</span> <span class="k">as</span> <span class="n">core</span><span class="o">::</span><span class="n">fmt</span><span class="o">::</span><span class="n">Display</span><span class="o">&gt;</span><span class="p">)</span><span class="err">`</span> <span class="n">during</span> <span class="n">codegen</span>
</span></code></pre></td></tr></table></div></figure>


<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
When reduction uncovers a <em>different</em> bug, it is of course
good practice to record that distinct state of the test source code
somewhere. E.g. you could make a separate <code>git</code> branch for it, and come back to
later.
</span>
That is certainly a <em>similar</em> looking ICE. But if we want to be sure
about our reduction, we really need to see the <em>same</em> error: if we
don&rsquo;t see <code>[FulfillmentError(Obligation(...))]</code>, then we should not be
satisifed.</p>

<p>So, we apparently have to keep more of the original code from <code>process_detail_fmt</code>.</p>

<p>At this point we must note that <code>MapCell</code> is a type that <code>kernel</code> is pulling in
from another crate, <code>tock-cells</code>.</p>

<p>So we might need to go and modify code over in <code>tock-cells</code> if we want to fully reduce this code.</p>

<p>Or we might be able to get away with just copying its definition locally, avoiding the hassle of
the full process of reducing the <code>tock-cells</code> crate itself.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
themes: Eliminate Coupling, Identify the Unnecessary
</span></p>

<a name="Tactic:..Cut-spaghetti-imports."></a>
<h3>Tactic: &ldquo;Cut-spaghetti-imports&rdquo;</h3>

<p>This is pretty easy: If you&rsquo;ve <a href="#Tactic:..Body.Loopification.">&ldquo;loopified&rdquo;</a> most of your code, you can often
do this replacement.</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kn">use</span> <span class="p">...</span><span class="o">::</span><span class="n">Type</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">Type</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>or, if applicable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">type</span> <span class="n">Type</span> <span class="o">=</span> <span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you haven&rsquo;t done full <a href="#Tactic:..Body.Loopification.">&ldquo;loopification&rdquo;</a> everywhere (our situation), then you may need
to do this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">Type</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span> <span class="c1">// (adapt definition from elsewhere, potentially via cut-and-paste).</span>
</span><span class='line'><span class="k">impl</span> <span class="n">Type</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note: may need to add (potentially artificial) generic parameters, like so:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kn">use</span> <span class="p">...</span><span class="o">::</span><span class="n">Type</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">Type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;a</span> <span class="p">(),</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>or</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">type</span> <span class="n">Type</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;a</span> <span class="p">(),</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our case, we are going to <a href="https://github.com/pnkfelix/demo-minimization/commit/a01b629c084ca3a0baa8ba81d179451008f67c66">make a local version</a> of <code>tock_cells::MapCell</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">MapCell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">val</span><span class="o">:</span> <span class="n">core</span><span class="o">::</span><span class="n">cell</span><span class="o">::</span><span class="n">UnsafeCell</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">mem</span><span class="o">::</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">occupied</span><span class="o">:</span> <span class="n">Cell</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">MapCell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">is_some</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">occupied</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">closure</span><span class="o">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">where</span>
</span><span class='line'>        <span class="n">F</span><span class="o">:</span> <span class="n">FnOnce</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_some</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="bp">self</span><span class="p">.</span><span class="n">occupied</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">valref</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="p">};</span>
</span><span class='line'>            <span class="c1">// TODO: change to valref.get_mut() once stabilized [#53491](https://github.com/rust-lang/rust/issues/53491)</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">res</span> <span class="o">=</span> <span class="n">closure</span><span class="p">(</span><span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="n">valref</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">()</span> <span class="p">});</span>
</span><span class='line'>            <span class="bp">self</span><span class="p">.</span><span class="n">occupied</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">Some</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">None</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I got this by cut-and-pasting the definiton for <code>struct MapCell&lt;T&gt;</code> (and then fixing its types so I could avoid
adding use statements elsewhere), and then cut-and-pasting its <code>fn map</code> method, and finally cut-and-pasting
its <code>fn is_some</code> method after a compilation attempt said that was missing.</p>

<p>With that done, compilation continues to show the ICE.</p>

<p>If you <a href="#Tactic:..Body.Loopification.">&ldquo;loopify&rdquo;</a> the body of <code>MapCell::map</code>, the ICE goes away. There is something relevant inside there.</p>

<p>Some intelligent (as in, non-mechanical) <a href="#Tactic:..Expr-elimination.">&ldquo;expr-elimination&rdquo;</a> and <a href="#Technique:..None-defaulting.">&ldquo;none-defaulting&rdquo;</a>
gets <code>MapCell::map</code> down to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">MapCell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">closure</span><span class="o">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">where</span>
</span><span class='line'>        <span class="n">F</span><span class="o">:</span> <span class="n">FnOnce</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>            <span class="n">closure</span><span class="p">(</span><span class="nb">None</span><span class="o">::&lt;&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">.</span><span class="n">unwrap</span><span class="p">());</span>
</span><span class='line'>            <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compilation still shows the same ICE here, so we haven&rsquo;t lost anything yet.</p>

<p>And yet, this version of <code>map</code> does not use <code>self</code> at all!</p>

<p>This brings us to another kind of simplification: going from object methods to top-level functions.</p>

<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
themes: Identify the Unnecessary, Trivialize Content
</span></p>

<a name="Tactic:..Deobjectification."></a>
<h2>Tactic: &ldquo;Deobjectification&rdquo;</h2>

<p>The goal of &ldquo;deobjectification&rdquo; is to replace a method defined in an
<code>impl</code> with a top-level function.
Moving some necessary component for reproducing the bug out of the <code>impl</code>
can make the <code>impl</code> itself unnecessary, and thus removable.</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">X</span><span class="o">&gt;</span> <span class="n">Type</span><span class="o">&lt;</span><span class="n">X</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">:</span> <span class="o">---</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="o">---</span> <span class="p">}</span> <span class="c1">// where `---` does not use `Self`/`self`</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">top_foo</span><span class="o">&lt;</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="o">:</span> <span class="o">---</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="o">---</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our case, lets <a href="https://github.com/pnkfelix/demo-minimization/commit/4eb3e7ef3cb4737d23b5dc1b88ffba8a356d9230">try to pull</a> <code>MapCell::map</code> out of <code>MapCell</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- a/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ b/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -2577,6 +2577,13 @@ impl&lt;T&gt; MapCell&lt;T&gt; {</span>
</span><span class='line'>             loop { }
</span><span class='line'>     }
</span><span class='line'> }
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+fn mapcell_map&lt;T, F, R&gt;(closure: F) -&gt; Option&lt;R&gt; where F: FnOnce(&amp;mut T) -&gt; R</span>
</span><span class='line'><span class="gi">+{</span>
</span><span class='line'><span class="gi">+    closure(None::&lt;&amp;mut T&gt;.unwrap());</span>
</span><span class='line'><span class="gi">+    loop { }</span>
</span><span class='line'><span class="gi">+}</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'> use crate::common::{Queue, RingBuffer};
</span><span class='line'> use crate::mem::{AppSlice, Shared};
</span><span class='line'> use crate::platform::mpu::{self, MPU};
</span><span class='line'><span class="gu">@@ -2719,7 +2726,7 @@ pub struct Process&lt;&#39;a, C: &#39;static + Chip&gt; {</span>
</span><span class='line'>
</span><span class='line'> impl&lt;C: Chip&gt; ProcessType for Process&lt;&#39;a, C&gt; {
</span><span class='line'>     unsafe fn process_detail_fmt(&amp;self, writer: &amp;mut dyn Write) {
</span><span class='line'><span class="gd">-        self.mpu_config.map(|config| {</span>
</span><span class='line'><span class="gi">+        mapcell_map(|config: &amp;mut &lt;&lt;C as Chip&gt;::MPU as MPU&gt;::MpuConfig| {</span>
</span><span class='line'>             let _ = writer.write_fmt(format_args!(&quot;{}&quot;, config));
</span><span class='line'>         });
</span><span class='line'>     }
</span></code></pre></td></tr></table></div></figure>


<p>Success: compilation still ICE&rsquo;s in the same way.</p>

<p>And now that we&rsquo;ve remove the last uses of fields in <code>self</code> for <code>Process</code>, we can
simplify its definition considerably:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">struct</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">:</span> <span class="k">&#39;static</span> <span class="o">+</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'>    <span class="n">tasks</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="p">(),</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>(And that simplification lets us remove the <code>struct MapCell</code> we added a few steps ago,
since we no longer need it for the now-eliminated <code>mpu_config</code> field.)</p>

<p>So now we&rsquo;ve reduced all three methods to pretty simple bodies; we had
to add a fourth method (<code>mapcell_map</code>) in the process; but that method
was always there all along as part of the puzzle. It had just been
waiting for us in the upstream <code>tock-cells</code> crate.</p>

<p>Furthermore, we can apply <a href="#Technique:..Ret-elimination.">&ldquo;ret-elimination&rdquo;</a> to <code>mapcell_map</code>, both on the <code>fn mapcell_map</code> itself,
and on its closure argument:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- INDEX/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gi">+++ WORKDIR/tock/kernel/src/lib.rs</span>
</span><span class='line'><span class="gu">@@ -2564,10 +2564,9 @@ use core::{mem, ptr, slice, str};</span>
</span><span class='line'>
</span><span class='line'> use crate::callback::{AppId, CallbackId};
</span><span class='line'> use crate::capabilities::ProcessManagementCapability;
</span><span class='line'><span class="gd">-fn mapcell_map&lt;T, F, R&gt;(closure: F) -&gt; Option&lt;R&gt; where F: FnOnce(&amp;mut T) -&gt; R</span>
</span><span class='line'><span class="gi">+fn mapcell_map&lt;T, F&gt;(closure: F) where F: FnOnce(&amp;mut T)</span>
</span><span class='line'> {
</span><span class='line'>     closure(None::&lt;&amp;mut T&gt;.unwrap());
</span><span class='line'><span class="gd">-    loop { }</span>
</span><span class='line'> }
</span><span class='line'>
</span><span class='line'> use crate::common::{Queue, RingBuffer};
</span></code></pre></td></tr></table></div></figure>


<p>We have now gotten ourself down to the following core set of methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">mapcell_map</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">closure</span><span class="o">:</span> <span class="n">F</span><span class="p">)</span> <span class="n">where</span> <span class="n">F</span><span class="o">:</span> <span class="n">FnOnce</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">closure</span><span class="p">(</span><span class="nb">None</span><span class="o">::&lt;&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">.</span><span class="n">unwrap</span><span class="p">());</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">load_processes</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="n">Chip</span><span class="o">&gt;</span><span class="p">(</span><span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">)</span> <span class="p">{</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">Process</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">struct</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">:</span> <span class="k">&#39;static</span> <span class="o">+</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'>    <span class="n">tasks</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="p">(),</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">ProcessType</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">process_detail_fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">dyn</span> <span class="n">Write</span><span class="p">)</span> <span class="p">{</span> <span class="k">loop</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="n">ProcessType</span> <span class="k">for</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">process_detail_fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">dyn</span> <span class="n">Write</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mapcell_map</span><span class="p">(</span><span class="o">|</span><span class="n">config</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="o">&lt;&lt;</span><span class="n">C</span> <span class="k">as</span> <span class="n">Chip</span><span class="o">&gt;::</span><span class="n">MPU</span> <span class="k">as</span> <span class="n">MPU</span><span class="o">&gt;::</span><span class="n">MpuConfig</span><span class="o">|</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">writer</span><span class="p">.</span><span class="n">write_fmt</span><span class="p">(</span><span class="n">format_args</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">));</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="k">&#39;static</span> <span class="o">+</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[allow(clippy::cast_ptr_alignment)]</span>
</span><span class='line'>    <span class="n">crate</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">create</span><span class="p">(</span>
</span><span class='line'>        <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">dyn</span> <span class="n">ProcessType</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="k">mut</span> <span class="n">process</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Process</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nb">None</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">process</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><label for='' class='margin-toggle'>&#8853;</label><input type='checkbox' id='' class='margin-toggle'/><span class='marginnote'>
theme: Eliminate Coupling
</span></p>

<a name="Technique:..Ret-ascription."></a>
<h2>Technique: &ldquo;Ret-ascription&rdquo;</h2>

<p>We could further reduce <code>Process::create</code> a tiny bit: We <em>can</em> remove
its return type, as long as we ensure that the coercion implied by the
return type still happens in the code.</p>

<p>This is a variant on <a href="#Technique:..Ret-elimination.">&ldquo;ret-elimination&rdquo;</a>: we again want to remove the return type from
the <code>fn</code> signature, but this time we will <em>also</em> ensure that any coercions implied
by the return type still occur:</p>

<p>Change:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span> <span class="p">{</span> <span class="k">if</span> <span class="n">A</span> <span class="p">{</span> <span class="k">return</span> <span class="n">B</span><span class="p">;</span> <span class="p">}</span> <span class="n">TailReturn</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="o">----</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="n">A</span> <span class="p">{</span> <span class="kd">let</span> <span class="n">_</span><span class="o">:</span> <span class="n">ReturnType</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span> <span class="p">}</span> <span class="kd">let</span> <span class="n">_</span><span class="o">:</span> <span class="n">ReturnType</span> <span class="o">=</span> <span class="n">TailReturn</span><span class="p">;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For <code>Process::create</code>, this looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="k">&#39;static</span> <span class="o">+</span> <span class="n">Chip</span><span class="o">&gt;</span> <span class="n">Process</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[allow(clippy::cast_ptr_alignment)]</span>
</span><span class='line'>    <span class="n">crate</span> <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">create</span><span class="p">(</span>
</span><span class='line'>        <span class="n">chip</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">process</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Process</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nb">None</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">_</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">dyn</span> <span class="n">ProcessType</span> <span class="o">=</span> <span class="n">process</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And furthermore, we can apply <a href="#Tactic:..Deobjectification.">&ldquo;deobjectification&rdquo;</a> and
<a href="#Technique:..Param-elimination.">&ldquo;param-elimination&rdquo;</a> here; this method doesn&rsquo;t even have a <code>self</code>
parameter.</p>

<p>That <a href="https://github.com/pnkfelix/demo-minimization/commit/71c6e538854171b043b7628b15e4fe4f23a056a8">gets us here</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">load_processes</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="n">Chip</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">C</span><span class="p">)</span> <span class="p">{</span> <span class="n">process_create</span><span class="o">::&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">();</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">process_create</span><span class="o">&lt;</span><span class="n">C</span><span class="o">:</span> <span class="k">&#39;static</span> <span class="o">+</span> <span class="n">Chip</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">_</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="n">dyn</span> <span class="n">ProcessType</span> <span class="o">=</span> <span class="nb">None</span><span class="o">::&lt;&amp;</span><span class="k">mut</span> <span class="n">Process</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;&gt;</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Take.a.breath"></a>
<h1>Take a breath</h1>

<p>Now that all of the involved methods seem relatively small, this seems like a good
time to take a breath.</p>

<p>At this point, we could try to take these pieces and build-up a new
example from scratch, preserving the core elements identified above.
That&rsquo;s not a bad idea at all, at this point; it could be worth
spending a half-hour or so on. Either building up an example from scratch
will work, or it won&rsquo;t. Let&rsquo;s assume for now that we are not able to jump
to a minimal example, even with the pieces we have identified as core to the problem
up above?</p>

<p>What now?</p>

<p>We could attempt to remove large swaths of code from the example as it stands:
After all, we know we just need these methods; can we just comment everything else out?</p>

<p>Well, no. You can&rsquo;t just comment random things out.
The interdependencies in
the crate graph will frustrate attempts to do so.</p>

<p>For example, I tried commenting out
most of the code after the <code>mod process { ... }</code>, in the <code>lib.rs</code>, and
got a slew of &ldquo;unresolved import&rdquo; errors. So, if you want to continue
reducing this exmaple, we need to do it in a more directed fashion.</p>

<p>In the interest of trying to follow a semi-mindless process here, lets look at what we
need to do in order to really minimize <code>kernel</code> to its core:</p>

<ol>
<li><p>We have to finish minimizing the leaves. There are crates unrelated to the ICE still
being pulled into the build here, and they rely on things in <code>kernel</code> that we will
not be able to remove until those crates are themselves reduced or otherwise eliminated
from the crate graph.</p>

<p>For us, we can apply some of the other techniques we have learned about to the leaf
crates, such as using <a href="#Technique:..None-defaulting.">&ldquo;none-defaulting&rdquo;</a> to create an instance of <code>arty_e21::chip::ArtyExx</code>
in <code>board/argy-e21/main.rs</code>.</p></li>
<li><p>We have to reducing the coupling within <code>kernel</code> itself. It can be maddening
trying to comment out modules at random. When that madness becomes too much for me,
I force myself to adopt a more disciplined
approach: I use the <a href="#Tactic:..Cut-spaghetti-imports.">&ldquo;cut-spaghetti-imports&rdquo;</a> tactic to replace the existing <code>use</code> imports
with local definitions. (Remember: since most <code>fn</code>-items in every module are
<a href="#Tactic:..Body.Loopification.">&ldquo;loopified&rdquo;</a>, the <a href="#Tactic:..Cut-spaghetti-imports.">&ldquo;cut-spaghetti-imports&rdquo;</a> tactic will work fairly often.</p></li>
<li><p>This goes hand-in-hand with the general point above about reducing coupling within <code>kernel</code>:
We have to finish mimimizing <code>mod process { ... }</code> itself within <code>kernel</code>.
All of the interesting functions for reproducing the bug live there, so we know
we cannot <a href="#Technique:..Cfgments.">&ldquo;cfgment&rdquo;</a> out that module for now. But if we have to keep <code>mod process</code>,
we won&rsquo;t be able to remove the other modules until we remove the dependencies that
it has on those modules.</p></li>
</ol>


<p>I hope to return to this richly-documented minimization of <a href="https://github.com/rust-lang/rust/issues/65774">rust-lang/rust#65774</a> the future;
and when I do, I hope to cover all three of the points above.</p>

<p>But for now, I hope this was a helpful tour of various minimization
technique that you can employ for reducing ICEs and other static
analysis bugs in <code>rustc</code>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Felix S. Klock II</span></span>

      








  


<time datetime="2019-11-18T11:19:46+01:00" pubdate data-updated="true"></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/" data-via="pnkfelix" data-counturl="http://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2019/06/26/breaking-news-non-lexical-lifetimes-arrives-for-everyone/" title="Previous Post: Breaking News: Non-Lexical Lifetimes arrives for everyone">&laquo; Breaking News: Non-Lexical Lifetimes arrives for everyone</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/11/18/rust-bug-minimization-patterns/">Rust Bug Minimization Patterns</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/26/breaking-news-non-lexical-lifetimes-arrives-for-everyone/">Breaking News: Non-Lexical Lifetimes arrives for everyone</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/01/gc-and-rust-part-2-roots-of-the-problem/">GC and Rust Part 2: The Roots of the Problem</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/19/signatures-and-surfaces-thoughts-on-privacy-versus-dependency/">Surfaces and Signatures: Component Privacy versus Dependence</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/18/fixing-octopress-table-rendering/">Fixing Octopress Table Rendering</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/pnkfelix">@pnkfelix</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pnkfelix',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/pnkfelix?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/pnkfelix">My Delicious Bookmarks &raquo;</a></p>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/pnkfelix?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Felix S. Klock II -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'pnkfx-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/';
        var disqus_url = 'http://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
