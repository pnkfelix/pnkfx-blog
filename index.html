
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The {pnk}f(eli)x Blog</title>
  <meta name="author" content="Felix S. Klock II">

  
  <meta name="description" content="Background Encoding via parameters is unpalatable Rust-specific issues Niko&#39;s blog posts
Simpler syntax: What about binding? Insight
The &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.pnkfx.org/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="The {pnk}f(eli)x Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The {pnk}f(eli)x Blog</a></h1>
  
    <h2>The informal ramblings of an ex-pat PL enthusiast</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.pnkfx.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/22/designing-syntax-for-associated-items-in-rust/">Designing Syntax for Associated Items in Rust</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-22T14:37:00+02:00" pubdate data-updated="true">22 April 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li><a href="#background">Background</a>

<ul>
<li><a href="#encodingunpalatable">Encoding via parameters is unpalatable</a></li>
</ul></li>
<li><a href="#rustspec">Rust-specific issues</a>

<ul>
<li><a href="#nikoposts">Niko&#39;s blog posts</a></li>
<li><a href="#thinkbinding">Simpler syntax: What about binding?</a></li>
</ul></li>
<li><a href="#insight">Insight</a></li>
<li><a href="#proposal">The proposed syntax for associated items in Rust</a></li>
<li><a href="#futurework">What the proposal does not cover</a></li>
</ul>

<p>Executive summary: if you don&#39;t want or need the background information
or the discussion motivating the proposal, then just jump
straight to the <a href="#proposal">proposal</a> itself.</p>

<h2><a id="background">Background</a></h2>

<p>Early in my experimentation with Rust, I thought a reasonable exercise
would be to take the simple C++ programs from
<a href="http://www.elementsofprogramming.com/">Elements of Programming</a> (Stepanov and McJones), which make heavy yet
disciplined use of abstraction and C++ templates to encode various
mathematical concepts.  The early chapters of the book use templates
rather than classes as the means of code reuse, so translating those
examples seemed like a good way to exercise Rust&#39;s generic type and
trait systems.</p>

<p>However, almost immediately after starting the experiment, I encountered
a problem: code that makes heavy use of C++ templates is quite likely
to use particular features of C++ templates that are not a universal
part of another language&#39;s generic type system.</p>

<p>In particular, the code from Elements of Programming (hereby
abbreviated &quot;EOP&quot; in this post) almost immediately makes use of
&quot;associated types&quot;, such as in the following definition for <code>distance</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">requires</span><span class="p">(</span><span class="n">Transformation</span><span class="p">(</span><span class="n">F</span><span class="p">))</span>
</span><span class='line'><span class="n">DistanceType</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="n">distance</span><span class="p">(</span><span class="n">Domain</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="n">Domain</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="n">y</span><span class="p">,</span> <span class="n">F</span> <span class="n">f</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Precondition: $y$ is reachable from $x$ under $f$</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">DistanceType</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="n">N</span><span class="p">;</span>
</span><span class='line'>    <span class="n">N</span> <span class="n">n</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">N</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>The interesting thing about the above code is that it is parameterized
over one type: <nobr><code>F</code>,</nobr> but it uses other type expressions within the body
of the procedure, namely:</p>

<ul>
<li><p><code>Domain(F)</code>: this is a <code>type -&gt; type</code> operator that, given a
Transformation (which we can think of as some type classifying a
set of <code>T -&gt; T</code> functions for some type <code>T</code>), returns <code>T</code>.</p></li>
<li><p><code>DistanceType(F)</code>: this is a <code>type -&gt; type</code> operator that, given a
Transformation, returns a numeric type (think <code>uint8_t</code>,
<code>uint32_t</code>, <code>uintptr_t</code>, <code>BigNum</code>, etc) suitable for counting the
minimum number of applications of the transformation necessary to
get from any particular <code>T</code> value to some other <code>T</code> value.</p></li>
</ul>

<p>(Operators like <code>DistanceType</code>, to my mind, only makes sense when you
 look at things simultaneously in terms of bytes of memory in the
 machine and also in terms of pure abstract mathematical values.  If
 you omit either perspective, then the operator appears either
 pointless or nonsensical.)</p>

<p>It also requires that <code>F</code> obeys a constraint, specified in the
<code>requires</code> clause; I am going to conveniently ignore this detail for
now.  (The C++ code for EOP even macro-expands <code>requires(..)</code> into whitespace,
so treating them as helpful comments for the time being is not absurd.)</p>

<p>Type expressions like <code>triple&lt;A, B, C&gt;</code> (assuming three type expressions
<code>A</code>, <code>B</code>, and <code>C</code>), are the bread-and-butter of any generic type
system.  But these <code>type -&gt; type</code> operators are interesting.  How are
they implemented?  Here is a snippet from <code>type_functions.h</code> in the
EOP source code distribution:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">requires</span><span class="p">(</span><span class="n">Transformation</span><span class="p">(</span><span class="n">F</span><span class="p">))</span>
</span><span class='line'><span class="k">struct</span> <span class="n">distance_type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// If all transformations on a type T have the same distance type,</span>
</span><span class='line'><span class="c1">// then DistanceType(T) is defined and returns that type.</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// For any fixed-size type T, there is an integral type of the same</span>
</span><span class='line'><span class="c1">// size that is a valid distance type for T.</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define DistanceType(T) typename distance_type&lt; T &gt;::type</span>
</span></code></pre></td></tr></table></div></figure>

<p>This code is making use of a C-style macro to define a easy-to-read
interface for the <code>DistanceType</code> operator (the subset of C++ used
for EOP&#39;s textbook examples is meant to be LL(1)), but the implementation
of the operator is using C++&#39;s template system to define a partial
mapping from types to (integral) types.  One can add new entries to
this mapping by defining a new template instantiation of
<code>struct distance_type&lt;F&gt;</code>, as illustrated in <code>tests.h</code> for the following
transformation <code>gen_orbit</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">I</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">requires</span><span class="p">(</span><span class="n">Integer</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">Integer</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">DistanceType</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="n">N</span><span class="p">)</span>
</span><span class='line'><span class="k">struct</span> <span class="n">gen_orbit</span> <span class="c1">// transformation</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">gen_orbit_predicate</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>    <span class="n">gen_orbit</span><span class="p">(</span><span class="n">I</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">N</span> <span class="n">h</span><span class="p">,</span> <span class="n">N</span> <span class="n">c</span><span class="p">)</span> <span class="o">:</span> <span class="n">p</span><span class="p">(</span><span class="n">x_0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Precondition: h &lt; N(MaximumValue(I)) &amp;&amp; c &lt; N(MaximumValue(I))</span>
</span><span class='line'>        <span class="c1">// Precondition: !negative(h) &amp;&amp; !negative(c)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">I</span> <span class="k">operator</span><span class="p">()</span> <span class="p">(</span><span class="n">I</span> <span class="n">x</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Assert</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
</span><span class='line'>        <span class="n">x</span> <span class="o">=</span> <span class="n">successor</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">p</span><span class="p">.</span><span class="n">x_0</span> <span class="o">+</span> <span class="n">I</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="n">I</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">c</span><span class="p">))</span> <span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">x_0</span> <span class="o">+</span> <span class="n">I</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">h</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">I</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">requires</span><span class="p">(</span><span class="n">Integer</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">Integer</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">DistanceType</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="n">N</span><span class="p">)</span>
</span><span class='line'><span class="k">struct</span> <span class="n">distance_type</span><span class="o">&lt;</span> <span class="n">gen_orbit</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">N</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>

<p>Thus, the definition of <code>gen_orbit</code> (including its instantiation of
<code>distance_type</code>) collaborates with the definition of <code>DistanceType</code> to
indicate that <code>DistanceType(gen_orbit&lt;I, N&gt;)</code> is <code>N</code>.  As one adds new
structs (classes) representing other transformations, one is expected
to instantiate <code>distance_type</code> (as well as a host of other
template-abstracted structs) accordingly.</p>

<hr>

<p>So, what&#39;s the problem here?  Well, Rust, much like Java, does not
provide a way to define general <code>type -&gt; type</code> mappings like
<code>DistanceType(F)</code>.</p>

<p>One can try to work around this via a code transformation and lift any
type of interest up to a generic class&#39;s parameter list, like this
example in Rust:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">trait</span> <span class="n">Transformation</span><span class="o">&lt;</span><span class="n">DISTANCETYPE</span><span class="p">,</span> <span class="n">DOMAIN</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">apply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">,</span> <span class="n">elem</span><span class="o">:</span> <span class="n">DOMAIN</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DOMAIN</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
or if you prefer Java:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">interface</span> <span class="nc">Transformation</span><span class="o">&lt;</span><span class="n">DISTANCETYPE</span><span class="o">,</span> <span class="n">DOMAIN</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">DOMAIN</span> <span class="nf">apply</span><span class="o">(</span><span class="n">DOMAIN</span> <span class="n">elem</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>At first glance, one might think this does not look so bad; after all,
the <code>gen_orbit</code> struct similarly was parameterized over a domain <code>I</code>
and a distance type <code>N</code>.  However, the problem comes when one
then attempts to write a function like distance:</p>

<p>Rust:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">distance</span><span class="o">&lt;</span><span class="n">F</span><span class="o">:</span> <span class="n">Transformation</span><span class="o">&lt;</span><span class="n">DT</span><span class="p">,</span> <span class="n">DOM</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="o">:</span> <span class="o">???</span><span class="p">,</span> <span class="n">y</span><span class="o">:</span> <span class="o">???</span><span class="p">,</span> <span class="n">f</span><span class="o">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">???</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/* ... */</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Java:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">F</span> <span class="kd">extends</span> <span class="n">Transformation</span><span class="o">&lt;</span><span class="n">DT</span><span class="o">,</span> <span class="n">DOM</span><span class="o">&gt;</span> <span class="o">???</span> <span class="n">distance</span><span class="o">(???</span> <span class="n">x</span><span class="o">,</span> <span class="o">???</span> <span class="n">y</span><span class="o">,</span> <span class="n">F</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="cm">/* ... */</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>What do we put in for the <code>???</code> portions?  We already established that
we do not have general <code>type -&gt; type</code> operators, so we cannot just
derive it form <code>F</code>.  And for that matter, where did <code>DT</code> and <code>DOM</code>
come from?  In Rust and Java, we cannot just make up fresh type
variables and then add constraints upon them after the fact.  The only
option is to make any type we wish to use an additional type parameter
to the generic method.</p>

<p>Rust:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">distance</span><span class="o">&lt;</span><span class="n">DT</span><span class="p">,</span> <span class="n">DOM</span><span class="p">,</span> <span class="n">F</span><span class="o">:</span> <span class="n">Transformation</span><span class="o">&lt;</span><span class="n">DT</span><span class="p">,</span> <span class="n">DOM</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="o">:</span> <span class="n">DOM</span><span class="p">,</span> <span class="n">y</span><span class="o">:</span> <span class="n">DOM</span><span class="p">,</span> <span class="n">f</span><span class="o">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DT</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/* ... */</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Java:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">DT</span><span class="o">,</span> <span class="n">DOM</span><span class="o">,</span> <span class="n">F</span> <span class="kd">extends</span> <span class="n">Transformation</span><span class="o">&lt;</span><span class="n">DT</span><span class="o">,</span> <span class="n">DOM</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span><span class='line'>    <span class="n">DT</span> <span class="nf">distance</span><span class="o">(</span><span class="n">DOM</span> <span class="n">x</span><span class="o">,</span> <span class="n">DOM</span> <span class="n">y</span><span class="o">,</span> <span class="n">F</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="cm">/* ... */</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<h3><a id="encodingunpalatable">Encoding via parameters is unpalatable</a></h3>

<p>The Rust and Java results above are made barely readable by using
short (obscure) parameter names.  More troubling is the fact that this
pollution of the parameter list will bubble transitively backwards
through the callers of <code>distance</code> until we reach the point where <code>F</code>
is instantiated.  Any use of <code>Transformation</code> needs to be
parameterized in the same manner.</p>

<p>It also makes explicit instantiation of a parameterized method or
class quite painful.  (This pain is somewhat alleviated in the
presence of type-inference, at least in terms of what text ends up in
the final code, but I argue that that in this case the pain has in
fact been <em>shifted</em>: instead of having pain while reading the code,
one instead suffers when trying to wade through type-errors that
inevitably arise during the compile-edit cycle.)</p>

<p>If anything, the above presentation <em>understates</em> the problem, since:</p>

<ol>
<li><code>Transformation</code> has only one argument in its domain, and its codomain
 is the same as its domain; many real traits with associated types
 are each likely to require multiple parameters.</li>
<li>The above example has direct uses of <code>DOM</code> and <code>DT</code> in the domain
 and codomain, respectively, of <code>distance</code>.  However, <em>every</em> client
 of <code>Transformation</code> will be forced to be parameterized over <code>DOM</code>
 and <code>DT</code>; while it is likely that any client of <code>Transformation</code> is likely
 to need to refer to the type <code>DOM</code>, many are likely to not require
 use of the distance type <code>DT</code> in their public interface or even in
 the internals of their code.  Thus, our abstraction is not very abstract
 at all.</li>
<li>As a follow-on to the previous point: We are only illustrating
 <em>one</em> added concept: <code>DistanceType</code>; each additional concept
 would require a new type parameter to be threaded through the
 parameter lists of all methods and classes.  This blows up to an
 unmaintainable mess fairly quickly, discouraging use of generics
 to define these abstractions (and instead relying on
 e.g. separate class-hierarchies).</li>
</ol>

<hr>

<h2><a id="rustspec">Rust-specific issues</a></h2>

<p>I encountered this problem while porting EOP code to Rust.  After
wrestling with the type parameter lists for a while, I eventually
wised up and asked on the #rust IRC channel if there was a better
option.  Tim Chevalier informed me of the relevant terminology:
the feature I want is called &quot;associated types access&quot; (or often just
&quot;associated types&quot;).
An associated type specifies a mapping from some type to another type.</p>

<p>&quot;Associated type access&quot; is listed as one of eight properties considered important in
&quot;<a href="http://osl.iu.edu/publications/prints/2003/comparing_generic_programming03.pdf">A comparative study of language support for generic programming</a>&quot;
(Garcia et al., 2003 <a href="http://dl.acm.org/citation.cfm?id=949317">ACM</a>).
If you found <a href="#encodingunpalatable">the argument above</a> unconvincing,
you should read the Garcia paper for a completely different example motivated by
a Graph abstraction.</p>

<p>After I read the Garcia paper, I promptly filed <a href="https://github.com/mozilla/rust/issues/5033">an RFC</a> on the
Rust github repository requesting support for Associated Type
Synonyms.  After this, I had several discussions with Niko Matsakis,
both over IRC and in person, on the problems that associated types
present for Rust.</p>

<h3><a id="nikoposts">Niko&#39;s blog posts</a></h3>

<p>You can see Niko&#39;s thorough overview of the matter,
including his natural generalization of the topic from &quot;associated
types&quot; to &quot;associated <em>items</em>&quot;, on his pair of blog posts (<a href="http://www.smallcultfollowing.com/babysteps/blog/2013/04/02/associated-items/">part
I</a>, <a href="http://www.smallcultfollowing.com/babysteps/blog/2013/04/03/associated-items-continued/">part II</a>).  The generalization to &quot;associated items&quot;
enables one to define, in addition to <code>type -&gt; type</code> mappings as
illustrated <a href="#background">above</a>, also <code>type -&gt; function</code>
mappings (called in some languages &quot;static&quot; functions) and <code>type -&gt;
(constant) value</code> mappings, which may enable certain interesting
coding patterns, such as allowing a type representing a vector in a
multi-dimensional space to state, statically, how many dimensions
it carries.</p>

<p>The following are the specific points that Niko makes in his posts (some of 
are just pointing out artifacts of current Rust language syntax).</p>

<h3>Current Rust syntax focuses on deriving associated functions from traits</h3>

<p>Rust does not currently offer general associated items, but it does
offer a kind of associated function access.</p>

<p>If a trait <code>T</code> defines a function <code>f</code> that returns <code>Self</code> (which means
that implementations of <code>T</code> are obligated to provide an implementation
of <code>f</code>), and one has a type <code>X</code> implementing that trait, then one can
derive <code>f</code>.</p>

<p>But in current Rust syntax, one does not write this derivation of <code>f</code>
as something attached to the type <code>X</code>; instead, one writes <code>T::f(..)</code>,
and the compiler is responsible for inferring which implementation of
the function <code>f</code> one is referring to, by using type-inference on the
context of the invocation <code>T::f(..)</code> to determine that the return type
of <code>f</code> must be <code>X</code> (and thus the <code>f</code> in question must be the one that
the type <code>X</code> implements to satisfy the obligation established by the
trait <code>T</code>).</p>

<h4><a id="nikoenctt1">Resolving ambiguities in general implies you need both the trait and type</a></h4>

<p>The choice of deriving a function&#39;s implementation from the trait
rather than the type is understandable when one considers that a
software system may have multiple traits <code>T</code>, <code>U</code>, <code>V</code>, &#8230; that all
define a function of the same name (say <code>f</code>), and a type may be
specified as implementing more than one of these traits in a single
piece of code.  (It would be anti-modular to require every trait to
choose globally unique names for its set of associated functions).  So
to handle this case, one must provide some way to disambiguate which
<code>f</code> is being referenced.  Rust did so by making the trait expression
part of the invocation syntax.  Niko points out that if one switches
to a syntax where one derives <code>f</code> from the type
<code>X</code> (e.g. <nobr>&quot;<code>X::f</code>&quot;</nobr>) then one must tackle this problem in
some manner; in his first blog post, he suggests doing so by allowing
one to encode both the type and the trait in the referencing syntax
(e.g. <nobr>&quot;<code>X::(T::f)</code>&quot;</nobr> or <nobr>&quot;<code>X::(U::f)</code>&quot;</nobr>.</p>

<p>I dislike this syntax because I think it
would be confusing for a reader to comprehend the distinct roles of
the <nobr>&quot;<code>::</code>&quot;</nobr> path operator, both when learning the language
and when casually skimming Rust code in general.</p>

<h4>Rust type expressions do not naturally fit into Rust path expressions</h4>

<p>Niko also points out that when one wants to write <code>X::f</code> where <code>X</code> is
a type, it is not always the case that <code>X</code> is a type parameter; it
could be a concrete type known to the programmer, such as the type of
owned vecs of ints, denoted by the type expression
<nobr><code>~[int]</code>.</nobr> So it seems natural to want to substitute such
a type expression for (the meta-variable) <code>X</code>.</p>

<p>But the syntax <code>~[int]::f</code> is not legal, because <code>~[int]</code> is
not a legitimate path component.  Niko describes a couple of
work-arounds, e.g. allowing one to wrap a type expression that appears
in a path expression with brackets, yielding: <code>&lt;~[int]&gt;::f</code>.</p>

<p>All of the work-arounds presented by Niko do require allowing
arbitrary type-expressions in some form to appear as a sub-expression,
which would complicate the parser in the Rust compiler (there has been
a slight push to try to <em>simplify</em> the path expression syntax, which
this would conflict with).</p>

<h4>Further syntactic exploration of encoding trait and type</h4>

<p>In his second blog post, Niko provides some alternative syntactic forms
for resolution:</p>

<ul>
<li><p><code>X::(T::f)</code>, as described <a href="#nikoenctt1">above</a>.</p></li>
<li><p><code>T::f::&lt;X&gt;</code> (from &quot;Functional-style name resolution (take 1)&quot;); here
<code>X</code> is a synthetic type parameter added to the type parameter list
(if any) of <code>f</code>; so now we get to retain syntactic backwards
compatibility.  Since Rust allows one to omit the explicit type
instantiation <code>::&lt;X, ...&gt;</code> when the compiler is able to infer
the instantiation, this would be a natural way to continue
doing return-type based inference of the desired type, the way
it does already.</p></li>
<li><p><code>T::f::&lt;for X&gt;</code> as a way of distinguishing the synthetic parameter
from other entries on the parameter list.</p></li>
</ul>

<p>I have already stated my problems with the first option.</p>

<p>For the second option, I anticipate being personally confused by the
synthetic type parameter being injected into the type parameter list.
I understand the appeal of enabling the compiler to continue doing
heavy lifting and lighten the programmers syntactic load.  <a href="http://www.smallcultfollowing.com/babysteps/blog/2013/04/03/associated-items-continued/">Niko&#39;s
post</a> does a good job of laying out some of the unexpected
interactions of the synthetic type parameter with the other forms of
generic type parameterization.</p>

<p>The third option would reduce confusion somewhat, since the
synthetic parameter would receive special attention at points of type
instantiation, but I still think it is an abuse of the parameter list.</p>

<h3><a id="thinkbinding">Simpler syntax: What about binding?</a></h3>

<p>So I set about trying to come up with another syntactic form
for associated item access.  My primary focus initially was:
all of these examples would be so much simpler, to my mind,
if we were able to go back to using a single identifier
for the relevant path component in the referencing form,
the way that C++ uses <nobr><code>C::f</code>.</nobr>
How can Rust make its own analogous <nobr><code>R::f</code></nobr> (the &quot;R&quot; is for Rust).</p>

<p>Of course, we have already covered that this will be ambiguous if
<code>R</code> is a mere type (and it is of course ambiguous if <code>R</code> is just a trait).</p>

<p>But what if <code>R</code> is a way of referring to the type <code>X</code> and the trait <code>T</code>
together: the (type, trait) pairing (X,T)?  Clearly once one specifies the
pair, then it is easy to tell what items are associated with the pair.
Even a human without a sophisticated IDE would know in that case to try
invoking <code>grep</code>, searching for <code>impl T.* for X.*</code>; a compiler can do even better.</p>

<p>Another way of looking at this: What if we could introduce local names
for the impl that corresponds to the (type, trait) pairing.</p>

<p>So I started working on ideas all centering around a declaration
form like <code>let R = trait T for type X;</code> or <code>use impl R = T for X</code>
and other variations (I think Patrick Walton actually deserves credit
for that last one; we will revisit it later).  But Niko quickly pointed
the huge failing of all of these declaration forms: a very common
use case for associated <em>types</em> (remember, that was our original goal)
is for function signatures, like:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">distance</span><span class="o">&lt;</span><span class="n">F</span><span class="o">:</span> <span class="n">Transformation</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="o">:</span> <span class="n">Domain</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">y</span><span class="o">:</span> <span class="n">Domain</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">f</span><span class="o">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DistanceType</span><span class="p">(</span><span class="n">F</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">remove_edge</span><span class="o">&lt;</span><span class="n">G</span><span class="o">:</span> <span class="n">IncidenceGraph</span> <span class="o">+</span> <span class="n">EdgeCollection</span><span class="o">&gt;</span><span class="p">(</span><span class="n">g</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">G</span><span class="p">,</span> <span class="n">e</span><span class="o">:</span> <span class="n">Edge</span><span class="p">(</span><span class="n">G</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>
where <code>Domain(F)</code>, <code>DistanceType(F)</code>, and <code>Edge(G)</code> are replaced
with appropriately Rust-friendly syntactic forms.  There is no <em>place</em>
there to put a declaration form <code>let ...</code> or <code>use ...</code> that refers to
<code>F</code>.  The same applies for other parameterized forms, such as structs,
enums, and traits.</p>

<p>So, back to the drawing board.</p>

<hr>

<h2><a id="insight">An Insight</a></h2>

<p>Even though my attempt to solve this problem via a declaration form had
failed, I continued to focus on the fact that associated item access
is all about the (type, trait) pairing.  So how could I surmount the
parameterized signature wall?</p>

<p>After reflecting on the parameterized signature itself, I said, &quot;where
is a natural place to put a binding from an identifier to a (type,
trait) pair?&quot;  And this reduced to &quot;where does the (type, trait) pair
come from?&quot;  This was my insight: The parameterized signature
<nobr><code>&lt;X: T&gt;</code></nobr> <em>itself</em> is where the pairing is defined;
(or in the case of <nobr><code>&lt;X: T + U&gt;</code></nobr>: <em>pairings</em>).</p>

<p>My only problem was to put the identifier binding in there.  Once I
saw the pairing waiting right in the parameter list, the place for the
identifier became clear: in-between the type and the trait:
<nobr><code>&lt;X: R=T&gt;</code></nobr> binds <code>R</code> to the <code>impl T for X</code>;
for multiple traits, we have <nobr><code>&lt;X: R=T + R2=U&gt;</code></nobr>,
where <code>R</code> is bound as above, and <code>R2</code> is bound to the <code>impl U for X</code>.</p>

<p>And now we can consider writing our examples like so:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">distance</span><span class="o">&lt;</span><span class="n">F</span><span class="o">:</span> <span class="n">T</span><span class="o">=</span><span class="n">Transformation</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="o">:</span> <span class="n">T</span><span class="o">::</span><span class="n">Domain</span><span class="p">,</span> <span class="n">y</span><span class="o">:</span> <span class="n">T</span><span class="o">::</span><span class="n">Domain</span><span class="p">,</span> <span class="n">f</span><span class="o">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="o">::</span><span class="n">DistanceType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">remove_edge</span><span class="o">&lt;</span><span class="n">G</span><span class="o">:</span> <span class="n">IncidenceGraph</span> <span class="o">+</span> <span class="n">EC</span><span class="o">=</span><span class="n">EdgeCollection</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">g</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">G</span><span class="p">,</span> <span class="n">e</span><span class="o">:</span> <span class="n">EC</span><span class="o">::</span><span class="n">Edge</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The other cute insight is this: the only time we need to add these
identifiers explicitly is when there are multiple trait bounds.
When there is a single trait bound <nobr><code>&lt;X:R=T&gt;</code></nobr>, the
identifier <code>X</code> is just as reasonable (or at least unambiguous) as <code>R</code>
is as a way to reference the impl.  So why not treat
<nobr><code>&lt;X:T&gt;</code></nobr> as an abbreviation for <nobr><code>&lt;X:X=T&gt;</code></nobr>:
boom!  The biggest potential complaint with this extension (namely,
the notational complexity of making people pepper their code with
explicit bindings of the impls) goes away!  And our first example becomes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">distance</span><span class="o">&lt;</span><span class="n">F</span><span class="o">:</span> <span class="n">Transformation</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="o">:</span> <span class="n">F</span><span class="o">::</span><span class="n">Domain</span><span class="p">,</span> <span class="n">y</span><span class="o">:</span> <span class="n">F</span><span class="o">::</span><span class="n">Domain</span><span class="p">,</span> <span class="n">f</span><span class="o">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">F</span><span class="o">::</span><span class="n">DistanceType</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>

<p>(our second example remains unchanged, since <code>G</code> has two trait bounds there, and
so <code>G</code> alone cannot unambiguously denote a (type, trait) pair.</p>

<p>Note also that this binding form does not suffice on its own; in
particular, if one wants to introduce a binding for a (type,trait)
pairing that does not appear in the generic parameter bounds of the
signature.  But the latter is exactly the case that <em>is</em> handled by a
declaration form such as those <a href="#thinkbinding">proposed earlier</a>!</p>

<p>So neither solution suffices on its own, but the two together cover
many use cases of interest.</p>

<hr>

<h2><a id="proposal">The proposed syntax for associated items in Rust</a></h2>

<p>So, with that insight explained, here is my proposal for associated items:</p>

<ol>
<li><p>A trait can now declare names for things besides methods.
 In terms of the grammar that John has been working on:</p>
<div class="highlight"><pre><code class="text"> trait_decl: TRAIT ident
                (generic_decls)? (COLON trait_list)?
                LBRACE trait_method* RBRACE ;
</code></pre></div>
<p>is replaced with</p>
<div class="highlight"><pre><code class="text"> trait_decl: TRAIT ident
                (generic_decls)? (COLON trait_list)?
                LBRACE trait_item* RBRACE ;
 trait_item: trait_method | trait_constant | trait_type
 trait_type: TYPE ident (generic_decls)? SEMI
           | TYPE ident (generic_decls)? COLON boundseq SEMI ;
 trait_const: STATIC ident COLON ty SEMI ;
</code></pre></div></li>
<li><p>The identifier bound by a trait types is in scope of its enclosing
 trait; trait method declarations and trait const declarations
 can reference it.</p></li>
<li><p>Extend the Rust grammar to allow an optional binding of
 an identifier to a (type, trait) pair in a type parameter bound.
 In terms of the grammar:</p>
<div class="highlight"><pre><code class="text"> bound : STATIC_LIFETIME | trait | obsoletekind ;
</code></pre></div>
<p>is replaced with:</p>
<div class="highlight"><pre><code class="text"> bound : STATIC_LIFETIME | trait | ident = trait | obsoletekind ;
</code></pre></div></li>
<li><p>Extend the Rust grammar to allow a declaration binding 
 an identifier to a (type, trait) pair.
 In terms of the grammar, I <em>think</em> this is close to what I want:</p>
<div class="highlight"><pre><code class="text"> view_item : attrs_vis use ;
</code></pre></div>
<p>is replaced with:</p>
<div class="highlight"><pre><code class="text"> view_item : attrs_vis use | USE impl ident = trait for ty ;
</code></pre></div>
<p>Of potential interest, we do not allow visibility attributes
 on <code>use impl R = T for X;</code>, because these definitions are always
 local shorthands and thus private to the module.  (Maybe in
 the future we will see motivation to allow the bindings to
 be exposed, but I have not yet seen a motivation for this.)</p>

<p>I am not attached to the particulars of the syntax above;
 in particular, if someone wants to throw in the <code>trait</code>
 and/or <code>type</code> keywords into the above to make the purpose
 all the more clear, I will not object.  More so if it is
 somehow <em>necessary</em> for disambiguation, but I do not
 anticipate that being the case.</p></li>
<li><p>A bound of the form <code>R=T</code> (<code>ident = ty</code>) in the context of a <code>ty_param</code>
 production <code>X : ... [] ...</code> (<code>ident COLON bound + ... + [] + ... + bound</code>)
 (where <code>[]</code> denotes the contextual hole that the <code>R=T</code> is plugged into)
 is treated as binding <code>R</code> to the code defined by the <code>impl T for X</code>.
 The scope of the binding for <code>R</code> encompasses: the rest of the boundseq
 (to the right of the <nobr><code>&quot;R=T&quot;</code></nobr>) and the remainder of this decl
 that follows the generic_decls within which the <nobr><code>R=T</code></nobr> bound appears.</p></li>
<li><p>This binding of <code>R</code> can shadow earlier bindings of the same identifier
 (either other impl-bindings, or module names).  It seems like this
 should be a reasonable thing to signal via a lint-warning.</p></li>
<li><p>A path identifier component can now be an <code>R</code>, binding an <code>impl T for X</code>.</p>

<p>So one can access trait items (see trait_item above) as R::item.
 Associated items can be type-parametric whenever the corresponding
 item could be type-parameteric when exported from a module.</p></li>
<li><p>A boundseq with a single bound of variant <code>ty</code> above, where ty is
 itself of the form <code>ident</code> (i.e. the <code>&lt;X:T&gt;</code> case) is implicitly
 expanded into <code>&lt;X:X=T&gt;</code>.</p></li>
</ol>

<hr>

<h2><a id="futurework">What the proposal does not cover</a></h2>

<p>There are cases of interest that are not covered by the above proposal.</p>

<p>Most obvious to me are situations where one wants to describe mutual
constraints <em>between</em> the items associated with type parameters.
(An example of this is provided by the <code>gen_orbit</code> example with
the constraint <code>DistanceType(I) = N</code>, and more generally much of the
content of the <code>requires(..)</code> clauses from EOP that I deliberately
ignored).  For the examples from EOP, C++ handles this by doing the
template instantiation blindly and applying the type checker to
code after concrete types have been substituted for the parameters;
this approach is not compatible with Rust&#39;s design where we want to
type-check a generic body of code in terms of the guarantees provided
by the trait-bounds, <em>not</em> delaying those checks until after
the concrete types have been plugged in.</p>

<p>Also, in the changes I proposed above to the Rust grammar (and
somewhat implicitly to its semantics), I deliberately constrained my
focus to the cases Niko described in his blog posts: types, functions,
and constants.  But one might consider further extensions, such as
allowing traits to define <em>other</em> traits.  (I found that subject hard
to wrap one&#39;s mind around, and I wanted to keep the focus limited for
Rust 1.0; we can leave generalizations of this approach for after Rust
1.0.)</p>

<p>Also, I&#39;m not sure whether there is need and/or utility in further
generalizing this topic to <a href="http://www.haskell.org/haskellwiki/GHC/Type_families#An_associated_data_type_example">associated data families</a>.  Again,
I want to limit the scope of the work to something we believe we can
accomplish for Rust 1.0.</p>

<p>What else have I missed?  Let me know, leave a comment.  (Or look
for me in the #rust irc channel.)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/12/better-command-completion-in-bash-aka-resolving-zsh-envy/">Better Command Completion in Bash on OS X</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-12T07:57:00+02:00" pubdate data-updated="true">12 April 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>(This post started as a personal e-mail to Niko, and then I figured it
was blog worthy.)</p>

<p>There&#39;s plenty of problems when working atop &quot;OS X&quot;;
but no need to be jealous of Shu&#39;s zsh setup
(at least not for its tab-completion on git stuff),
at least not if you are already using Homebrew.
Just install
<a href="http://blog.jeffterrace.com/2012/09/bash-completion-for-mac-os-x.html">brew&#39;s bash completion package</a>!</p>

<p>Executive summary: </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% brew install bash-completion
</span><span class='line'>
</span><span class='line'>% <span class="nb">echo</span> &gt;&gt; ~/.bash_profile <span class="s">&lt;&lt;END</span>
</span><span class='line'><span class="s">  if [ -f $(brew --prefix)/etc/bash_completion ]; then</span>
</span><span class='line'><span class="s">    . $(brew --prefix)/etc/bash_completion</span>
</span><span class='line'><span class="s">  fi</span>
</span><span class='line'><span class="s">END</span>
</span></code></pre></td></tr></table></div></figure>

<p>And voil!</p>

<p>See also potentially related topics from <a href="http://superuser.com/questions/288438/bash-completion-for-commands-in-mac-os">super user</a>, <a href="http://stackoverflow.com/questions/14970728/homebrews-git-not-using-completion">stack overflow</a>, <a href="http://milkbox.net/note/brace-completion-in-snow-leopard-upgrading-bash/">milkbox blog</a>.</p>

<hr>

<p>Note also that I did burn myself by trying to get too smart: In
particular, after reading <a href="http://stackoverflow.com/questions/14970728/homebrews-git-not-using-completion">stack overflow</a>, I over-eagerly
attempted to address a purported problem by installing the homebrew
newer git instead of the default (older) built-in git installed by
Apple.</p>

<p>This was a little more painful than I expected, because there were a
bunch of git-related commands already in my <code>/usr/local/bin</code>, probably
I had likely already copied git to there once before by hand, and so
brew kept aborting the installation because it did not want to
overwrite the binaries that it was not already managing.  I think brew
was aborting the install in a sound transactional manner, but I am not
100% sure of that, because at least one point the command completion
stopped working and at that point I just</p>

<ol>
<li>gave up on understanding where everything came from,</li>
<li>moved the non-brew git-related material
in <code>/usr/local/bin/</code> out of the way, and</li>
<li>redid the <code>brew install git</code></li>
</ol>

<hr>

<p>Anyway, I should also give a shout-out to Axel Hecht; his post
on Mozilla&#39;s Yammer instance is what got me to the point of even
attempting to install this piece of marvelousness.</p>

<p>(Also, further posts on yammer are lightly pushing for readers to consider
zsh as an alternative to bash.  I do not think I am ready to switch to zsh,
but I can at least link to the <a href="http://friedcpu.wordpress.com/2007/07/24/zsh-the-last-shell-youll-ever-need/">blog post arguing for zsh</a>.)</p>

<hr>

<p>Update (written 2013 april 16): Now that I have decent command/context
sensitive completion in bash in my terminal, of <em>course</em> I
want to have it in my Emacs <code>M-x shell</code> as well.  At first I
was dismayed that I did not just get that &quot;out of the box&quot;;
then I was happy after some googling to discover:
<a href="https://github.com/szermatt/emacs-bash-completion">bash-completion.el</a>, which forwards the completion
requests onto a separate bash process, so that one inherits
the same completions that bash provides in the terminal,
with no Emacs hacking.</p>

<p>Well, at least, not very much Emacs hacking.</p>

<p>It turns out that I had to do a little bit of Emacs hacking
in order to get the setup working, at least for my idiosyncratic
bash setup.  In particular, it seems like the Elisp code
for bash-complete.el assumes that one is setting one&#39;s
prompt via the <code>PS1</code> environment variable, while mine is often
set via the <code>PROMPT_COMMAND</code> environment variable.
After determining what is going on, it is easy enough to fix this (and
the corresponding solution has even been filed as a <a href="https://github.com/szermatt/emacs-bash-completion/pull/2">pull request in
the github repo</a>).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/26/rusty-chain-puzzle-1/">Rusty Chain Puzzle 1.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-26T10:28:00+01:00" pubdate data-updated="true">26 March 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have been trying to get my feet wet programming in
<a href="http://www.rust-lang.org/">Rust</a>.</p>

<p>A month and a half ago, I thought &quot;Maybe I will hack up an Earley
parser in a variety of languages, including Rust.&quot;  That sent me down
a long path of learning about how Earley parsing works; I have not yet
written up my results from that investigation, and I still have not
written the Rust version of the code.</p>

<p>Last weekend, I sat down and said, &quot;Let&#39;s try a simpler goal: A couple
simple exercies, maybe taken from Knuth&#39;s
<a href="http://www-cs-faculty.stanford.edu/%7Euno/taocp.html">TAOCP</a>&quot;
This was indeed a much simpler goal, but it was more difficult than
I had expected.</p>

<p>So, here is a Rust hacking puzzle that I struggled with.</p>

<p>I am representing piles of playing cards via linked structures.
Here are the data structure declarations:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">enum</span> <span class="n">card_suit</span> <span class="p">{</span> <span class="n">clubs</span><span class="p">,</span> <span class="n">diamonds</span><span class="p">,</span> <span class="n">hearts</span><span class="p">,</span> <span class="n">spades</span> <span class="p">}</span>
</span><span class='line'><span class="n">struct</span> <span class="n">card</span> <span class="p">{</span> <span class="n">suit</span><span class="o">:</span> <span class="n">card_suit</span><span class="p">,</span>
</span><span class='line'>              <span class="n">rank</span><span class="o">:</span> <span class="k">u8</span><span class="p">,</span> <span class="c1">// 1..13</span>
</span><span class='line'>              <span class="n">next</span><span class="o">:</span> <span class="n">Option</span><span class="o">&lt;~</span><span class="n">card</span><span class="o">&gt;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Note that the <code>next</code> field is an (optional) <em>owned</em> pointer to the
next card in the pile.  <code>Option&lt;~card&gt;</code> will be generally used to
represent a potentially empty pile (or &quot;stack&quot;, &quot;deck&quot; or &quot;hand&quot;, as
the context dictates), while <code>~card</code> is a non-empty pile (or, when its
<code>next</code> is <code>None</code>, a single card, again as context dictates)</p>

<h2>The goal</h2>

<p>I want to write four functions: <code>place_top</code>, <code>place_bot</code>, <code>pop_top</code>,
and <code>pop_bot</code>, which respectively:</p>

<ul>
<li><p><code>place_top(stack, c)</code> pushes a card <code>c</code> onto the top of the stack,
represented by return the new top of the stack.</p></li>
<li><p><code>place_bot(stack, c)</code> places a card beneath the stack.  For an empty
stack, the placed card is returned as the top of the newly formed
stack; otherwise, the old stack top is returned (since the stack is
imperatively modified).</p></li>
<li><p><code>pop_top(stack)</code> pops the top of the stack, returning a tuple of the
popped card and the remaining, potentially empty stack.</p></li>
<li><p><code>pop_bot(stack)</code> removes the bottom of the stack (i.e. &quot;deals from
the bottom of the deck&quot;), returning a tuple of the removed card and
the new, potentially empty stack.</p></li>
</ul>

<p>In code, here are the signatures for the desired functions,
as well as one-line reminders of the behavior for each.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="c1">// [c1, ..., cN], cX -&gt; [cX, c1, ..., cN]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">place_top</span><span class="p">(</span><span class="n">pile</span><span class="o">:</span> <span class="n">Option</span><span class="o">&lt;~</span><span class="n">card</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">newcard</span><span class="o">:</span> <span class="o">~</span><span class="n">card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">~</span><span class="n">card</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// [c1, ..., cN], cX -&gt; [c1, ..., cN, cX]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">place_bot</span><span class="p">(</span><span class="n">pile</span><span class="o">:</span> <span class="n">Option</span><span class="o">&lt;~</span><span class="n">card</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">newcard</span><span class="o">:</span> <span class="o">~</span><span class="n">card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">~</span><span class="n">card</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// [c1, c2, ..., cN] -&gt; (c1, [c2, ..., cN])</span>
</span><span class='line'><span class="k">fn</span> <span class="n">pop_top</span><span class="p">(</span><span class="n">pile</span><span class="o">:</span> <span class="o">~</span><span class="n">card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">~</span><span class="n">card</span><span class="p">,</span> <span class="n">Option</span><span class="o">&lt;~</span><span class="n">card</span><span class="o">&gt;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// [c1, ..., cN-1, cN] -&gt; (Some(cN), [c1, ..., cN-1])</span>
</span><span class='line'><span class="k">fn</span> <span class="n">pop_bot</span><span class="p">(</span><span class="n">pile</span><span class="o">:</span> <span class="o">~</span><span class="n">card</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">~</span><span class="n">card</span><span class="p">,</span> <span class="n">Option</span><span class="o">&lt;~</span><span class="n">card</span><span class="o">&gt;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

<h2>(Some non-critical helper infrastructure follows, showing off Rust as language)</h2>

<p>Here is some example code that puts together a hand and does
a few manipulations using the above operations (as well as
some printing routines to make looking at these cards nicer
in the terminal output)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">make_hand</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="o">~</span><span class="n">card</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">hand</span> <span class="o">=</span> <span class="o">~</span><span class="n">card</span> <span class="p">{</span> <span class="n">suit</span><span class="o">:</span> <span class="n">clubs</span><span class="p">,</span> <span class="n">rank</span><span class="o">:</span> <span class="m">10</span><span class="p">,</span> <span class="n">next</span><span class="o">:</span> <span class="n">None</span> <span class="p">};</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">hand</span> <span class="o">=</span> <span class="o">~</span><span class="n">card</span> <span class="p">{</span> <span class="n">suit</span><span class="o">:</span> <span class="n">spades</span><span class="p">,</span> <span class="n">rank</span><span class="o">:</span> <span class="m">3</span><span class="p">,</span> <span class="n">next</span><span class="o">:</span> <span class="n">Some</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span> <span class="p">};</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">hand</span> <span class="o">=</span> <span class="o">~</span><span class="n">card</span> <span class="p">{</span> <span class="n">suit</span><span class="o">:</span> <span class="n">diamonds</span><span class="p">,</span> <span class="n">rank</span><span class="o">:</span> <span class="m">2</span><span class="p">,</span> <span class="n">next</span><span class="o">:</span> <span class="n">Some</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">hand</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">hand</span> <span class="o">:</span> <span class="o">~</span><span class="n">card</span> <span class="o">=</span> <span class="n">make_hand</span><span class="p">();</span>
</span><span class='line'>    <span class="n">hand</span><span class="p">.</span><span class="n">report</span><span class="p">(</span><span class="o">~</span><span class="s">&quot;initial hand: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">AceD</span> <span class="o">=</span> <span class="o">~</span><span class="n">card</span><span class="p">{</span> <span class="n">suit</span><span class="o">:</span> <span class="n">diamonds</span><span class="p">,</span> <span class="n">rank</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="n">next</span><span class="o">:</span> <span class="n">None</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">AceD</span><span class="p">.</span><span class="n">report</span><span class="p">(</span><span class="o">~</span><span class="s">&quot;place top: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">hand</span> <span class="o">=</span> <span class="n">place_top</span><span class="p">(</span><span class="n">Some</span><span class="p">(</span><span class="n">hand</span><span class="p">),</span> <span class="n">AceD</span><span class="p">);</span>
</span><span class='line'>    <span class="n">hand</span><span class="p">.</span><span class="n">report</span><span class="p">(</span><span class="o">~</span><span class="s">&quot;new hand: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">SixD</span> <span class="o">=</span> <span class="o">~</span><span class="n">card</span><span class="p">{</span> <span class="n">suit</span><span class="o">:</span> <span class="n">diamonds</span><span class="p">,</span> <span class="n">rank</span><span class="o">:</span> <span class="m">6</span><span class="p">,</span> <span class="n">next</span><span class="o">:</span> <span class="n">None</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">SixD</span><span class="p">.</span><span class="n">report</span><span class="p">(</span><span class="o">~</span><span class="s">&quot;place bot: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">hand</span> <span class="o">=</span> <span class="n">place_bot</span><span class="p">(</span><span class="n">Some</span><span class="p">(</span><span class="n">hand</span><span class="p">),</span> <span class="n">SixD</span><span class="p">);</span>
</span><span class='line'>    <span class="n">hand</span><span class="p">.</span><span class="n">report</span><span class="p">(</span><span class="o">~</span><span class="s">&quot;new hand: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">let</span> <span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">rest</span><span class="p">)</span> <span class="o">=</span> <span class="n">pop_top</span><span class="p">(</span><span class="n">hand</span><span class="p">);</span>
</span><span class='line'>    <span class="n">top</span><span class="p">.</span><span class="n">report</span><span class="p">(</span><span class="o">~</span><span class="s">&quot;popped top: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">hand</span> <span class="o">=</span> <span class="n">rest</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>    <span class="n">hand</span><span class="p">.</span><span class="n">report</span><span class="p">(</span><span class="o">~</span><span class="s">&quot;new hand: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">let</span> <span class="p">(</span><span class="n">bot</span><span class="p">,</span> <span class="n">rest</span><span class="p">)</span> <span class="o">=</span> <span class="n">pop_bot</span><span class="p">(</span><span class="n">hand</span><span class="p">);</span>
</span><span class='line'>    <span class="n">bot</span><span class="p">.</span><span class="n">report</span><span class="p">(</span><span class="o">~</span><span class="s">&quot;popped bot: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">hand</span> <span class="o">=</span> <span class="n">rest</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>    <span class="n">hand</span><span class="p">.</span><span class="n">report</span><span class="p">(</span><span class="o">~</span><span class="s">&quot;new hand: &quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Below are &quot;just&quot; some notation niceties that should not effect</span>
</span><span class='line'><span class="c1">// the semantics of the code + algorithms above.</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">ToStr</span> <span class="k">for</span> <span class="n">card_suit</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">to_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">~</span><span class="n">str</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">match</span> <span class="n">self</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">spades</span>   <span class="o">=&gt;</span> <span class="o">~</span><span class="s">&quot;</span><span class="se">\u2664</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hearts</span>   <span class="o">=&gt;</span> <span class="o">~</span><span class="s">&quot;</span><span class="se">\u2665</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                     <span class="o">&amp;</span><span class="n">diamonds</span> <span class="o">=&gt;</span> <span class="o">~</span><span class="s">&quot;</span><span class="se">\u2666</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clubs</span>    <span class="o">=&gt;</span> <span class="o">~</span><span class="s">&quot;</span><span class="se">\u2667</span><span class="s">&quot;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">rank_to_str</span><span class="p">(</span><span class="n">r</span><span class="o">:</span><span class="k">u8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">~</span><span class="n">str</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">match</span> <span class="n">r</span> <span class="p">{</span>
</span><span class='line'>        <span class="m">1</span>     <span class="o">=&gt;</span> <span class="o">~</span><span class="s">&quot;A&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="m">2.</span><span class="p">.</span><span class="m">10</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">to_str</span><span class="p">(),</span>
</span><span class='line'>        <span class="m">11</span>    <span class="o">=&gt;</span> <span class="o">~</span><span class="s">&quot;J&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="m">12</span>    <span class="o">=&gt;</span> <span class="o">~</span><span class="s">&quot;Q&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="m">13</span>    <span class="o">=&gt;</span> <span class="o">~</span><span class="s">&quot;K&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">_</span>     <span class="o">=&gt;</span> <span class="k">fail</span><span class="o">!</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">card</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">rank_to_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">~</span><span class="n">str</span> <span class="p">{</span> <span class="n">rank_to_str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rank</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">report</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">:</span> <span class="o">~</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span> <span class="n">io</span><span class="o">::</span><span class="n">println</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">to_str</span><span class="p">());</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">ToStr</span> <span class="k">for</span> <span class="n">card</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">to_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">~</span><span class="n">str</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">mut</span> <span class="k">ret</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">rank_to_str</span><span class="p">()</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">suit</span><span class="p">.</span><span class="n">to_str</span><span class="p">();</span>
</span><span class='line'>        <span class="n">match</span> <span class="o">&amp;</span><span class="n">self</span><span class="p">.</span><span class="n">next</span> <span class="p">{</span>
</span><span class='line'>            <span class="o">&amp;</span><span class="n">None</span> <span class="o">=&gt;</span> <span class="p">(),</span>
</span><span class='line'>            <span class="o">&amp;</span><span class="n">Some</span><span class="p">(</span><span class="n">ref</span> <span class="n">n</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">ret</span> <span class="o">=</span> <span class="k">ret</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">n</span><span class="p">.</span><span class="n">to_str</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">ret</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>In my terminal, I get the following output from the above <code>main</code>
function:</p>

<p>initial hand: 2&diams;,3&spades;,10&clubs;<br>
place top: A&diams;<br>
new hand: A&diams;,2&diams;,3&spades;,10&clubs;<br>
place bot: 6&diams;<br>
new hand: A&diams;,2&diams;,3&spades;,10&clubs;,6&diams;<br>
popped top: A&diams;<br>
new hand: 2&diams;,3&spades;,10&clubs;,6&diams;<br>
popped bot: 6&diams;<br>
new hand: 2&diams;,3&spades;,10&clubs;</p>

<p>(I will post my initial &quot;solution&quot; to the puzzle in a follow-up post;
 I wanted to share this first because I know my current solution
 is non-optimal and wanted to see what others had to offer for how
 to solve this first.)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/29/implicit-versus-explicit-finalization/">Implicit Versus Explicit Finalization</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-29T22:47:00+01:00" pubdate data-updated="true">29 January 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>(This post is largely a response to Niko Matsakis&#39;s blog post
<a href="http://smallcultfollowing.com/babysteps/blog/2013/01/17/destructors-and-finalizers-in-rust/">Destructors and Finalizers in Rust</a>.  I started composing it as a comment there,
but eventually realized I needed more breathing room.)</p>

<p>I agree wholeheartedly with Niko&#39;s statement that the Boehm paper
<a href="http://www.hpl.hp.com/techreports/2002/HPL-2002-335.html">&quot;Destructors, Finalizers, and Synchronization&quot;</a> is a really nice
discussion of this topic.
However, a significant portion of the destructor/finalizer design space is
only briefly discussed in that paper, and I worry that Niko&#39;s post overlooks
it.</p>

<p>There are designs that do not run finalizers directly from the garbage
collection process (whether that collector be a coroutine with the mutator, or
a concurrently running thread), and instead run finalization code
at explicit points in the code of the mutator (or mutator threads).</p>

<p>To me, such an approach seems appropriate for systems-level programming;
it seems to align with the spirit of giving the programmer access to the set of
knobs they need for explicit sequencing and resource management (or rope
to hang themselves with).</p>

<h2>Explicit Cleanup</h2>

<p>In the <a href="http://www.cs.indiana.edu/%7Edyb/pubs/guardians-pldi93.pdf">guardian</a> and <a href="http://www.oracle.com/technetwork/articles/javase/finalization-137655.html">reference-queue</a> family of systems (see
also <a href="http://docs.racket-lang.org/reference/willexecutor.html">wills and executors</a>), resource cleanup code is no longer asynchronously
run by the GC.  Instead, cleanup is the obligation of the
mutator.  The only asynchronous cleanup action of the garbage collector
is to add entries to the appropriate guardians/reference queues (that is, the
queues associated with an object that has been appropriately registered and
subsequently discovered to be unreachable).</p>

<p>I have included a more explicit description of what a Guardian API is like in
the appendix at the end of this blog post, in case the previous paragraph was
too terse.</p>

<p>With such an API in hand, developers can build <a href="http://repository.readscheme.org/ftp/papers/sw2010/02-hsu.pdf">libraries</a> that one can
plausibly reason about, in a single- or multi-threaded context.</p>

<p>To be fair: Boehm <em>does</em> address these approaches briefly; see the beginning
of section 3.5.1 of his paper, &quot;Explicit Finalizer Invocation&quot;.  However,
he also mixes them in with Java&#39;s <code>System.runFinalization()</code> and the motivation
for that method.  Thus one must take care to distinguish which of Boehm&#39;s complaints
apply to all explicit finalization systems, and which apply solely to systems 
such as Java with <code>runFinalization</code> that provide a mix of explicit and implicit finalization.</p>

<h2>Passing the Buck</h2>

<p>One important characteristic (some might say &quot;drawback&quot;) of explicit
finalization approaches is that the mutator does need to periodically process
its associated guardians/reference queues.  After all, with the transfer of
responsibility for cleanup from the collector to the mutator, the mutator must
meet this obligation eventually.</p>

<p>One standard way to do this is to sprinkle cleanup code (i.e. &quot;check if
guardian has entries; if so, process some of them&quot;) at points in the control
flow of library routines using that guardian.  (In other words, in languages
with guardians, library designers can hopefully isolate the cleanup code behind the interface of the library that
requires such cleanup.)</p>

<p>In fact, since there are distinct guardians/reference-queues, one can
prioritize the scheduling (i.e. frequency and incremental-cost) of the
cleanups according to the characteristics of individual libraries, within the
mutator.  Contrast this against relying on the scheduling of the garbage collector with its
single finalization queue for the whole heap.</p>

<p>The two main problems with explicit cleanup from my point of view are:</p>

<ol>
<li><p>ensuring that the necessary processing does <em>eventually</em> happen
(i.e. prevent resource leaks when control does not often (or ever) flow back into the
developer&#39;s library utilizing the guardian), and</p></li>
<li><p>inserting finalizer invocations across the code of a library detracts
from its readability; they are a clear example of a cross-cutting concern that
should be factored into its own &quot;aspect.&quot;</p></li>
</ol>

<p>Boehm essentially covers both of the points above (though on first reading I
only interpreted him as describing the second point):</p>

<blockquote>
<p>This appears to be the safest way to handle finalization in single-threaded
code, although it has some clear disadvantages in certain contexts:
Potentially large amounts of code, especially long running routines, must be
explicitly sprinkled with finalizer invocations.</p>
</blockquote>

<p>In the very worst case, in a &quot;normal&quot; imperative language with concurrent
threads, these last two drawbacks could be addressed by the client-developer:
the client-developer can set their associated cleanup code to run on a
distinct thread (that the <em>mutator</em> manages, not the garbage collector).  This
avoids the ugly sprinkling/cross-cutting of concerns, and should ensure that
cleanup does eventually occur (assuming correctly-written multi-threaded code,
&quot;ha ha&quot;).</p>

<p>Of course, that last suggestion is essentially reimplementing the GC&#39;s
finalizer thread as a mutator process.  But nonetheless, in principle this
could be implemented as a library, as long as the appropriate primitives are
available underneath.</p>

<p>By making explicit finalization expressible as a library,
the developer community would be free to propose competing API&#39;s
and implementations.  That seems like a good thing for a young
experimental language.</p>

<p>(One <em>might</em> even be able to develop finalization
libraries that are &quot;composable&quot;, in the sense that different finalization
libraries could be used by distinct libraries in the same overall program.
One could coin the term
<a href="http://en.wikipedia.org/wiki/Decomposing_Composers">&quot;composing decomposers&quot;</a>
for such things.)</p>

<h2>Wait, what was that about &quot;normal&quot; languages?</h2>

<p>I wrote the end of the previous section intending for it to apply to Rust.
Then I realized that I do not have enough experience writing Rust programs to
be certain it is reasonable to develop a mutator-based cleanup process
that runs on its own thread.</p>

<p>I am only discussing cleanup for structures held in managed-boxes (not in
owned-boxes or stack-allocated).  It might be feasible to express cleanup
routines for managed boxes with relatively trivial types in Rust, at least for
some libraries.</p>

<p>But it might be that in practice, managed boxes would generally have
types that would make it impossible for a separate thread to extract them from
a guardian and be able to access their contents.</p>

<p>There is also the serious problem that such a cleanup thread seems likely to require
the use of mutex locks in order to coordinate with the &quot;real&quot; mutator; this in
particular seems antithetical to the ideals of Rust.</p>

<p>(Hopefully I will soon acquire sufficient experience with Rust itself to be
able to address this issue more coherently.)</p>

<!---

----

Another idiosyncrasy with a lot of the guardian-like systems is that they
enqueue the original object for processing, which is quite counter-intuitive
when one considers the effort that the GC went through to determine that the
object was otherwise unreachable.

This perhaps could be addressed by using something like the model described at
the start of section 3.1 of Boehm's paper, "Alternatives"; namely, instead of
enqueuing the unreachable object on a reference queue, the GC could instead
enqueue an associated distinct cleanup object. Boehm states that such a
cleanup object falls victim to all the same problems, but as I understand it,
that is only true if it is invoked by the GC in the same way that Java-style
finalizers are invoked, as described in his paper.

It would be interesting to know whether any managed runtimes offer only
guardians/reference-queues with this style of distinct associated cleanup
objects; I am not aware of any myself.  I might attempt to hack one up in the
future.

--->

<h2>Conclusion</h2>

<p>I am not saying this is easy, and I am not saying that the systems I am
referencing get everything right either.  But implicit finalizers, even those invoked
from a system-managed asynchronous thread, are not the only answer.</p>

<p>Perhaps my pithy summary is that: Implicit finalizers are indeed inherently
asynchronous routines; but with explicit finalization, one has more options
(yet still may be able to fall back on asynchrony if necessary).</p>

<p>So, what does all of this mean for Rust?  Well, Niko already suggested
limiting destructors solely to types that contain only &quot;owned data.&quot;</p>

<p>I have no problem with that, since it clearly deals with all of the issues
that Boehm described.</p>

<p>But my suspicion is that Rust developers will soon discover that one really
does need the GC to feed information forward about the managed boxes that it
is collecting.  And so we will then be at a crossroads: Put in Java-style
finalizers, or adopt another approach?</p>

<p>My goal is to make sure we remember to consider those other approaches when we
hit that crossroads.</p>

<h2>References</h2>

<ol>
<li><a href="http://smallcultfollowing.com/babysteps/blog/2013/01/17/destructors-and-finalizers-in-rust/">&quot;Destructors and Finalizers in Rust&quot;</a>
<br/>Niko Matsakis
<br/>Blog post, 2013</li>
<li><a href="http://www.hpl.hp.com/techreports/2002/HPL-2002-335.html">&quot;Destructors, Finalizers, and Synchronization&quot;</a>
<br/>Hans Boehm
<br/>HP Tech Report; POPL 2003</li>
<li><a href="http://www.cs.indiana.edu/%7Edyb/pubs/guardians-pldi93.pdf">&quot;Guardians in a Generation-Based Garbage Collector&quot;</a>
<br/>Dybvig, Bruggeman, and Eby
<br/>PLDI, 1993</li>
<li><a href="http://www.oracle.com/technetwork/articles/javase/finalization-137655.html">&quot;How to Handle Java Finalization&#39;s Memory-Retention Issues&quot;</a>
<br/>Tony Printezis
<br/>Tech Report, 2007</li>
<li><a href="http://docs.racket-lang.org/reference/willexecutor.html">&quot;Wills and Executors&quot;</a>
<br/>PLT Racket Reference Documentation</li>
<li><a href="http://repository.readscheme.org/ftp/papers/sw2010/02-hsu.pdf">&quot;Implementing User-level Value-weak Hashtables&quot;</a>
<br/>Aaron Hsu
<br/>Scheme Workshop 2010
<br/>(I only properly appreciated the value (and difficulties) of using guardians for such purposes after I read this paper)</li>
</ol>

<h2>Appendix A. What are Guardians?</h2>

<p>I here outline a concrete example of how this works in the case of Guardians
(adapted from <a href="http://repository.readscheme.org/ftp/papers/sw2010/02-hsu.pdf">Hsu</a>).  (To aid readability, I have replaced the use of
procedure-arity-based-dispatch, as written by Hsu to match the Chez Scheme
API, and I am rewriting his example with a new distinct named procedures .)</p>

<p>One can construct as many guardian instances (or simply &quot;guardians&quot;) as one wants.
Each guardian is associated with two things:</p>

<ol>
<li><code>reclaimable</code> : a set of objects previously determined to be reclaimable by the garbage collector, and</li>
<li><code>registry</code> : a set of objects scheduled to be eventually enqueued in the first set.</li>
</ol>

<p>Both of these sets are initially empty when the guardian is constructed.</p>
<div class="highlight"><pre><code class="text">&gt; (define g (make-guardian))
&gt; (define v &quot;VAL&quot;)
&gt; (define p (weak-cons v &#39;())
&gt; (guardian-register! g v)

&gt; (set! v #f)                    ;; Now `&quot;VAL&quot;` is unreachable via strong-refs ...
&gt; (guardian-fetch! g)            ;; ... but GC has not discovered that yet.
#f

&gt; (collect-garbage)              ;; `&quot;VAL&quot;` is still unreachable ...
&gt; p                              ;; ... though one can access via weak paths ...
(&quot;VAL&quot;)
&gt; (define x (guardian-fetch! g)) ;; ... and the guardian held it in `reclaimable`
&gt; x
&quot;VAL&quot;

                                 ;; At this point, &quot;VAL&quot; is again strongly reachable
                                 ;; (via `x`).  However, it is *not* in either of the
                                 ;; sets for the guardian `g`, and thus is not scheduled
                                 ;; to be enqueued in the `reclaimable` set.

&gt; (set! x #f)                    ;; Now &quot;VAL&quot; is no longer strongly reachable...
&gt; (collect-garbage)
&gt; p                              ;; ... and thus can be reclaimed.
(#!blank-weak-pointer)
</code></pre></div>
<p>So, what does this have to do with finalization?</p>

<p>With the guardian API in hand, one could take care of closing individual
file descriptors associated with heap-allocated file objects, by
a protocol such as:</p>

<ol>
<li><p>Create one guardian G for the file library, whose sole purpose is closing
file descriptors.</p></li>
<li><p>In the constructor for file objects, register each constructed file object
with G.</p></li>
<li><p>In a periodic process, dequeue objects from G and close their associated
file descriptors.</p></li>
</ol>

<h2>Appendix B. Another peeve about guardians</h2>

<p>One idiosyncrasy about a lot of the guardian-like systems is that they enqueue
the original object for processing, which is quite counter-intuitive to me
given the effort that the GC went through to determine that the object was
otherwise unreachable.</p>

<p>Perhaps this could be addressed by using something like the model described at
the start of section 3.1 of Boehm&#39;s paper, &quot;Alternatives&quot;; namely, instead of
enqueuing the unreachable object on a reference queue, the GC could instead
enqueue an associated distinct cleanup object, and reclaim the originally
registered object itself. (Boehm states that such a cleanup object falls
victim to all the same problems, but as I understand it, that is only true if
it is invoked by the GC in the same way that Java-style finalizers are
invoked, as described in his paper.)</p>

<p>The associated cleanup object would need to carry any state necessary for the
cleanup action (e.g., the file descriptor itself).  So that seems like a
potential for ugly redundancy and wastage (in either time or space, depending
on whether uses a level of indirection or simply redundantly stores all the
necessary state in the object and in its associated cleanup object.).</p>

<p>But nonetheless, a decoupled system like this may be easier to reason about,
especially when one has scenarios where an object is registered with multiple
guardians/reference-queues.</p>

<p>As far as I understand, the reference queue system in Java, as described by
<a href="http://www.oracle.com/technetwork/articles/javase/finalization-137655.html">Printezis</a>, is sufficient to express a structure like this.  Still, it
would be interesting to know whether any managed runtimes offer <em>only</em>
guardians/reference-queues with this style of distinct associated cleanup
objects; I am not aware of any that are so conservative.  I might attempt to
hack one up in the future.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/08/resurrected-hello-again-world/">Resurrected (Hello Again World)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-08T00:55:00+01:00" pubdate data-updated="true">08 January 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>It&#39;s Clobbering Time</h2>

<p>Remember that thing I said back <a href="/blog/2012/12/31/hello-world">at the end of 2012</a>?
That thing?
That thing about the important detail that:</p>

<blockquote>
<p>the <code>_deploy/</code> subdirectory is itself a clone of the targeted
github repository, with the <code>gh-pages</code> branch checked out.</p>
</blockquote>

<p>It turns out this is really important detail.</p>

<p>Here&#39;s why: For my first blogging act of the new year, I inadvertently destroyed
my own blog.</p>

<p>I attempted to write a post from a computer other than the one out of
which I had already worked all the octopress-compatibility kinks.
In the hustle of dealing with <code>rbenv</code> and various other ruby-oriented
dependencies, I forgot about the detail above.</p>

<p>And then when I ran <code>rake deploy</code>, I clobbered the live blog.</p>

<p>I may have been recovering from, or incapacitated by, New Years
revelry at the time, it is not clear to me at the current moment.  I
believe I identified the disaster right after it happened, but immediately
decided I did not have the time then to diagnose it, fix it,
or even to attempt to rollback the
state and repush to github.  I vaguely remember considering that last option
and deciding that even that was out of the question.  (I think a pending
trip to a Karaoke bar may have been involved in the decision-making
process here.)</p>

<p>So, tonight I diagnosed and fixed the problem.</p>

<p>At first I was just going to let the matter lie undocumented, and
pretend like it never happened.</p>

<p>But I realized that I may well again make the same mistake in the future,
and that it behooved me to at least document the issue in my commit
log for <a href="https://github.com/pnkfelix/pnkfx-blog/commits/blog.pnkfx.org">the blog source</a>.</p>

<p>And after writing that commit log entry and pushing it, I decided that
this story was in fact blog worthy; after all, what is the point of
a blog if not to freely broadcast your mistakes?  :)</p>

<p>So, directly from <a href="https://github.com/pnkfelix/pnkfx-blog/commit/f277b041de33a8e0eac02c6aecb3909231725db7">my commit message</a>, here is the description of how
I clobbered my own blog:</p>

<blockquote>
<p>The easy way to sum it up is: The model
employed by octopress when deploying to github is this: Your _deploy/
subdirectory must contain a checkout of the target repo, the one with
the gh-pages branch, and you must have that _deploy/ subdirectory
checked out and ready to go before running &#39;rake deploy&#39;.</p>

<p>If you do not have a _deploy/ subdirectory at all and you let &#39;rake
deploy&#39; create it for you but you also let &#39;rake deploy&#39; attempt to
push to github, and you are also managing the source itself on github,
you will enter a world of pain where the rake invocation will push
<em>this</em> root directory, presumably in the master branch (or in my case,
blog.pnkfx.org branch) to the target repo in the gh-pages/ branch.
Which will bust things terribly, especially if that causes the CNAME
file to get deleted from the gh-pages/ branch of the target repo.</p>
</blockquote>

<h2>A note on self-reference</h2>

<p>Also, a quick half shout-out, or maybe corrective note, to
<a href="http://www.seamusbradley.net/blog/blog/2012/04/24/how-to-link-to-your-own-blog-posts-in-octopress/">seamusbradley</a> for pointing out some details about linking back to
one&#39;s own blog posts.</p>

<p>It is only a half shout-out because Seamus&#39;s note is only useful, I
think, if you have, like him, a customized setting for the <code>root:</code> in
your <code>_config.yml</code>.  That, or Seamus has confused himself and changed
his <code>root</code> setting in order to accommodate other url&#39;s that he
observed, but those urls are in fact actually generated by settings
for properties other than <code>root</code>.</p>

<p>Here&#39;s the concrete details: I read (misread?) Seamus&#39;s post at first
as saying that a customized setting of <code>root</code> to <code>/blog</code> is a
prerequisite for linking to your own posts.  It seems to me that the
relevant detail is what the <em>permalink</em> setting is, not the root.
(But then again, I have not played with changing my root setting,
apart from finding that when I did try changing it to <code>/blog</code> as
Seamus suggested, it seems like doing so broke <code>rake preview</code>.)</p>

<p>In my case, the <code>root</code> and <code>permalink</code> for my <code>_config.yml</code>
are set as follows:</p>
<div class="highlight"><pre><code class="text">root: /
permalink: /blog/:year/:month/:day/:title/
</code></pre></div>
<p>and I format links to my own posts, such as the one you are reading,
like so:
<a href="/blog/2013/01/08/resurrected-hello-again-world"><code>/blog/2013/01/08/resurrected-hello-again-world</code></a>
as you can see from looking at the source for the line above,</p>
<div class="highlight"><pre><code class="text">[`/blog/2013/01/08/resurrected-hello-again-world`](/blog/2013/01/08/resurrected-hello-again-world)
</code></pre></div>
<p>A bit of quoted self-reference is a good place to stop for the night.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/02/osx-tiled-window-management/">OS X Tiled Window Management With Slate</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-02T22:34:00+01:00" pubdate data-updated="true">02 January 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I recently discovered <a href="https://github.com/jigish/slate" title="Slate: github repository">Slate</a>, an
open-source window-management tool for Mac OS X.</p>

<p>It is very cool, mainly in that it is very configurable (but with a
reasonably readable syntax for its configuration file).</p>

<p>Perhaps the most important thing to say is: Do not judge it solely
based upon its default configuration file, which is very bare bones
and does not illustrate anything near the full feature set that it
offers.</p>

<p>Instead, I recommend one at least read over Tristan Hume&#39;e <a href="http://thume.ca/howto/2012/11/19/using-slate/" title="Tristan Hume: Using Slate">blog post</a>,
which advertises Slate much more effectively than the project&#39;s
github page.  The blog post describes some of the crucial features that are not
exposed in the default configuration.  In particular, the
window-switcher shortcut, which overlays each window with a
letter to give that window focus, is much more tile-friendly
if you also turn on </p>
<div class="highlight"><pre><code class="text">config windowHintsIgnoreHiddenWindows false
config windowHintsShowIcons true
</code></pre></div>
<p>You can see this and other custimzations I have made for myself
in my own <code>.slate</code> file, which I keep with my other dotfiles in
<a href="https://github.com/pnkfelix/DotFiles/blob/master/slate" title="Felix&#39;s DotFiles github repo">my public repository</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/31/hello-world/">Hello World</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-31T14:34:00+01:00" pubdate data-updated="true">31 December 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><!---
Apparently Markdown syntax does not have any shorthand for comments
-->

<!---
First 7 lines of this file were generated by command invocation:
  % rake new_post["Hello World"]
-->

<p>First post!
I am attempting to move my blog to GitHub Pages.</p>

<p>After seeing the results of others, I figure I will start with Octopress
and see how that goes.</p>

<p>Just so I can remind myself of the Octopress basics in the immediate future:</p>

<ul>
<li><p>Much of the page generation is controlled by configuration file <code>_config.yml</code></p></li>
<li><p>The content is all stored in <code>source/_posts/</code></p></li>
<li><p>This particular entry corresponds to the file <code>2012-12-31-hello-world.markdown</code></p></li>
<li><p>The first 7 lines of that file were originally generated via the
<code>rake</code> command invocation:</p>

<p>% rake new_post[&quot;Hello World&quot;]</p></li>
<li><p>The command <code>rake generate</code> will convert the source into static html pages.</p></li>
<li><p>After generating the file (and during subsequent editting), one can preview
the state locally in a local Ruby webserver via:</p>

<p>% rake preview</p>

<p>and then <a href="http://localhost:4000/">browsing localhost port 4000</a>.
The <code>rake preview</code> invocation will continuously monitor your post
source files so that you can keep working on your post and then
reload in your web browser without rerunning <code>rake</code> itself.</p></li>
<li><p>The command <code>rake deploy</code> is supposed to deploy the content into its intended
live location.  I have been having difficulty using this command,
in part because I think it is written assuming you have your ssh-key
already set up and integrated with github (or something similar) so that
there would be no password prompts.</p>

<ul>
<li>But of course I have not done this yet.</li>
<li>One important detail about <code>rake deploy</code> with github pages is that
the <code>_deploy/</code> subdirectory is itself a clone of the targetted
github repository, with the <code>gh-pages</code> branch checked out.
This can be confusing if your main source tree (the parent
directory of <code>_deploy/</code>) is itself the same repository as the
targetted github repository.</li>
</ul></li>
<li><p>Update: <code>rake deploy</code> just worked fine for me, password prompts and all.
I think my earlier difficulty was an artifact of some previous bad
state, one of either:</p>

<ul>
<li>I had put in a malformatted url for the target repository</li>
<li>My target repository already had a <code>gh-pages</code> branch (from earlier
testing) that needed to be pulled-and-merged (or discarded in some
fashion, which was what my merge amounted to).</li>
</ul></li>
<li><p>Update (26 march 2012): there are still some hiccups with <code>rake deploy</code>;
you need to be careful about what you store in the <code>source/</code> directory.
In particular, I was working on a draft post and threw various
source files that I was hacking on in the same directory, along with
some <code>.gitignore</code> files so that <code>git</code> would ignore build products
generated when I compiled the source (to binaries or jars or fasls&#8230;).</p>

<p>The headache came when I did <code>rake deploy</code>, and hit this error:</p>
<div class="highlight"><pre><code class="bash">% rake deploy
cp -r <span class="nb">source</span>/_posts/.gitignore public/_posts/.gitignore
rake aborted!
No such file or directory - public/_posts/.gitignore
/Users/pnkfelix/Dev/Sites/pnkfx-blog/Rakefile:230:in <span class="sb">`</span>block <span class="o">(</span>2 levels<span class="o">)</span> in &lt;top <span class="o">(</span>required<span class="o">)</span>&gt;<span class="s1">&#39;</span>
<span class="s1">/Users/pnkfelix/Dev/Sites/pnkfx-blog/Rakefile:229:in `block in &lt;top (required)&gt;&#39;</span>
/Users/pnkfelix/Dev/Sites/pnkfx-blog/Rakefile:219:in <span class="sb">`</span>block in &lt;top <span class="o">(</span>required<span class="o">)</span>&gt;<span class="err">&#39;</span>
Tasks: <span class="nv">TOP</span> <span class="o">=</span>&gt; copydot
<span class="o">(</span>See full trace by running task with --trace<span class="o">)</span>
%
</code></pre></div>
<p>The problem here, as far as I can tell, is that octopress
is aggressively trying to copy over all dotfiles it can find
(<a href="https://github.com/imathis/octopress/issues/104">Octopress Issue 104</a>)
and that code was not written to create any subdirectories as
necessary.</p>

<p>My Ruby development knowledge is sufficiently under-developed that I
am not going to try to fix this myself.  Instead I have simply
moved all of the source code I was hacking <em>out</em> of the <code>source/</code>
directory and into a separate <code>hacks/</code> directory.
This seems to have addressed the problem; I have also filed
<a href="https://github.com/imathis/octopress/issues/1151">an issue</a>
for this with Octopress.</p></li>
</ul>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/22/designing-syntax-for-associated-items-in-rust/">Designing syntax for associated items in Rust</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/12/better-command-completion-in-bash-aka-resolving-zsh-envy/">Better command completion in bash on OS X</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/26/rusty-chain-puzzle-1/">Rusty Chain Puzzle 1.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/29/implicit-versus-explicit-finalization/">Implicit versus Explicit Finalization</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/08/resurrected-hello-again-world/">Resurrected (Hello Again World)</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pnkfelix">@pnkfelix</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pnkfelix',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("pnkfelix", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/pnkfelix" class="twitter-follow-button" data-show-count="false">Follow @pnkfelix</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/pnkfelix?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/pnkfelix">My Delicious Bookmarks &raquo;</a></p>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/pnkfelix?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Felix S. Klock II -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'pnkfx-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
